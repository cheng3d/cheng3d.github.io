var CGE=function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/build/",i(i.s=0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";i.r(t);var r={};i.r(r),i.d(r,"encodeFloat2RGB",(function(){return Ot})),i.d(r,"encodeFloat2RGBA",(function(){return Dt}));var s={};i.r(s),i.d(s,"decodeRGB2Float",(function(){return Ft})),i.d(s,"decodeRGBA2Float",(function(){return wt}));var n={};i.r(n),i.d(n,"ACESToneMapping",(function(){return bt}));var a={};i.r(a),i.d(a,"ShadowMapDefine",(function(){return Lt})),i.d(a,"standardShadowMap",(function(){return Pt})),i.d(a,"PointShadowCalc",(function(){return Ut}));var o={};i.r(o),i.d(o,"distributionGGX",(function(){return Bt})),i.d(o,"geometrySmith",(function(){return zt})),i.d(o,"fresnelSchlick",(function(){return Gt})),i.d(o,"fresnelSchlickRoughness",(function(){return Ht})),i.d(o,"fastDFG",(function(){return Vt}));var g={};i.r(g),i.d(g,"LightingDefine",(function(){return Wt}));const A=function(){let e=0;return function(){return e++}}(),I=function(){let e=0;return function(){return e++}}();function C(){}class h{constructor(e,t,i,r=!1){this.caller=e,this.method=t,this.args=i,this.once=r,this._id=h._gid++}setTo(e,t,i,r=!1){this.caller=e,this.method=t,this.args=i,this.once=!1}run(){if(!this.method)return null;const e=this.method.apply(this.caller,this.args);return this.once&&this.clear(),e}runWith(e){if(null==this.method)return null;let t;this._id;return t=null==e?this.method.apply(this.caller,this.args):this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e),t}clear(){return this.caller=null,this.method=null,this.args=null,this}}h._gid=1;class _{constructor(){}on(e,t,i,r){this._addEvent(e,t,i,r,!1)}once(e,t,i,r){this._addEvent(e,t,i,r,!0)}off(e,t,i){let r=this._events;if(!r)return;let s=r.get(e);if(s){let n=s.length;for(let e=0;e<n;){let r=s[e];r.caller===t&&r.method===i?(s.splice(e,1),n=s.length,r.clear(),r=null):e++}0===s.length&&r.delete(e)}}removeAll(){this._events&&(this._events.forEach((e,t)=>{if(e){let t=e.length;for(let i=0;i<t;i++){let t=e[i];t.clear(),t=null}e.splice(0,t)}}),this._events.clear(),this._events=null)}event(e,t){let i=this._events;if(!i)return null;let r=i.get(e);if(r){let e=r.length;for(let i=0;i<e;i++){r[i].runWith(t)}}}_addEvent(e,t,i,r,s=!1){let n=this._events;n||(n=new Map,this._events=n);let a=n.get(e);if(a){let e=a.length;for(let n=0;n<e;n++){let e=a[n];if(e.caller===t&&e.method===i)return e.args=r,void(e.once=s)}}else a=[],n.set(e,a);a.push(new h(t,i,r,s))}findEventType(e){let t=this._events;if(!t)return!1;let i=t.get(e);return i&&i.length>0}}class l extends _{constructor(){super(),this._uuid=u(),this._id=I(),this.name=""}get id(){return this._id}get uuid(){return this._uuid}update(e){}toJson(e){const t=e||{};return t.uuid=this._uuid,t.name=this.name,t.type=this.constructor.name,t}fromJson(e){this._uuid=e.uuid,this.name=e.name}}function u(){let e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:3&i|8).toString(16)}))}const c={info:function(...e){console.log(...e)},warn:function(...e){console.warn(...e)},error:function(...e){throw console.error(...e),e}};class d{constructor(e=0,t=0){this.v=new Float32Array([e,t])}set(e,t){return this.v[0]=e,this.v[1]=t,this}setAt(e){return this.v.set(e.v),this}add(e,t){return this.v[0]+=e,this.v[1]+=t,this}addAt(e){return this.v[0]+=e.x,this.v[1]+=e.y,this}sub(e,t){return this.v[0]-=e,this.v[1]-=t,this}subAt(e){return this.v[0]-=e.x,this.v[1]-=e.y,this}subBy(e,t){return this.v[0]=e.x-t.x,this.v[1]=e.y-t.y,this}negate(){return this.v[0]=-this.v[0],this.v[1]=-this.v[1],this}mul(e){return this.v[0]*=e,this.v[1]*=e,this}mulAt(e){return this.v[0]*=e.x,this.v[1]*=e.y,this}dot(e){return this.v[0]*e.x+this.v[1]*e.y}length(){return Math.sqrt(this.lengthSquare())}lengthSquare(){let e=this.v;return e[0]*e[0]+e[1]*e[1]}normalize(){let e=this.length();if(0==e)return this;let t=1/e;return this.v[0]*=t,this.v[1]*=t,this}clone(){let e=new d;return e.v.set(this.v),e}copy(e){return this.v.set(e.v),this}equal(e){return this.v[0]===e.x&&this.v[1]===e.y}lequal(e){return this.v[0]<=e.x&&this.v[1]<=e.y}gequal(e){return this.v[0]>=e.x&&this.v[1]>=e.y}set x(e){this.v[0]=e}get x(){return this.v[0]}set y(e){this.v[1]=e}get y(){return this.v[1]}get data(){return this.v}min(e){let t=this.v,i=e.v;return t[0]=Math.min(t[0],i[0]),t[1]=Math.min(t[1],i[1]),this}max(e){let t=this.v,i=e.v;return t[0]=Math.max(t[0],i[0]),t[1]=Math.max(t[1],i[1]),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}toJson(){return{x:this.x,y:this.y}}fromJson(e){this.x=e.x,this.y=e.y}}d.Zero=new d(0,0),d.ZUp=new d(0,0),d.One=new d(1,1),d.pubTemp=new d;class p{constructor(e,t=1){this._data=[],this._func=e;for(let i=0;i<t;i++)this._data.push(new e)}create(){return this._data.length>0?this._data.pop():new this._func}recovery(e){this._data.push(e)}}class m{constructor(e=0,t=0,i=0){this.v=new Float32Array([e,t,i])}static getPubTemp(){return m.pool.create()}static recoveryPubTemp(e){m.pool.recovery(e)}set(e,t,i){return this.v[0]=e,this.v[1]=t,this.v[2]=i,this}setAt(e){return this.v.set(e.v),this}add(e,t,i){return this.v[0]+=e,this.v[1]+=t,this.v[2]+=i,this}addAt(e){return this.v[0]+=e.x,this.v[1]+=e.y,this.v[2]+=e.z,this}sub(e,t,i){return this.v[0]-=e,this.v[1]-=t,this.v[2]-=i,this}subAt(e){return this.v[0]-=e.x,this.v[1]-=e.y,this.v[2]-=e.z,this}subBy(e,t){return this.v[0]=e.x-t.x,this.v[1]=e.y-t.y,this.v[2]=e.z-t.z,this}negate(){return this.v[0]=-this.v[0],this.v[1]=-this.v[1],this.v[2]=-this.v[2],this}mul(e){return this.v[0]*=e,this.v[1]*=e,this.v[2]*=e,this}mulAt(e){return this.v[0]*=e.x,this.v[1]*=e.y,this.v[2]*=e.z,this}dot(e){return this.v[0]*e.x+this.v[1]*e.y+this.v[2]*e.z}crossBy(e,t){let i=e.x,r=e.y,s=e.z,n=t.x,a=t.y,o=t.z;return this.x=r*o-s*a,this.y=s*n-i*o,this.z=i*a-r*n,this}cross(e){return m.pool.create().crossBy(this,e)}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}crossAt(e){return this.crossBy(this,e)}length(){return Math.sqrt(this.lengthSquare())}lengthSquare(){let e=this.v;return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}distanceToSquare(e){let t=e.x-this.x,i=e.y-this.y,r=e.z-this.z;return t*t+i*i+r*r}distanceTo(e){return Math.sqrt(this.distanceToSquare(e))}normalize(){let e=this.length();if(0==e)return this;let t=1/e;return this.v[0]*=t,this.v[1]*=t,this.v[2]*=t,this}project(e){return this.applyMatrix4(e.getViewMatrix()).applyMatrix4(e.getProjectionMatrix())}unproject(e){return this.applyMatrix4(e.getProjectionInverseMatrix()).applyMatrix4(e.getViewInverseMatrix())}setFromMatrixPosition(e){const t=e.m;return this.x=t[12],this.y=t[13],this.z=t[14],this}applyMatrix4(e){let t=this.v[0],i=this.v[1],r=this.v[2],s=e.m,n=s[0]*t+s[4]*i+s[8]*r+s[12],a=s[1]*t+s[5]*i+s[9]*r+s[13],o=s[2]*t+s[6]*i+s[10]*r+s[14],g=s[3]*t+s[7]*i+s[11]*r+s[15];return g=1===g?1:1/g,this.v[0]=n*g,this.v[1]=a*g,this.v[2]=o*g,this}applyQuaternion(e){let t=this.v[0],i=this.v[1],r=this.v[2],s=e.x,n=e.y,a=e.z,o=e.w,g=o*t+n*r-a*i,A=o*i+a*t-s*r,I=o*r+s*i-n*t,C=-s*t-n*i-a*r;return this.v[0]=g*o+C*-s+A*-a-I*-n,this.v[1]=A*o+C*-n+I*-s-g*-a,this.v[2]=I*o+C*-a+g*-n-A*-s,this}transformDirection(e){const t=this.v,i=t[0],r=t[1],s=t[2],n=e.m;return t[0]=n[0]*i+n[4]*r+n[8]*s,t[1]=n[1]*i+n[5]*r+n[9]*s,t[2]=n[2]*i+n[6]*r+n[10]*s,this.normalize()}clone(){let e=new m;return e.v.set(this.v),e}copy(e){return this.v.set(e.v),this}equal(e){return this.v[0]===e.x&&this.v[1]===e.y&&this.v[2]===e.z}lequal(e){return this.v[0]<=e.x&&this.v[1]<=e.y&&this.v[2]<=e.z}gequal(e){return this.v[0]>=e.x&&this.v[1]>=e.y&&this.v[2]>=e.z}min(e){let t=this.v,i=e.v;return t[0]=Math.min(t[0],i[0]),t[1]=Math.min(t[1],i[1]),t[2]=Math.min(t[2],i[2]),this}max(e){let t=this.v,i=e.v;return t[0]=Math.max(t[0],i[0]),t[1]=Math.max(t[1],i[1]),t[2]=Math.max(t[2],i[2]),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}setFromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}lerp(e,t,i){return m.lerp(e,t,i,this),this}static lerp(e,t,i,r){return null}setFromMatrixColumn(e,t){return this.setFromArray(e.m,4*t)}set x(e){this.v[0]=e}get x(){return this.v[0]}set y(e){this.v[1]=e}get y(){return this.v[1]}set z(e){this.v[2]=e}get z(){return this.v[2]}set r(e){this.v[0]=e}get r(){return this.v[0]}set g(e){this.v[1]=e}get g(){return this.v[1]}set b(e){this.v[2]=e}get b(){return this.v[2]}get data(){return this.v}toJson(){return{x:this.x,y:this.y,z:this.z}}fromJson(e){this.x=e.x,this.y=e.y,this.z=e.z}}m.Zero=new m(0,0,0),m.ZUp=new m(0,0,1),m.One=new m(1,1,1),m.pubTemp=new m,m.pool=new p(m,6),m.lerp=function(){const e=new m;return function(t,i,r,s){return s||(s=new m),s.copy(t).mul(1-r).addAt(e.copy(i).mul(r)),s}}();class f{constructor(e=0,t=0,i=0,r=0){this.v=new Float32Array([e,t,i,r])}set(e,t,i,r){return this.v[0]=e,this.v[1]=t,this.v[2]=i,this.v[3]=r,this}setAt(e){this.v.set(e.v)}normalize(){let e=this.v[0],t=this.v[1],i=this.v[2],r=this.v[3],s=e*e+t*t+i*i+r*r;return s>0&&(s=1/Math.sqrt(s),this.v[0]=e*s,this.v[1]=t*s,this.v[2]=i*s,this.v[3]=r*s),this}applyMatrix4(e){let t=this.v[0],i=this.v[1],r=this.v[2],s=this.v[3],n=e.m;return this.v[0]=n[0]*t+n[4]*i+n[8]*r+n[12]*s,this.v[1]=n[1]*t+n[5]*i+n[9]*r+n[13]*s,this.v[2]=n[2]*t+n[6]*i+n[10]*r+n[14]*s,this.v[3]=n[3]*t+n[7]*i+n[11]*r+n[15]*s,this}dot(e){let t=this.v,i=e.v;return t[0]*i[0]+t[1]*i[1]+t[2]*i[2]+t[3]*i[3]}clone(){let e=new f;return e.x=this.v[0],e.y=this.v[1],e.z=this.v[2],e.w=this.v[3],e}copy(e){this.v[0]=e.v[0],this.v[1]=e.v[1],this.v[2]=e.v[2],this.v[3]=e.v[3]}equal(e){let t=this.v,i=e.v;return t[0]===i[0]&&t[1]===i[1]&&t[2]===i[2]&&t[3]===i[3]}set x(e){this.v[0]=e}get x(){return this.v[0]}set y(e){this.v[1]=e}get y(){return this.v[1]}set z(e){this.v[2]=e}get z(){return this.v[2]}set w(e){this.v[3]=e}get w(){return this.v[3]}set r(e){this.v[0]=e}get r(){return this.v[0]}set g(e){this.v[1]=e}get g(){return this.v[1]}set b(e){this.v[2]=e}get b(){return this.v[2]}set a(e){this.v[3]=e}get a(){return this.v[3]}get data(){return this.v}toJson(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromJson(e){this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w}}f.Zero=new f,f.One=new f(1,1,1,1);class T extends f{constructor(e=0,t=0,i=0,r=1){super(e,t,i,r)}identity(){return this.v[0]=0,this.v[1]=0,this.v[2]=0,this.v[3]=1,this}multiply(e){return T.multiply(this,e,this),this}premultiply(e){return T.multiply(e,this,this),this}static multiply(e,t,i){let r=e.v,s=r[0],n=r[1],a=r[2],o=r[3];r=t.v;let g=r[0],A=r[1],I=r[2],C=r[3];r=i.v,r[0]=s*C+o*g+n*I-a*A,r[1]=n*C+o*A+a*g-s*I,r[2]=a*C+o*I+s*A-n*g,r[3]=o*C-s*g-n*A-a*I}setAxisAngle(e,t){t*=.5;let i=Math.sin(t);return this.v[0]=i*e.x,this.v[1]=i*e.y,this.v[2]=i*e.z,this.v[3]=Math.cos(t),this}rotationTo(e,t){return this}invert(){let e=this.v[0],t=this.v[1],i=this.v[2],r=this.v[3],s=e*e+t*t+i*i+r*r,n=s?1/s:0;return this.v[0]=-e*n,this.v[1]=-t*n,this.v[2]=-i*n,this.v[3]=r*n,this}setFromRotationMatrix(e){let t,i=e.m,r=i[0],s=i[4],n=i[8],a=i[1],o=i[5],g=i[9],A=i[2],I=i[6],C=i[10],h=r+o+C;return h>0?(t=.5/Math.sqrt(h+1),this.v[3]=.25/t,this.v[0]=(I-g)*t,this.v[1]=(n-A)*t,this.v[2]=(a-s)*t):r>o&&r>C?(t=2*Math.sqrt(1+r-o-C),this.v[3]=(I-g)/t,this.v[0]=.25*t,this.v[1]=(s+a)/t,this.v[2]=(n+A)/t):o>C?(t=2*Math.sqrt(1+o-r-C),this.v[3]=(n-A)/t,this.v[0]=(s+a)/t,this.v[1]=.25*t,this.v[2]=(g+I)/t):(t=2*Math.sqrt(1+C-r-o),this.v[3]=(a-s)/t,this.v[0]=(n+A)/t,this.v[1]=(g+I)/t,this.v[2]=.25*t),this}clone(){let e=new T;return e.setAt(this),e}}T.Zero=new T,T.prototype.rotationTo=function(){let e=new m,t=new m,i=new m;return function(r,s){e.copy(r).normalize(),t.copy(s).normalize();let n=e.dot(t);return n<-.999999?(i.set(1,0,0).crossAt(e),i.lengthSquare()<1e-9&&i.set(0,1,0).crossAt(t),i.normalize(),this.setAxisAngle(i,Math.PI),this):n>.999999?(this.v[0]=0,this.v[1]=0,this.v[2]=0,this.v[3]=1,this):(i.crossBy(e,t),this.v[0]=i.x,this.v[1]=i.y,this.v[2]=i.z,this.v[3]=1+n,this.normalize(),this)}}();class E{constructor(){this.m=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}identity(){let e=this.m;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}translate(e){let t=this.m,i=e.x,r=e.y,s=e.z;return t[12]+=t[0]*i+t[4]*r+t[8]*s,t[13]+=t[1]*i+t[5]*r+t[9]*s,t[14]+=t[2]*i+t[6]*r+t[10]*s,t[15]+=t[3]*i+t[7]*r+t[11]*s,this}setPosition(e){let t=this.m,i=e.x,r=e.y,s=e.z;return t[12]=i,t[13]=r,t[14]=s,this}rotate(e,t){let i,r,s,n,a,o,g,A,I,C,h,_,l,u,c,d,p,m,f,T,E,v,R,M,S=this.m,x=e.x,N=e.y,y=e.z,O=Math.sqrt(x*x+N*N+y*y);return Math.abs(O)<1e-6?null:(O=1/O,x*=O,N*=O,y*=O,i=Math.sin(t),r=Math.cos(t),s=1-r,n=S[0],a=S[1],o=S[2],g=S[3],A=S[4],I=S[5],C=S[6],h=S[7],_=S[8],l=S[9],u=S[10],c=S[11],d=x*x*s+r,p=N*x*s+y*i,m=y*x*s-N*i,f=x*N*s-y*i,T=N*N*s+r,E=y*N*s+x*i,v=x*y*s+N*i,R=N*y*s-x*i,M=y*y*s+r,S[0]=n*d+A*p+_*m,S[1]=a*d+I*p+l*m,S[2]=o*d+C*p+u*m,S[3]=g*d+h*p+c*m,S[4]=n*f+A*T+_*E,S[5]=a*f+I*T+l*E,S[6]=o*f+C*T+u*E,S[7]=g*f+h*T+c*E,S[8]=n*v+A*R+_*M,S[9]=a*v+I*R+l*M,S[10]=o*v+C*R+u*M,S[11]=g*v+h*R+c*M,this)}scale(e){let t=this.m;return t[0]*=e.x,t[1]*=e.x,t[2]*=e.x,t[3]*=e.x,t[4]*=e.y,t[5]*=e.y,t[6]*=e.y,t[7]*=e.y,t[8]*=e.z,t[9]*=e.z,t[10]*=e.z,t[11]*=e.z,this}transpose(){let e=this.m;return this.m.set([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]]),this}invert(){return this.getInvert(this)}getInvert(e){let t=e.m,i=t[0],r=t[1],s=t[2],n=t[3],a=t[4],o=t[5],g=t[6],A=t[7],I=t[8],C=t[9],h=t[10],_=t[11],l=t[12],u=t[13],c=t[14],d=t[15],p=i*o-r*a,m=i*g-s*a,f=i*A-n*a,T=r*g-s*o,E=r*A-n*o,v=s*A-n*g,R=I*u-C*l,M=I*c-h*l,S=I*d-_*l,x=C*c-h*u,N=C*d-_*u,y=h*d-_*c,O=p*y-m*N+f*x+T*S-E*M+v*R;return O?(O=1/O,t=this.m,t[0]=(o*y-g*N+A*x)*O,t[1]=(s*N-r*y-n*x)*O,t[2]=(u*v-c*E+d*T)*O,t[3]=(h*E-C*v-_*T)*O,t[4]=(g*S-a*y-A*M)*O,t[5]=(i*y-s*S+n*M)*O,t[6]=(c*f-l*v-d*m)*O,t[7]=(I*v-h*f+_*m)*O,t[8]=(a*N-o*S+A*R)*O,t[9]=(r*S-i*N-n*R)*O,t[10]=(l*E-u*f+d*p)*O,t[11]=(C*f-I*E-_*p)*O,t[12]=(o*M-a*x-g*R)*O,t[13]=(i*x-r*M+s*R)*O,t[14]=(u*m-l*T-c*p)*O,t[15]=(I*T-C*m+h*p)*O,this):null}invertTranspose(){return this.transpose().invert()}multiply(e){return E.multiply(this,e,this)}premultiply(e){return E.multiply(e,this,this)}multiplyBy(e,t){return E.multiply(e,t,this)}applyMatrix4(e){return this.multiply(e)}lookAtR(e,t,i){return this}lookAt(e,t,i){return this}perspective(e,t,i,r){let s=1/Math.tan(e/2),n=1/(i-r),a=this.m;return a[0]=s/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=s,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(r+i)*n,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*r*i*n,a[15]=0,this}frustum(e,t,i,r,s,n){let a=1/(t-e),o=1/(r-i),g=1/(s-n);return this.m[0]=2*s*a,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=2*s*o,this.m[6]=0,this.m[7]=0,this.m[8]=(t+e)*a,this.m[9]=(r+i)*o,this.m[10]=(n+s)*g,this.m[11]=-1,this.m[12]=0,this.m[13]=0,this.m[14]=2*n*s*g,this.m[15]=0,this}orthographic(e,t,i,r,s,n){let a=1/(e-t),o=1/(i-r),g=1/(s-n);return this.m[0]=-2*a,this.m[1]=0,this.m[2]=0,this.m[3]=0,this.m[4]=0,this.m[5]=-2*o,this.m[6]=0,this.m[7]=0,this.m[8]=0,this.m[9]=0,this.m[10]=2*g,this.m[11]=0,this.m[12]=(e+t)*a,this.m[13]=(r+i)*o,this.m[14]=(n+s)*g,this.m[15]=1,this}makeForQuaternion(e){let t=this.m,i=e.x,r=e.y,s=e.z,n=e.w,a=i+i,o=r+r,g=s+s,A=i*a,I=r*a,C=r*o,h=s*a,_=s*o,l=s*g,u=n*a,c=n*o,d=n*g;return t[0]=1-C-l,t[1]=I+d,t[2]=h-c,t[3]=0,t[4]=I-d,t[5]=1-A-l,t[6]=_+u,t[7]=0,t[8]=h+c,t[9]=_-u,t[10]=1-A-C,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}determinant(){var e=this.m,t=e[0],i=e[4],r=e[8],s=e[12],n=e[1],a=e[5],o=e[9],g=e[13],A=e[2],I=e[6],C=e[10],h=e[14];return e[3]*(+s*o*I-r*g*I-s*a*C+i*g*C+r*a*h-i*o*h)+e[7]*(+t*o*h-t*g*C+s*n*C-r*n*h+r*g*A-s*o*A)+e[11]*(+t*g*I-t*a*h-s*n*I+i*n*h+s*a*A-i*g*A)+e[15]*(-r*a*A-t*o*I+t*a*C+r*n*I-i*n*C+i*o*A)}compose(e,t,i){return this.makeForQuaternion(t),this.scale(i),this.setPosition(e),this}decompose(e,t,i){return this}makeBasis(e,t,i){return this.m.set([e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1]),this}extractRotation(e){return this}clone(){let e=new E;return e.m.set(this.m),e}copy(e){return this.m.set(e.m),this}get data(){return this.m}static multiply(e,t,i){let r=e.m,s=t.m,n=i.m,a=r[0],o=r[1],g=r[2],A=r[3],I=r[4],C=r[5],h=r[6],_=r[7],l=r[8],u=r[9],c=r[10],d=r[11],p=r[12],m=r[13],f=r[14],T=r[15],E=s[0],v=s[1],R=s[2],M=s[3];return n[0]=E*a+v*I+R*l+M*p,n[1]=E*o+v*C+R*u+M*m,n[2]=E*g+v*h+R*c+M*f,n[3]=E*A+v*_+R*d+M*T,E=s[4],v=s[5],R=s[6],M=s[7],n[4]=E*a+v*I+R*l+M*p,n[5]=E*o+v*C+R*u+M*m,n[6]=E*g+v*h+R*c+M*f,n[7]=E*A+v*_+R*d+M*T,E=s[8],v=s[9],R=s[10],M=s[11],n[8]=E*a+v*I+R*l+M*p,n[9]=E*o+v*C+R*u+M*m,n[10]=E*g+v*h+R*c+M*f,n[11]=E*A+v*_+R*d+M*T,E=s[12],v=s[13],R=s[14],M=s[15],n[12]=E*a+v*I+R*l+M*p,n[13]=E*o+v*C+R*u+M*m,n[14]=E*g+v*h+R*c+M*f,n[15]=E*A+v*_+R*d+M*T,i}}E._float32Data=new Float32Array(16),E.pubTemp=new E,E.unitMat4=new E,E.prototype.decompose=function(){const e=new m,t=new E;return function(i,r,s){let n=this.m,a=e.set(n[0],n[1],n[2]).length(),o=e.set(n[4],n[5],n[6]).length(),g=e.set(n[8],n[9],n[10]).length();this.determinant()<0&&(a=-a),i.x=n[12],i.y=n[13],i.z=n[14],t.m.set(this.m);var A=1/a,I=1/o,C=1/g;return t.m[0]*=A,t.m[1]*=A,t.m[2]*=A,t.m[4]*=I,t.m[5]*=I,t.m[6]*=I,t.m[8]*=C,t.m[9]*=C,t.m[10]*=C,r.setFromRotationMatrix(t),s.x=a,s.y=o,s.z=g,this}}(),E.prototype.extractRotation=function(){const e=new m;return function(t){const i=t.m,r=this.m,s=1/e.setFromMatrixColumn(t,0).length(),n=1/e.setFromMatrixColumn(t,1).length(),a=1/e.setFromMatrixColumn(t,2).length();return i[0]=r[0]*s,i[1]=r[1]*s,i[2]=r[2]*s,i[3]=0,i[4]=r[4]*n,i[5]=r[5]*n,i[6]=r[6]*n,i[7]=0,i[8]=r[8]*a,i[9]=r[9]*a,i[10]=r[10]*a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}}(),E.prototype.lookAtR=function(){const e=new m,t=new m,i=new m;return function(r,s,n){i.copy(r.subAt(s)).normalize(),e.crossBy(n,i).normalize(),t.crossBy(i,e).normalize();let a=this.m;return a[0]=e.x,a[1]=e.y,a[2]=e.z,a[4]=t.x,a[5]=t.y,a[6]=t.z,a[8]=i.x,a[9]=i.y,a[10]=i.z,a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,this}}(),E.prototype.lookAt=function(){const e=new m,t=new m,i=new m;return function(r,s,n){i.copy(r).subAt(s).normalize(),e.crossBy(n,i).normalize(),t.crossBy(i,e).normalize();let a=this.m;return a[0]=e.x,a[1]=t.x,a[2]=i.x,a[3]=0,a[4]=e.y,a[5]=t.y,a[6]=i.y,a[7]=0,a[8]=e.z,a[9]=t.z,a[10]=i.z,a[11]=0,a[12]=-e.dot(r),a[13]=-t.dot(r),a[14]=-i.dot(r),a[15]=1,this}}();class v{constructor(e=m.ZUp,t=0){this._normal=new m,this.setAt(e,t)}set(e,t,i,r){return this._normal.set(e,t,i),this._distance=r,this}setAt(e,t){return this._normal.copy(e),this._distance=t,this}setFromNormalAndCoplanarPoint(e,t){return this._normal.copy(e),this._distance=-t.dot(e),this}distanceToPoint(e){return this._normal.dot(e)+this._distance}normalize(){let e=1/this._normal.length();return this._normal.mul(e),this._distance*=e,this}copy(e){return this._normal.copy(e._normal),this._distance=e._distance,this}intersectBox(e){}get distance(){return this._distance}get normal(){return this._normal}}class R{constructor(e,t){this.origin=new m(0,0,0),this.dir=new m(0,0,-1),e&&this.origin.copy(e),t&&this.dir.copy(t)}set(e,t){e&&this.origin.copy(e),t&&this.dir.copy(t)}at(e,t){return void 0===t&&(console.warn("CGE.Ray: .at() target is now required"),t=new m),t.copy(this.dir).mul(e).addAt(this.origin)}distanceSqToSegment(e,t,i,r){}distanceSqToPoint(e){}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}intersectBox(e,t){const i=e.min,r=e.max;let s,n,a,o,g,A,I=1/this.dir.x,C=1/this.dir.y,h=1/this.dir.z,_=this.origin;return I>=0?(s=(i.x-_.x)*I,n=(r.x-_.x)*I):(s=(r.x-_.x)*I,n=(i.x-_.x)*I),C>=0?(a=(i.y-_.y)*C,o=(r.y-_.y)*C):(a=(r.y-_.y)*C,o=(i.y-_.y)*C),s>o||a>n?null:((a>s||s!=s)&&(s=a),(o<n||n!=n)&&(n=o),h>=0?(g=(i.z-_.z)*h,A=(r.z-_.z)*h):(g=(r.z-_.z)*h,A=(i.z-_.z)*h),s>A||g>n?null:((g>s||s!=s)&&(s=g),(A<n||n!=n)&&(n=A),n<0?null:this.at(s>=0?s:n,t)))}isIntersectBox(e){}instersectSphere(e){}isInstersectSphere(e){return this.distanceSqToPoint(e.pos)<=e.radius*e.radius}intersectTriangle(e,t,i,r,s){return!1}copy(e){return this.dir.copy(e.dir),this.origin.copy(e.origin),this}clone(){return(new R).copy(this)}applyMatrix4(e){this.origin.applyMatrix4(e),this.dir.transformDirection(e)}toJson(){return{origin:this.origin.toJson(),dir:this.dir.toJson()}}fromJson(e){this.origin.fromJson(e.origin),this.dir.fromJson(e.dir)}}R.prototype.isIntersectBox=function(){const e=new m;return function(t){return null!==this.intersectBox(t,e)}}(),R.prototype.distanceSqToSegment=function(){const e=new m,t=new m,i=new m;return function(r,s,n,a){e.copy(r).addAt(s).mul(.5),t.copy(s).subAt(r).normalize(),i.copy(this.origin).subAt(e);let o,g,A,I,C=.5*r.distanceTo(s),h=-this.direction.dot(t),_=i.dot(this.direction),l=-i.dot(t),u=i.lengthSquare(),c=Math.abs(1-h*h);if(c>0)if(o=h*l-_,g=h*_-l,I=C*c,o>=0)if(g>=-I)if(g<=I){let e=1/c;o*=e,g*=e,A=o*(o+h*g+2*_)+g*(h*o+g+2*l)+u}else g=C,o=Math.max(0,-(h*g+_)),A=-o*o+g*(g+2*l)+u;else g=-C,o=Math.max(0,-(h*g+_)),A=-o*o+g*(g+2*l)+u;else g<=-I?(o=Math.max(0,-(-h*C+_)),g=o>0?-C:Math.min(Math.max(-C,-l),C),A=-o*o+g*(g+2*l)+u):g<=I?(o=0,g=Math.min(Math.max(-C,-l),C),A=g*(g+2*l)+u):(o=Math.max(0,-(h*C+_)),g=o>0?C:Math.min(Math.max(-C,-l),C),A=-o*o+g*(g+2*l)+u);else g=h>0?-C:C,o=Math.max(0,-(h*g+_)),A=-o*o+g*(g+2*l)+u;return n&&n.copy(this.direction).mul(o).addAt(this.origin),a&&a.copy(t).mul(g).addAt(e),A}}(),R.prototype.distanceSqToPoint=function(){const e=new m;return function(t){const i=e.subBy(t,this.origin).dot(this.dir);return i<0?this.origin.distanceToSquare(t):(e.copy(this.dir).mul(i).addAt(this.origin),e.distanceToSquare(t))}}(),R.prototype.instersectSphere=function(){const e=new m;return function(t,i){e.subBy(t.pos,this.origin);const r=e.dot(this.dir),s=e.dot(e)-r*r,n=t.radius*t.radius;if(s>n)return null;const a=Math.sqrt(n-s),o=r-a,g=r+a;return o<0&&g<0?null:o<0?this.at(g,i):this.at(o,i)}}(),R.prototype.intersectTriangle=function(){const e=new m,t=new m,i=new m,r=new m;return function(s,n,a,o,g){t.copy(n).subAt(s),i.copy(a).subAt(s),r.crossBy(t,i);let A,I=this.dir.dot(r);if(I>0){if(o)return!1;A=1}else{if(!(I<0))return!1;A=-1,I=-I}e.subBy(this.origin,s);let C=A*this.dir.dot(i.crossBy(e,i));if(C<0)return!1;let h=A*this.dir.dot(t.cross(e));if(h<0)return!1;if(C+h>I)return!1;let _=-A*e.dot(r);return!(_<0)&&(this.at(_/I,g),!0)}}();class M{constructor(e=new m,t=new T,i=new m(1,1,1)){this._matrix=new E,this._needsUpdate=!0,this._position=e,this._rotate=t,this._scale=i,this.makeMatrix()}setNeedUpdateMatrix(){this._needsUpdate=!0}update(e){this.makeMatrix()}setPosition(e){this._position.set(e.x,e.y,e.z),this.setNeedUpdateMatrix()}setPositionValue(e,t,i){this._position.set(e,t,i),this.setNeedUpdateMatrix()}getPosition(){return this._position}setRotate(e){this._rotate.set(e.x,e.y,e.z,e.w),this.setNeedUpdateMatrix()}getRotate(){return this._rotate}setScale(e){this._scale.set(e.x,e.y,e.z),this.setNeedUpdateMatrix()}getScale(){return this._scale}getMatrix(){return this.makeMatrix(),this._matrix}makeMatrix(){this._needsUpdate&&(this._matrix.compose(this._position,this._rotate,this._scale),this._needsUpdate=!1)}decompose(){this._matrix.decompose(this._position,this._rotate,this._scale)}applyMatrix4(e){this._matrix.premultiply(e),this.decompose()}makeLookAtFromThis(e,t,i){let r=void 0===e?new m(0,0,0):e.clone(),s=void 0===t?new m(1,0,0):t.clone(),n=void 0===i?new m(0,0,1):i.clone();r.applyMatrix4(this._matrix),s.applyMatrix4(this._matrix),n.applyMatrix4(this._matrix);let a=new E;return a.lookAt(r,s,n),a}lookAt(e,t){let i=e.clone(),r=void 0===t?new m(0,0,1):t.clone();this._matrix.lookAt(this._position,i,r),this._matrix.invert(),this.decompose()}}let S=[[0,0,0],[0,0,0],[0,0,0]];function x(e,t,i,r){for(let s=0;3!=s;++s)S[0][s]=e.v[s]-r.v[s],S[1][s]=t.v[s]-r.v[s],S[2][s]=i.v[s]-r.v[s];return S[0][0]*S[1][1]*S[2][2]+S[0][1]*S[1][2]*S[2][0]+S[0][2]*S[1][0]*S[2][1]-S[0][2]*S[1][1]*S[2][0]-S[0][1]*S[1][0]*S[2][2]-S[0][0]*S[1][2]*S[2][1]}function N(e,t,i,r,s,n){return(s-e)*(r-t)-(i-e)*(n-t)}function y(e,t,i,r,s,n){return s>=(e<i?e:i)&&s<=(e>i?e:i)&&n>=(t<r?t:r)&&n<=(t>r?t:r)}function O(e,t){e.x=t.p1.x+t.p2.x+t.p3.x,e.y=t.p1.y+t.p2.y+t.p3.y,e.z=t.p1.z+t.p2.z+t.p3.z}function D(e,t,i,r,s,n,a,o){let g,A,I,C;return g=N(s,n,a,o,e,t),A=N(s,n,a,o,i,r),I=N(e,t,i,r,s,n),C=N(e,t,i,r,a,o),g*A<0&&I*C<0||(!(0!=g||!y(s,n,a,o,e,t))||(!(0!=A||!y(s,n,a,o,i,r))||(!(0!=I||!y(e,t,i,r,s,n))||!(0!=C||!y(e,t,i,r,a,o)))))}function F(e,t,i,r=0,s=1){let n=t.v,a=i.v,o=e.p1.v,g=e.p2.v;return!!D(n[r],n[s],a[r],a[s],o[r],o[s],g[r],g[s])||(o=e.p2.v,g=e.p3.v,!!D(n[r],n[s],a[r],a[s],o[r],o[s],g[r],g[s])||(o=e.p1.v,g=e.p3.v,!!D(n[r],n[s],a[r],a[s],o[r],o[s],g[r],g[s])))}function w(e,t){let i=m.pool.create().subBy(e.p3,e.p1).mul(3),r=m.pool.create().subBy(e.p2,e.p1).mul(3),s=m.pool.create().copy(e.p1).negate().mul(3).addAt(t),n=i.dot(i),a=i.dot(r),o=i.dot(s),g=r.dot(r),A=r.dot(s);m.pool.recovery(i),m.pool.recovery(r),m.pool.recovery(s);let I=1/(n*g-a*a),C=(g*o-a*A)*I;if(C<0||C>1)return!1;let h=(n*A-a*o)*I;return!(h<0||h>1)&&C+h<=1}function b(e,t){let i=m.pool.create().subBy(e.p3,e.p1),r=m.pool.create().subBy(e.p2,e.p1),s=m.pool.create().subBy(t,e.p1),n=i.dot(i),a=i.dot(r),o=i.dot(s),g=r.dot(r),A=r.dot(s);m.pool.recovery(i),m.pool.recovery(r),m.pool.recovery(s);let I=1/(n*g-a*a),C=(g*o-a*A)*I;if(C<0||C>1)return!1;let h=(n*A-a*o)*I;return!(h<0||h>1)&&C+h<=1}let L=new Float32Array(9);function P(e,t){let i,r,s=e.p1,n=e.p2,a=e.p3,o=t.p1,g=t.p2,A=t.p3;return L[0]=x(s,n,a,o),L[1]=x(s,n,a,g),L[2]=x(s,n,a,A),!(L[0]>0&&L[1]>0&&L[2]>0)&&(!(L[0]<0&&L[1]<0&&L[2]<0)&&(0===L[0]&&0===L[0]&&0===L[0]?function(e,t){let i=m.pool.create().subBy(e.p2,e.p1),r=m.pool.create().subBy(e.p3,e.p2),s=m.pool.create().crossBy(i,r),n=0,a=1;if(0!==s.z?(n=0,a=1):0!==s.x?(n=1,a=2):0!==s.y&&(n=0,a=2),m.pool.recovery(i),m.pool.recovery(r),m.pool.recovery(s),F(t,e.p1,e.p2,n,a))return!0;if(F(t,e.p2,e.p3,n,a))return!0;if(F(t,e.p1,e.p3,n,a))return!0;{let i=m.pool.create(),r=m.pool.create();O(i,e),O(r,t);let s=w(t,i)||w(e,r);return m.pool.recovery(i),m.pool.recovery(r),s}}(e,t):0===L[0]&&L[1]*L[2]>0?b(e,o):0===L[1]&&L[2]*L[0]>0?b(e,g):0===L[2]&&L[0]*L[1]>0?b(e,A):(L[3]=x(o,g,A,s),L[4]=x(o,g,A,n),L[5]=x(o,g,A,a),!(L[3]>0&&L[4]>0&&L[5]>0)&&(!(L[3]<0&&L[4]<0&&L[5]<0)&&(0===L[3]&&L[4]*L[5]>0?b(e,o):0===L[4]&&L[5]*L[3]>0?b(e,g):0===L[5]&&L[3]*L[4]>0?b(e,A):(L[4]*L[5]>=0&&0!==L[3]?L[3]<0&&(i=g,g=A,A=i,r=L[1],L[1]=L[2]):L[3]*L[5]>=0&&0!=L[4]?(i=s,s=n,n=a,a=i,L[4]<0&&(i=g,g=A,A=i,r=L[1],L[1]=L[2],L[2]=r)):L[3]*L[4]>=0&&0!=L[5]&&(i=s,s=a,a=n,n=i,L[5]<0&&(i=g,g=A,A=i,r=L[1],L[1]=L[2],L[2]=r)),L[1]*L[2]>=0&&0!=L[0]?L[0]<0&&(i=n,n=a,a=i):L[0]*L[2]>=0&&0!=L[1]?(i=o,o=g,g=A,A=i,L[1]<0&&(i=n,n=a,a=i)):L[0]*L[1]>=0&&0!=L[2]&&(i=o,o=A,A=g,g=i,L[2]<0&&(i=n,n=a,a=i)),x(s,n,o,g)<=0&&x(s,a,A,o)<=0))))))}class U{constructor(e,t,i){this.p1=new m,this.p2=new m,this.p3=new m,e&&this.p1.copy(e),t&&this.p2.copy(t),i&&this.p3.copy(i)}computeNormal(e){}intersectTriangle(e){return P(this,e)}}U.prototype.computeNormal=function(){const e=new m;return function(t){t||(t=new m),t.subBy(this.p3,this.p2),e.subBy(this.p1,this.p2),t.crossAt(e);const i=t.lengthSquare();return i>0?t.mul(1/Math.sqrt(i)):t.set(0,0,0),t}}();class B extends l{constructor(e){super(),this.path=[],e instanceof MouseEvent?(this._x=e.offsetX,this._y=e.offsetY,this._movementX=e.movementX,this._movementY=e.movementY,this._setType(e.type)):e instanceof KeyboardEvent&&(this.key=e.key,this.keyCode=e.keyCode,this._setType(e.type)),this.altKey=e.altKey,this.ctrlKey=e.ctrlKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.native=e}_setType(e){this._type=B.TypeMap[e]}set type(e){this._type=e}get type(){return this._type}get stageX(){return this._x}get stageY(){return this._y}get movementX(){return this._movementX}get movementY(){return this._movementY}}B.TypeMap={mousedown:"mouse_down",mousemove:"mouse_move",mouseup:"mouse_up",mouseover:"mouse_over",mouseout:"mouse_out",keydown:"key_down",keyup:"key_up",keypress:"key_press",blur:"on_blur"},B.CLICK="click",B.MOUSE_DOWN="mouse_down",B.MOUSE_MOVE="mouse_move",B.MOUSE_UP="mouse_up",B.MOUSE_OVER="mouse_over",B.MOUSE_OUT="mouse_out",B.KEY_DOWN="key_down",B.KEY_UP="key_up",B.KEY_PRESS="key_press",B.CLIENT_RESIZE="client_resize",B.RENDERER_RESIZE="renderer_resize",B.DESTROTY="destroy",B.LOOP_FRAME="loop_frame",B.ON_BLUR="on_blur";class z{constructor(){this.handler=new h(null,null),this.once=!1,this.frame=!1}clearUp(){this.handler.clear()}static create(){return z.pool.create()}static recovery(e){e.clearUp(),z.pool.recovery(e)}}z.pool=new p(z,10);class G{constructor(){this.frameTime=0,this._preMap=new Map,this._lateMap=new Map}once(e,t,i,r){this._loop(!0,!1,e,t,i,r)}loop(e,t,i,r){this._loop(!1,!1,e,t,i,r)}frameOnce(e,t,i,r){this._loop(!0,!0,e,t,i,r)}frameLoop(e,t,i,r){this._loop(!1,!0,e,t,i,r)}lateOnce(e,t,i,r){this._loop(!0,!1,e,t,i,r,!0)}lateLoop(e,t,i,r){this._loop(!1,!1,e,t,i,r,!0)}lateFrameOnce(e,t,i,r){this._loop(!0,!0,e,t,i,r,!0)}lateFrameLoop(e,t,i,r){this._loop(!1,!0,e,t,i,r,!0)}_remove(e,t,i){let r=i.get(e);if(!r)return;let s=r.get(t);s&&(z.recovery(s),r.delete(t),r.size<=0&&i.delete(r))}remove(e,t){this._remove(e,t,this._preMap),this._remove(e,t,this._lateMap)}_clearCeller(e,t){let i=t.get(e);i&&(i.forEach((e,t)=>{z.recovery(e),i.delete(t)}),t.delete(e))}clearCeller(e){this._clearCeller(e,this._preMap),this._clearCeller(e,this._lateMap)}_clearAll(e){e.forEach((t,i)=>{t.forEach((e,i)=>{z.recovery(e),t.delete(i)}),e.delete(i)})}clearAll(){this._clearAll(this._preMap),this._clearAll(this._lateMap)}_loop(e,t,i,r,s,n,a=!1){let o=z.create();o.handler.setTo(r,s,n,!1),o.once=e,o.frame=t,o.time=i,o.curTime=i;let g=a?this._lateMap:this._preMap,A=g.get(r);A||(A=new Map,g.set(r,A)),A.set(s,o)}_update(e,t){t.forEach((i,r)=>{i.forEach((t,r)=>{t.curTime-=t.frame?1:e,t.curTime>0||(t.handler.run(),t.once?(z.recovery(t),i.delete(r)):t.curTime=t.time+t.curTime)}),0===i.size&&t.delete(r)})}preUpdate(e){this.frameTime=e,this._update(e,this._preMap)}lateUpdate(e){this._update(e,this._lateMap)}}var H,V;!function(e){e[e.TYPE_SPHERE=0]="TYPE_SPHERE",e[e.TYPE_AABB=1]="TYPE_AABB",e[e.TYPE_OBB=2]="TYPE_OBB"}(H||(H={}));class W{static _buildObbVecs(e,t,i){const r=e.getPosition(),s=e.getRoatation(),n=e.getSize(),a=m.pubTemp;t[0].set(1,0,0),t[0].applyQuaternion(s),t[1].set(0,1,0),t[1].applyQuaternion(s),t[2].set(0,0,1),t[2].applyQuaternion(s);for(let e=0;e<2;e++)for(let s=0;s<2;s++)for(let o=0;o<2;o++){let g=i[4*e+2*s+o];g.setAt(r),a.copy(t[0]),g.addAt(1===o?a.negate().mul(n.x):a.mul(n.x)),a.copy(t[1]),g.addAt(1===s?a.negate().mul(n.y):a.mul(n.y)),a.copy(t[2]),g.addAt(1===e?a.negate().mul(n.z):a.mul(n.z))}}static _intersectCheck(e,t,i){let r,s=1/0,n=-1/0,a=1/0,o=-1/0,g=t.length;for(let i=0;i<g;i++)r=e.dot(t[i]),s=Math.min(s,r),n=Math.max(n,r);g=i.length;for(let t=0;t<g;t++)r=e.dot(i[t]),a=Math.min(a,r),o=Math.max(o,r);return s>o||a>n}static intersectOBB(e,t){const i=W._obb1Dir,r=W._obb2Dir,s=W._obb1Pos,n=W._obb2Pos;W._buildObbVecs(e,i,s),W._buildObbVecs(t,r,n);const a=i.length,o=r.length,g=m.pubTemp;for(let e=0;e<a;e++)if(W._intersectCheck(i[e],s,n))return!1;for(let e=0;e<o;e++)if(W._intersectCheck(r[e],s,n))return!1;for(let e=0;e<a;e++)for(let t=0;t<o;t++)if(W._intersectCheck(g.crossBy(i[e],r[t]),s,n))return!1;return!0}static intersectAABB(e,t){const i=e.getMin(),r=e.getMax(),s=t.getMin(),n=t.getMax();return!(i.x>n.x||r.x<s.x)&&(!(i.y>n.y||r.y<s.y)&&!(i.z>n.z||r.z<s.z))}static intersectSphere(e,t){m.pubTemp.copy(e.getPosition()),m.pubTemp.subAt(t.getPosition());const i=e.getRadius(),r=t.getRadius();return m.pubTemp.lengthSquare()<=i*i+r*r}static intersectSphereToOBB(e,t){}static intersectSphereToAABB(e,t){}static intersectOBBToAABB(e,t){}}W._obb1Pos=[new m,new m,new m,new m,new m,new m,new m,new m],W._obb2Pos=[new m,new m,new m,new m,new m,new m,new m,new m],W._obb1Dir=[new m,new m,new m],W._obb2Dir=[new m,new m,new m];class k{constructor(e,t){this.min=e?e.clone():new m(1/0,1/0,1/0),this.max=e?t.clone():new m(-1/0,-1/0,-1/0)}reset(){return this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0),this}setAt(e=m.Zero,t=m.Zero){return this.min.copy(e),this.max.copy(t),this}expandAtPoint(e){this.min.min(e),this.max.max(e)}expandAtBox(e){this.expandAtPoint(e.min),this.expandAtPoint(e.max)}expandAtSphere(e){let t=e.radius,i=m.pubTemp.copy(e.pos).add(t,t,t);this.expandAtPoint(i),i.copy(e.pos).sub(t,t,t),this.expandAtPoint(i)}applyMatrix(e){const t=this.min,i=this.max,r=t.x,s=t.y,n=t.z,a=i.x,o=i.y,g=i.z,A=m.pool,I=A.create().set(1/0,1/0,1/0),C=A.create().set(-1/0,-1/0,-1/0);let h=m.pubTemp;for(let t=0;t<2;t++)for(let i=0;i<2;i++)for(let A=0;A<2;A++)h.set(1===A?a:r,1===i?o:s,1===t?g:n),h.applyMatrix4(e),C.max(h),I.min(h);return t.copy(I),i.copy(C),A.recovery(I),A.recovery(C),this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}cross(e){this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.reset}union(e){this.min.min(e.min),this.max.max(e.max)}intersectBox(e){const t=e.min,i=e.max,r=this.min,s=this.max;return!(t.x>s.x||i.x<r.x)&&(!(t.y>s.y||i.y<r.y)&&!(t.z>s.z||i.z<r.z))}containBox(e){return this.min.lequal(e.min)||this.max.gequal(e.max)}intersectSphere(e){let t=m.pubTemp.copy(e.pos);return t.clamp(this.min,this.max),t.subAt(e.pos).lengthSquare()<=e.radius*e.radius}containSphere(e){let t=m.pubTemp,i=e.pos,r=e.radius;return t.copy(i).sub(r,r,r),!!this.min.lequal(t)&&(t.copy(i).add(r,r,r),!!this.max.gequal(t))}containBounding(e){return!1}setFromMatrix(e){}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}clone(){let e=new k;return e.copy(this),e}}k.pubTemp=new k;class X{constructor(){this._box=new k}applyMatrix(e){this._box.applyMatrix(e)}intersectRay(e){return e.isIntersectBox(this._box)}intersect(e){switch(e.getType()){case H.TYPE_SPHERE:return W.intersectSphereToAABB(e,this);case H.TYPE_AABB:return W.intersectAABB(e,this);case H.TYPE_OBB:return W.intersectOBBToAABB(e,this);default:return!1}}setMin(e,t,i){this._box.min.set(e,t,i)}setMinAt(e){this._box.min.setAt(e)}setMax(e,t,i){this._box.max.set(e,t,i)}setMaxAt(e){this._box.max.setAt(e)}getMin(){return this._box.min}getMax(){return this._box.max}getType(){return H.TYPE_AABB}copy(e){this._box.copy(e._box)}get box(){return this._box}clone(){const e=new X;return e.copy(this),e}}class Y{constructor(){this._pos=new m,this._size=new m,this._rotation=new T}applyMatrix(e){}intersectRay(e){return!1}intersect(e){switch(e.getType()){case H.TYPE_SPHERE:return W.intersectSphereToOBB(e,this);case H.TYPE_AABB:return W.intersectOBBToAABB(this,e);case H.TYPE_OBB:return W.intersectOBB(e,this);default:return!1}}setPosition(e,t,i){this._pos.set(e,t,i)}setPositionAt(e){this._pos.setAt(e)}setSize(e,t,i){this._size.set(e,t,i)}setSizeAt(e){this._size.setAt(e)}setRotation(e,t,i,r){this._rotation.set(e,t,i,r)}setRotationAt(e){this._rotation.setAt(e)}getPosition(){return this._pos}getSize(){return this._size}getRoatation(){return this._rotation}getType(){return H.TYPE_OBB}copy(e){this._pos.copy(e._pos),this._rotation.copy(e._rotation),this._size.copy(e._size)}clone(){const e=new Y;return e.copy(this),e}}class j{constructor(e=m.ZUp,t=0){this.pos=new m,this.radius=0,this.setAt(e,t)}set(e,t,i,r){this.pos.set(e,t,i),this.radius=r}setAt(e,t){this.pos.copy(e),this.radius=t}applyMatrix(e){}copy(e){this.pos.copy(e.pos),this.radius=e.radius}}class Z{constructor(){this._sphere=new j}setFrom(e,t){this._sphere.copy(e._sphere),this._sphere.applyMatrix(t)}applyMatrix(e){this._sphere.applyMatrix(e)}intersectRay(e){return e.isInstersectSphere(this._sphere)}intersect(e){switch(e.getType()){case H.TYPE_SPHERE:return W.intersectSphere(e,this);case H.TYPE_AABB:return W.intersectSphereToAABB(this,e);case H.TYPE_OBB:return W.intersectSphereToOBB(this,e);default:return!1}}setPosition(e,t,i){this._sphere.pos.set(e,t,i)}setPositionAt(e){this._sphere.pos.setAt(e)}setRadius(e){this._sphere.radius=e}getPosition(){return this._sphere.pos}getRadius(){return this._sphere.radius}getType(){return H.TYPE_SPHERE}copy(e){this._sphere.copy(e._sphere)}clone(){const e=new Z;return e.copy(this),e}get sphere(){return this._sphere}}!function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.FUNC_ADD=32774]="FUNC_ADD",e[e.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",e[e.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",e[e.BLEND_DST_RGB=32968]="BLEND_DST_RGB",e[e.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",e[e.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",e[e.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.BLEND_COLOR=32773]="BLEND_COLOR",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",e[e.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",e[e.REPEAT=10497]="REPEAT",e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK",e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP",e[e.INVERT=5386]="INVERT",e[e.CW=2304]="CW",e[e.CCW=2305]="CCW",e[e.READ_BUFFER=3074]="READ_BUFFER",e[e.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",e[e.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",e[e.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",e[e.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",e[e.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",e[e.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",e[e.COLOR=6144]="COLOR",e[e.DEPTH=6145]="DEPTH",e[e.STENCIL=6146]="STENCIL",e[e.RED=6403]="RED",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB10_A2=32857]="RGB10_A2",e[e.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",e[e.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",e[e.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",e[e.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",e[e.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",e[e.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",e[e.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",e[e.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",e[e.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",e[e.MIN=32775]="MIN",e[e.MAX=32776]="MAX",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",e[e.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",e[e.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",e[e.CURRENT_QUERY=34917]="CURRENT_QUERY",e[e.QUERY_RESULT=34918]="QUERY_RESULT",e[e.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STREAM_COPY=35042]="STREAM_COPY",e[e.STATIC_READ=35045]="STATIC_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",e[e.DRAW_BUFFER0=34853]="DRAW_BUFFER0",e[e.DRAW_BUFFER1=34854]="DRAW_BUFFER1",e[e.DRAW_BUFFER2=34855]="DRAW_BUFFER2",e[e.DRAW_BUFFER3=34856]="DRAW_BUFFER3",e[e.DRAW_BUFFER4=34857]="DRAW_BUFFER4",e[e.DRAW_BUFFER5=34858]="DRAW_BUFFER5",e[e.DRAW_BUFFER6=34859]="DRAW_BUFFER6",e[e.DRAW_BUFFER7=34860]="DRAW_BUFFER7",e[e.DRAW_BUFFER8=34861]="DRAW_BUFFER8",e[e.DRAW_BUFFER9=34862]="DRAW_BUFFER9",e[e.DRAW_BUFFER10=34863]="DRAW_BUFFER10",e[e.DRAW_BUFFER11=34864]="DRAW_BUFFER11",e[e.DRAW_BUFFER12=34865]="DRAW_BUFFER12",e[e.DRAW_BUFFER13=34866]="DRAW_BUFFER13",e[e.DRAW_BUFFER14=34867]="DRAW_BUFFER14",e[e.DRAW_BUFFER15=34868]="DRAW_BUFFER15",e[e.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",e[e.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",e[e.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SRGB=35904]="SRGB",e[e.SRGB8=35905]="SRGB8",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",e[e.RGBA32F=34836]="RGBA32F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.RGB16F=34843]="RGB16F",e[e.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",e[e.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",e[e.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",e[e.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",e[e.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",e[e.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.RGB9_E5=35901]="RGB9_E5",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",e[e.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",e[e.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",e[e.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",e[e.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",e[e.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",e[e.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",e[e.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",e[e.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",e[e.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",e[e.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e[e.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",e[e.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",e[e.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",e[e.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",e[e.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",e[e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",e[e.MAX_SAMPLES=36183]="MAX_SAMPLES",e[e.HALF_FLOAT=5131]="HALF_FLOAT",e[e.RG=33319]="RG",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R16F=33325]="R16F",e[e.R32F=33326]="R32F",e[e.RG16F=33327]="RG16F",e[e.RG32F=33328]="RG32F",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",e[e.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",e[e.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",e[e.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",e[e.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",e[e.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",e[e.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",e[e.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",e[e.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",e[e.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",e[e.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",e[e.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",e[e.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",e[e.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",e[e.UNIFORM_TYPE=35383]="UNIFORM_TYPE",e[e.UNIFORM_SIZE=35384]="UNIFORM_SIZE",e[e.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",e[e.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",e[e.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",e[e.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",e[e.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",e[e.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",e[e.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",e[e.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",e[e.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",e[e.INVALID_INDEX=4294967295]="INVALID_INDEX",e[e.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",e[e.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",e[e.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS",e[e.SYNC_FENCE=37142]="SYNC_FENCE",e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED",e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED",e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",e[e.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",e[e.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",e[e.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",e[e.SAMPLER_BINDING=35097]="SAMPLER_BINDING",e[e.RGB10_A2UI=36975]="RGB10_A2UI",e[e.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",e[e.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",e[e.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",e[e.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",e[e.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",e[e.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",e[e.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",e[e.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS"}(V||(V={}));class K extends l{constructor(){super(),this._renderObjectRef=[],this._count=0}setRenderObjectRef(e,t){this._renderObjectRef[e.getRendererId()]=t}getRenderObjectRef(e){return this._renderObjectRef[e.getRendererId()]}_updateRenderObjectRef(){}retain(){this._count++}release(){this._count--,0===this._count&&this.destroy()}destroy(){let e=this._renderObjectRef,t=e.length;for(let i=0;i<t;i++)e[i]&&e[i].remove(i)}needsUpdate(){let e=this._renderObjectRef,t=e.length;for(let i=0;i<t;i++)e[i]&&e[i].needsUpdate()}}class q extends K{constructor(){super(),this._minFilter=V.LINEAR,this._magFilter=V.LINEAR,this._format=V.RGBA,this._internalformat=V.RGBA,this._dataType=V.UNSIGNED_BYTE,this._mipmap=!1,this._needMipmap=!1,this._unpackAlignment=4}setFilter(e,t){this._minFilter=e||V.LINEAR,this._magFilter=t||V.LINEAR}getMinFilter(){return this._minFilter}getMagFilter(){return this._magFilter}setFormat(e,t){this._format=e||V.RGBA,this._internalformat=t||V.RGBA}getFormat(){return this._format}getInternalformat(){return this._internalformat}setDataType(e){this._dataType=e}getDataType(){return this._dataType}setMipmap(e){this._needMipmap=e,this.needsUpdate()}getMipmap(){return this._needMipmap}setUnpackAlignment(e){this._unpackAlignment=e}getUnpackAlignment(){return this._unpackAlignment}getType(){return-1}get isUrl(){return!1}}const Q=new _;class J{static setBaseUrl(e){J._baseUrl=e}static join(e){return 0===e.indexOf(J._baseUrl)?e:J._baseUrl+e}static loadImage(e,t){let i=J.join(e),r=this._imgsMap.get(e);if(r)return r.count++,t&&t(),r.image;let s=new Image;return this._imgsMap.set(i,{count:1,image:s}),s.onload=()=>{t&&t()},s.onerror=()=>{c.error(s.baseURI,"can not loaded")},s.src=i,s}static removeImage(e){let t=J.join(e),i=this._imgsMap.get(t);i&&(i.count--,0===i.count&&this._imgsMap.delete(t))}static loadUrl(e,t="text"){return this._XMLHttpRequest(J.join(e),t).then(e=>e).catch(e=>c.error(e))}static loadUrls(e,t){const i=e.map(({url:e,type:t})=>this._XMLHttpRequest(J.join(e),t).then(e=>e).catch(e=>c.error(e)));return Promise.all(i).then(e=>t?t(e):e).catch(e=>c.error(e))}static _disposeLoad(){let e=this._loadList.entries().next();if(e.done||0===this._xmlRequests.length)return;this._loadList.delete(e.value[0]);const t=e.value[0],i=e.value[1],r=this._xmlRequests.pop();r.onreadystatechange=()=>{4==r.readyState&&(this._xmlRequests.push(r),this._disposeLoad(),200==r.status?(this._loadedMap.set(t,r.response),Q.event(t,[r.response])):c.error(r))},r.open("GET",t,!0),r.responseType=i||"",r.send(null)}static _XMLHttpRequest(e,t){let i=J.join(e),r=this._loadedMap.get(i);return r?Promise.resolve(r):(this._loadList.set(i,t),new Promise((e,t)=>{Q.once(i,this,e),this._disposeLoad()}))}}function $(e,t,i,r){let s,n=e.length/3,a=r.length,o=[],g=[];for(s=0;s<n;s++)o[4*s]=0,o[4*s+1]=0,o[4*s+2]=0,o[4*s+3]=0,g[3*s]=0,g[3*s+1]=0,g[3*s+2]=0;let A=new m,I=new m,C=new m,h=new m,_=new m,l=new m;for(s=0;s<a;s+=3){let i=r[s],n=r[s+1],a=r[s+2],A=e[3*i],I=e[3*i+1],C=e[3*i+2],h=e[3*n],u=e[3*n+1],c=e[3*n+2],d=e[3*a],p=e[3*a+1],m=e[3*a+2],f=t[2*i],T=t[2*i+1],E=t[2*n],v=t[2*n+1],R=h-A,M=d-A,S=u-I,x=p-I,N=c-C,y=m-C,O=E-f,D=t[2*a]-f,F=v-T,w=t[2*a+1]-T,b=1/(O*w-D*F);_.x=(w*R-F*M)*b,_.y=(w*S-F*x)*b,_.z=(w*N-F*y)*b,l.x=(O*M-D*R)*b,l.y=(O*x-D*S)*b,l.z=(O*y-D*N)*b,o[4*i]+=_.x,o[4*i+1]+=_.y,o[4*i+2]+=_.z,o[4*n]+=_.x,o[4*n+1]+=_.y,o[4*n+2]+=_.z,o[4*a]+=_.x,o[4*a+1]+=_.y,o[4*a+2]+=_.z,g[3*i]+=l.x,g[3*i+1]+=l.y,g[3*i+2]+=l.z,g[3*n]+=l.x,g[3*n+1]+=l.y,g[3*n+2]+=l.z,g[3*a]+=l.x,g[3*a+1]+=l.y,g[3*a+2]+=l.z}for(s=0;s<n;s++){h.x=i[3*s],h.y=i[3*s+1],h.z=i[3*s+2],A.x=o[4*s],A.y=o[4*s+1],A.z=o[4*s+2];let e=h.dot(A);I.x=A.x-h.x*e,I.y=A.y-h.y*e,I.z=A.z-h.z*e,I.normalize(),o[4*s]=I.x,o[4*s+1]=I.y,o[4*s+2]=I.z,C.x=g[3*s],C.y=g[3*s+1],C.z=g[3*s+2],o[4*s+3]=h.cross(A).dot(C)<0?-1:1}return o}J._baseUrl="",J._imgsMap=new Map,J._loadedMap=new Map,J._loadList=new Map,J._xmlRequests=[new XMLHttpRequest,new XMLHttpRequest,new XMLHttpRequest,new XMLHttpRequest,new XMLHttpRequest];const ee=/\[([a-zA-Z0-9_./]+)\]/;function te(e){let t=ee.exec(e);if(t)return e.replace(t[0],"")}class ie extends q{constructor(){super(),this._wrapS=V.CLAMP_TO_EDGE,this._wrapT=V.CLAMP_TO_EDGE,this._width=0,this._height=0}static _gen1pxColorTexture2D(e){let t=new ie;return t.setFormat(V.RGBA,32856),t.setDataType(V.UNSIGNED_BYTE),t.setData(1,1,new Uint8Array(e)),t}static get White(){return ie._White||(ie._White=this._gen1pxColorTexture2D([255,255,255,255])),ie._White}static get Normal(){return ie._Normal||(ie._Normal=this._gen1pxColorTexture2D([127,127,255,255])),ie._Normal}static get Black(){return ie._Black||(ie._Black=this._gen1pxColorTexture2D([0,0,0,255])),ie._Black}static get BrdfLUT(){if(!ie._BrdfLUT){let e=new ie;e.setBase64Url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAACXBIWXMAAA7EAAAOxAGVKw4bAABCp2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxMzIgNzkuMTU5Mjg0LCAyMDE2LzA0LzE5LTEzOjEzOjQwICAgICAgICAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iCiAgICAgICAgICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgICAgICAgICAgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIgogICAgICAgICAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgICAgICAgICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgICAgICAgICAgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIgogICAgICAgICAgICB4bWxuczpleGlmPSJodHRwOi8vbnMuYWRvYmUuY29tL2V4aWYvMS4wLyI+CiAgICAgICAgIDx4bXA6Q3JlYXRvclRvb2w+QWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoTWFjaW50b3NoKTwveG1wOkNyZWF0b3JUb29sPgogICAgICAgICA8eG1wOkNyZWF0ZURhdGU+MjAxNy0xMS0yM1QxMTowOTowNiswODowMDwveG1wOkNyZWF0ZURhdGU+CiAgICAgICAgIDx4bXA6TW9kaWZ5RGF0ZT4yMDE5LTAzLTIzVDAwOjI3OjEzKzA4OjAwPC94bXA6TW9kaWZ5RGF0ZT4KICAgICAgICAgPHhtcDpNZXRhZGF0YURhdGU+MjAxOS0wMy0yM1QwMDoyNzoxMyswODowMDwveG1wOk1ldGFkYXRhRGF0ZT4KICAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9wbmc8L2RjOmZvcm1hdD4KICAgICAgICAgPHBob3Rvc2hvcDpDb2xvck1vZGU+MzwvcGhvdG9zaG9wOkNvbG9yTW9kZT4KICAgICAgICAgPHBob3Rvc2hvcDpEb2N1bWVudEFuY2VzdG9ycz4KICAgICAgICAgICAgPHJkZjpCYWc+CiAgICAgICAgICAgICAgIDxyZGY6bGk+eG1wLmRpZDo2ODU2ZTM4YS05Y2E5LTRlNjUtOWJjNC1hMzYwOGQ5NTBjZTQ8L3JkZjpsaT4KICAgICAgICAgICAgPC9yZGY6QmFnPgogICAgICAgICA8L3Bob3Rvc2hvcDpEb2N1bWVudEFuY2VzdG9ycz4KICAgICAgICAgPHhtcE1NOkluc3RhbmNlSUQ+eG1wLmlpZDo0NzZiYTZmNy0wODMwLTQ5NmUtOTU5MC0wNTk0ZTVmZWU4OTE8L3htcE1NOkluc3RhbmNlSUQ+CiAgICAgICAgIDx4bXBNTTpEb2N1bWVudElEPmFkb2JlOmRvY2lkOnBob3Rvc2hvcDo4NDJlMjY5Ny04ZDRkLTExN2MtYmRjOS1lYTZhNTZlNmVhMTI8L3htcE1NOkRvY3VtZW50SUQ+CiAgICAgICAgIDx4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ+eG1wLmRpZDo2ODU2ZTM4YS05Y2E5LTRlNjUtOWJjNC1hMzYwOGQ5NTBjZTQ8L3htcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD4KICAgICAgICAgPHhtcE1NOkhpc3Rvcnk+CiAgICAgICAgICAgIDxyZGY6U2VxPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5jcmVhdGVkPC9zdEV2dDphY3Rpb24+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDppbnN0YW5jZUlEPnhtcC5paWQ6Njg1NmUzOGEtOWNhOS00ZTY1LTliYzQtYTM2MDhkOTUwY2U0PC9zdEV2dDppbnN0YW5jZUlEPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6d2hlbj4yMDE3LTExLTIzVDExOjA5OjA2KzA4OjAwPC9zdEV2dDp3aGVuPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6c29mdHdhcmVBZ2VudD5BZG9iZSBQaG90b3Nob3AgQ0MgMjAxNS41IChNYWNpbnRvc2gpPC9zdEV2dDpzb2Z0d2FyZUFnZW50PgogICAgICAgICAgICAgICA8L3JkZjpsaT4KICAgICAgICAgICAgICAgPHJkZjpsaSByZGY6cGFyc2VUeXBlPSJSZXNvdXJjZSI+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDphY3Rpb24+c2F2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0Omluc3RhbmNlSUQ+eG1wLmlpZDozZTY0NjQxZC05OTc4LTQwZTYtYTlhZS00ZDU5YmRiNzBjYWE8L3N0RXZ0Omluc3RhbmNlSUQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDp3aGVuPjIwMTktMDMtMjNUMDA6MjU6NDYrMDg6MDA8L3N0RXZ0OndoZW4+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpzb2Z0d2FyZUFnZW50PkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE1LjUgKE1hY2ludG9zaCk8L3N0RXZ0OnNvZnR3YXJlQWdlbnQ+CiAgICAgICAgICAgICAgICAgIDxzdEV2dDpjaGFuZ2VkPi88L3N0RXZ0OmNoYW5nZWQ+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5jb252ZXJ0ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnBhcmFtZXRlcnM+ZnJvbSBpbWFnZS9wbmcgdG8gaW1hZ2UvanBlZzwvc3RFdnQ6cGFyYW1ldGVycz4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPmRlcml2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnBhcmFtZXRlcnM+Y29udmVydGVkIGZyb20gaW1hZ2UvcG5nIHRvIGltYWdlL2pwZWc8L3N0RXZ0OnBhcmFtZXRlcnM+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5zYXZlZDwvc3RFdnQ6YWN0aW9uPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6aW5zdGFuY2VJRD54bXAuaWlkOjQ0NDFkZmZmLTk3ZTUtNGMwMy04OWVmLTYzZWQ0MmU1YzA3MTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxOS0wMy0yM1QwMDoyNTo0NiswODowMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoTWFjaW50b3NoKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6YWN0aW9uPmRlcml2ZWQ8L3N0RXZ0OmFjdGlvbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnBhcmFtZXRlcnM+Y29udmVydGVkIGZyb20gaW1hZ2UvanBlZyB0byBpbWFnZS9wbmc8L3N0RXZ0OnBhcmFtZXRlcnM+CiAgICAgICAgICAgICAgIDwvcmRmOmxpPgogICAgICAgICAgICAgICA8cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmFjdGlvbj5zYXZlZDwvc3RFdnQ6YWN0aW9uPgogICAgICAgICAgICAgICAgICA8c3RFdnQ6aW5zdGFuY2VJRD54bXAuaWlkOjQ3NmJhNmY3LTA4MzAtNDk2ZS05NTkwLTA1OTRlNWZlZTg5MTwvc3RFdnQ6aW5zdGFuY2VJRD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OndoZW4+MjAxOS0wMy0yM1QwMDoyNzoxMyswODowMDwvc3RFdnQ6d2hlbj4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OnNvZnR3YXJlQWdlbnQ+QWRvYmUgUGhvdG9zaG9wIENDIDIwMTUuNSAoTWFjaW50b3NoKTwvc3RFdnQ6c29mdHdhcmVBZ2VudD4KICAgICAgICAgICAgICAgICAgPHN0RXZ0OmNoYW5nZWQ+Lzwvc3RFdnQ6Y2hhbmdlZD4KICAgICAgICAgICAgICAgPC9yZGY6bGk+CiAgICAgICAgICAgIDwvcmRmOlNlcT4KICAgICAgICAgPC94bXBNTTpIaXN0b3J5PgogICAgICAgICA8eG1wTU06RGVyaXZlZEZyb20gcmRmOnBhcnNlVHlwZT0iUmVzb3VyY2UiPgogICAgICAgICAgICA8c3RSZWY6aW5zdGFuY2VJRD54bXAuaWlkOjQ0NDFkZmZmLTk3ZTUtNGMwMy04OWVmLTYzZWQ0MmU1YzA3MTwvc3RSZWY6aW5zdGFuY2VJRD4KICAgICAgICAgICAgPHN0UmVmOmRvY3VtZW50SUQ+YWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjg0MmUyNjk3LThkNGQtMTE3Yy1iZGM5LWVhNmE1NmU2ZWExMjwvc3RSZWY6ZG9jdW1lbnRJRD4KICAgICAgICAgICAgPHN0UmVmOm9yaWdpbmFsRG9jdW1lbnRJRD54bXAuZGlkOjY4NTZlMzhhLTljYTktNGU2NS05YmM0LWEzNjA4ZDk1MGNlNDwvc3RSZWY6b3JpZ2luYWxEb2N1bWVudElEPgogICAgICAgICA8L3htcE1NOkRlcml2ZWRGcm9tPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpYUmVzb2x1dGlvbj45NjAwMDAvMTAwMDA8L3RpZmY6WFJlc29sdXRpb24+CiAgICAgICAgIDx0aWZmOllSZXNvbHV0aW9uPjk2MDAwMC8xMDAwMDwvdGlmZjpZUmVzb2x1dGlvbj4KICAgICAgICAgPHRpZmY6UmVzb2x1dGlvblVuaXQ+MjwvdGlmZjpSZXNvbHV0aW9uVW5pdD4KICAgICAgICAgPGV4aWY6Q29sb3JTcGFjZT42NTUzNTwvZXhpZjpDb2xvclNwYWNlPgogICAgICAgICA8ZXhpZjpQaXhlbFhEaW1lbnNpb24+MzI8L2V4aWY6UGl4ZWxYRGltZW5zaW9uPgogICAgICAgICA8ZXhpZjpQaXhlbFlEaW1lbnNpb24+MzI8L2V4aWY6UGl4ZWxZRGltZW5zaW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PqGFTIQAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAABCRJREFUeNqcltuO3EYMRE+RLW28SJwbAuTX85EJAttAvCM1Kw9s7c7acWC4H4RpaURWV5FF6Y+hmzjsCScccBhbhlO2KTOFTVkFwCmfAJrYpsDIYDxZWzBQMHYhSHGaBEGA+1kxhTs6TFyAtKHCtvqmofAE0X/rCCpcMEYYK1Ha0cmM5QkUB3JIdkc3sl2ooGS7by5AfS2IKxMwhhilA1IElkkxzYBKBppFwRAlppEpXKJkTPMAOqH3zZVRIfDYRUUFTIdQLCXKBlGuFqCPvEJIBpeqxfJiv5cX9pVsbFKJqn6LgDCwiCxp4e3Yws8K4tKiSBc/3NGlpijlCE0hO0yZFCmdLZExsmx7mkokMQ2g+7hqqfsQxcsaO5ScwZwK7CRLA27QJCIVgcoSE8sVYCypy1Mu+y4m95sxUtOWCTHQxBmukoRxWRZ2o8SBjdRFvqLqLp7uritByKt+E4owp0g5TcEhppBQgb1axBhCK3TTrbsccbcdSjBRqGxhKYrq9hGRnoUtrogSlAXWgi8RAlN+CR0oADzUqKRAto0tRcnG5YRS62ZMBE1m9ku+8FoFxol0nSkgYDBQXTx69bu4DMVXhUguN94U2WBjCSoIE+s94uIqYVRKga8ebVAkTCsVE2wLGYeYYLLRCeG2FrXNuEuXvOrIMJx2rVZxwSRsrE3LVhzap7NkcHidTwwTMKxLBuNFS6EEIavG3FaTUHAClJTVuhAQkwFKohiGWLYXgJRmXBRpVTIshQkY5y6XXeRJgCaEayIImVIGibKcIrxEjoZnBU4slOtgCMalXVrj2ChLkyOcp7Yg5zISyYEDtYARBIxJmmHa5SRA6VdNEJcCwuPjG7msg5jMpE72ExrjSRrhKGUyzChGoCJZ0ymNtSLaz753pRHjn+9cZQU5GdMEgUI2qBQm7UyPk80MkdVuSBbyBVY8y985BBIy4+Mb14RBnjzcUBDydlNPL4nN2opN7DBwClkqwuTszlk1mji03P5cTaXx4VFVzoP9IJK88SBhBR6wmZQ3aVePvO5bZxeiljc8+11cPzYoUzA+fM+cjIPHGyMpqDK7BSpSigRb86pBK+VRpHFYJvziz69cGxKPdz+Yk+2AJ/bgoR+YnCghrRkJIQ80mgeQTJfm3SjQ6+irZN+9ZZ483tg3zmAipjkgut6VcohEadIvJADlV0b9n2v89SOaiidumwt0qDY7RSjCKWmNQlkudNnnqhWF1jfXp/RcCf78iYfS40em7CfYKoY0Ljvv0aJuKNaPNYUd1hr/X4gOjL9/5lH1y3vqifmAB6iNqEDWs+P7/6n4MkW/8Wjq1LlT4f5Mo8fkIrjWAT5F+VUZ4/3vzLfMYYctWaw5D2C5v4O+fUX9qgqqe+QLNeGvB/x5Aj/IN2Q9+9TnRHjNzm9Z/w4AQUHVPlcvUTsAAAAASUVORK5CYII="),ie._BrdfLUT=e}return ie._BrdfLUT}static get ODTex(){if(!ie._ODTex){let e=new ie;e.setFormat(V.ALPHA,V.ALPHA),e.setDataType(V.UNSIGNED_BYTE),e.setData(16,16,new Uint8Array(function(e=4){const t=Math.pow(2,e),i=t*t,r=new Array(i),s=[0,1,1,0],n=[0,1,0,1],a=[];for(let t=0;t<e;t++)a.push(Math.pow(2,e-t-1));let o,g,A,I,C=new Uint32Array([0]);for(let h=0;h<i;h++){o=g=0,C[0]=h;for(let t=0;t<e;t++)A=C[0]%4,I=a[t],o+=s[A]*I,g+=n[A]*I,C[0]/=4;r[g*t+o]=h}let h=i/2-1;for(let e=0;e<i;e++)r[e]<h&&r[e]++;return r}(4))),ie._ODTex=e}return ie._ODTex}setUrl(e,t=ie.White,i){this.isUrl&&(J.removeImage(this._url),this._url=null),e&&""!==e&&(this._data=J.loadImage(e,i),this._def=t,this._url=e),this.needsUpdate()}setBase64Url(e,t=ie.White,i){this.isUrl&&(J.removeImage(this._url),this._url=null),this._data=new Image,this._data.src=e,this._def=t,this._url=e,this.needsUpdate()}setData(e,t,i){this.isUrl&&(J.removeImage(this._url),this._url=null),this._width=e,this._height=t,this._data=i,this.needsUpdate()}getImage(){return this._data}getData(){return this._data}getWidth(){return this._width}getHeight(){return this._height}setWarp(e,t){this._wrapS=e,this._wrapT=t,this.needsUpdate()}getWrapS(){return this._wrapS}getWrapT(){return this._wrapT}setSize(e,t){this._width=e,this._height=t,this.needsUpdate()}get loaded(){return!this._url||this._data.complete}getUrl(){return this._url}get isUrl(){return this._url&&""!==this._url}getType(){return 0}destroy(){super.destroy(),this._url&&J.removeImage(this._url)}}class re extends K{constructor(){super(),this._count=1}}class se{constructor(){this.blendFunc=[V.ONE,V.ZERO,V.ONE,V.ZERO],this.blendEquation=[V.FUNC_ADD,V.FUNC_ADD]}setBlendFunc(e,t,i,r){return this.blendFunc[0]=e,this.blendFunc[1]=t,this.blendFunc[2]=i,this.blendFunc[3]=r,this}setBlendEquation(e,t){return this.blendEquation[0]=e,this.blendEquation[1]=t,this}clone(){let e=new se;return se.Copy(this,e),e}copy(e){return se.Copy(e,this),this}static Copy(e,t){t.setBlendFunc.apply(t,e.blendFunc),t.setBlendEquation.apply(t,e.blendEquation)}}var ne,ae,oe,ge,Ae,Ie,Ce,he;se.DefBlend=new se,function(e){e[e.RT0=0]="RT0",e[e.RT1=1]="RT1",e[e.RT2=2]="RT2",e[e.RT3=3]="RT3",e[e.RT4=4]="RT4",e[e.RT5=5]="RT5",e[e.RT6=6]="RT6",e[e.RT7=7]="RT7",e[e.COLOR=0]="COLOR",e[e.NORMAL=1]="NORMAL",e[e.DEPTH=2]="DEPTH"}(ne||(ne={})),function(e){e[e.NONE=0]="NONE",e[e.TEST=1]="TEST",e[e.BLEND=2]="BLEND"}(ae||(ae={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.DOUBLE=3]="DOUBLE"}(oe||(oe={})),ge||(ge={}),function(e){e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D"}(Ae||(Ae={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Ie||(Ie={})),Ce||(Ce={}),he||(he={});class _e{constructor(){this.stencilMask=255,this.stencilBackMask=255,this.stencilFunc=[V.FRONT,V.ALWAYS,0,1],this.stencilBackFunc=[V.BACK,V.ALWAYS,0,1],this.stencilOp=[V.FRONT,V.KEEP,V.KEEP,V.KEEP],this.stencilBackOp=[V.BACK,V.KEEP,V.KEEP,V.KEEP]}setStencilMask(e,t=oe.DOUBLE){t!==oe.DOUBLE&&t!==oe.FRONT||(this.stencilMask=e),t!==oe.DOUBLE&&t!==oe.BACK||(this.stencilBackMask=e)}setStencilFunc(e,t,i,r=oe.DOUBLE){if(r===oe.DOUBLE||r===oe.FRONT){let r=this.stencilFunc;r[1]=e,r[2]=t,r[3]=i}if(r===oe.DOUBLE||r===oe.BACK){let r=this.stencilBackFunc;r[1]=e,r[2]=t,r[3]=i}}setStencilOp(e,t,i,r=oe.DOUBLE){if(r===oe.DOUBLE||r===oe.FRONT){let r=this.stencilOp;r[1]=e,r[2]=t,r[3]=i}if(r===oe.DOUBLE||r===oe.BACK){let r=this.stencilBackOp;r[1]=e,r[2]=t,r[3]=i}}clone(){let e=new _e;return _e.Copy(this,e),e}copy(e){return _e.Copy(e,this),this}static Copy(e,t){t.stencilMask=e.stencilMask,t.stencilBackMask=e.stencilBackMask;for(let i=1;i<4;i++)t.stencilFunc[i]=e.stencilFunc[i],t.stencilBackFunc[i]=e.stencilBackFunc[i],t.stencilOp[i]=e.stencilOp[i],t.stencilBackOp[i]=e.stencilBackOp[i]}}_e.DefStencil=new _e;class le{constructor(){}static _getTextures(){return le._textures}static _getUniforms(){return le._uniforms}static _getAttributes(){return le._attributes}static _inTex(e){const t=le,i=t._dbg?e:t._tid++;return t._textures[e]=i,i}static _inUni(e){const t=le,i=t._dbg?e:t._uid++;return t._uniforms[e]=i,i}static _inAtt(e){const t=le,i=t._dbg?e:t._aid++;return t._attributes[e]=i,i}}le._tid=0,le._textures={},le._uid=0,le._uniforms={},le._aid=0,le._attributes={},le._dbg=!0,le.position=le._inAtt("a_position"),le.texcoord=le._inAtt("a_texcoord"),le.texcoord1=le._inAtt("a_texcoord1"),le.normal=le._inAtt("a_normal"),le.tangent=le._inAtt("a_tangent"),le.binomial=le._inAtt("a_binomial"),le.color=le._inAtt("a_color"),le.joints=le._inAtt("a_joints"),le.weights=le._inAtt("a_weights"),le.texcoord2=le._inAtt("a_texcoord2"),le.texcoord3=le._inAtt("a_texcoord3"),le.baseColorMap=le._inTex("u_baseColorMap"),le.depthMap=le._inTex("u_depthMap"),le.diffuseMap=le._inTex("u_diffuseMap"),le.normalMap=le._inTex("u_normalMap"),le.specularMap=le._inTex("u_specularMap"),le.roughnessMap=le._inTex("u_roughnessMap"),le.metallicMap=le._inTex("u_metallicMap"),le.aoMap=le._inTex("u_aoMap"),le.emissiveMap=le._inTex("u_emissiveMap"),le.cartoonLUTMap=le._inTex("u_cartoonLUTMap"),le.brdfLUTMap=le._inTex("u_brdfLUTMap"),le.lumMap=le._inTex("u_lumMap"),le.bloomMap=le._inTex("u_bloomMap"),le.randomMap=le._inTex("u_randomMap"),le.cmMap=le._inTex("u_cmMap"),le.testTexture3DMap=le._inTex("u_testTexture3DMap"),le.ODMap=le._inTex("u_ODMap"),le.irradianceMap=le._inTex("u_irradianceMap"),le.prefilterMap=le._inTex("u_prefilterMap"),le.ODSizeInv=le._inUni("u_ODSizeInv"),le.uvOffset=le._inUni("u_uvOffset"),le.baseColor=le._inUni("u_baseColor"),le.pixelSize=le._inUni("u_pixelSize"),le.pixelDir=le._inUni("u_pixelDir"),le.cameraPos=le._inUni("u_cameraPos"),le.lightColor=le._inUni("u_lightColor"),le.lightPos=le._inUni("u_lightPos"),le.lightDir=le._inUni("u_lightDir"),le.aoScale=le._inUni("u_aoScale"),le.glossiness=le._inUni("u_glossiness"),le.reflectance=le._inUni("u_reflectance"),le.merged=le._inUni("u_merged"),le.merged1=le._inUni("u_merged1"),le.merged2=le._inUni("u_merged2"),le.merged3=le._inUni("u_merged3"),le.specular=le._inUni("u_specular"),le.lumPCT=le._inUni("u_lumPCT"),le.multiUsing=le._inUni("u_multiUsing"),le.aoParam=le._inUni("u_aoParam"),le.matType=le._inUni("u_matType"),le.cameraRange=le._inUni("u_cameraRange"),le.odOffset=le._inUni("u_odOffset"),le.uvTransform=le._inUni("u_uvTransform"),le.mMat=le._inUni("u_mMat"),le.mITMat=le._inUni("u_mITMat"),le.mIMat=le._inUni("u_mIMat"),le.vMat=le._inUni("u_vMat"),le.vIMat=le._inUni("u_vIMat"),le.vITMat=le._inUni("u_vITMat"),le.pMat=le._inUni("u_pMat"),le.pIMat=le._inUni("u_pIMat"),le.mvMat=le._inUni("u_mvMat"),le.vpMat=le._inUni("u_vpMat"),le.vpIMat=le._inUni("u_vpIMat"),le.mvpMat=le._inUni("u_mvpMat"),le.depthMat=le._inUni("u_depthMat");class ue extends l{constructor(){super(),this._shader=new re,this.enableDepth=!0,this.depthMask=!0,this.enablePolygonOffset=!1,this.polygonOffset=[0,0],this._textures=new Map,this._properties=new Map}setTexture2DFromUrl(e,t,i){t&&""!==t||this._textures.set(e,i||ie.White);let r=new ie;r.setUrl(t,i),this.setTexture(e,r)}setTexture(e,t=ie.White){if(!t)return;let i=this._textures.get(e);i&&i.isUrl&&i.release(),t.isUrl&&t.retain(),this._textures.set(e,t)}removeTexture(e){let t=this._textures.get(e);t&&t.isUrl&&(t.release(),this._textures.delete(e))}removeClassTexture(e){}setProperty(e,t){this._properties.set(e,t)}removeProperty(e){this._properties.delete(e)}getProperty(e){return this._properties.get(e)}getTexture(e){return this._textures.get(e)}set alphaType(e){this._alphaType=e}disalbeAlpha(){this.removeTexture(le.ODMap),this._removeMacro("ALPHA_TEST"),this._alphaType=ae.NONE}enableAlphaTest(){this.setTexture(le.ODMap,ie.ODTex);let e=Math.floor(256*Math.random());this.setProperty(le.odOffset,{data:new Float32Array([Math.floor(e/16),Math.floor(e%16)])}),this._addMacro("ALPHA_TEST"),this._alphaType=ae.TEST}enableAlphaBlend(){this.removeTexture(le.ODMap),this._removeMacro("ALPHA_TEST"),this._alphaType=ae.BLEND}get alphaTest(){return this._alphaType===ae.TEST}get alphaBlend(){return this._alphaType===ae.BLEND}get alphaType(){return this._alphaType||ae.NONE}setCullFaceMode(e){this._faceMode=e}get faceMode(){return this._faceMode||V.BACK}setFlipFace(e){this._flipFace=e}get filpFace(){return this._flipFace||!1}setBlend(e,t=!1){t?this._blend?this._blend.copy(e):this._blend=e.clone():this._blend=e}get blend(){return this._blend||se.DefBlend}_checkCreateBlend(){let e=this._blend;return e||(e=new se,this._blend=e),e}setBlendFunc(e,t,i,r){let s=this._checkCreateBlend();s.setBlendFunc.apply(s,arguments)}get blendFunc(){return this._blend?this._blend.blendFunc:se.DefBlend.blendFunc}setBlendEquation(e,t){let i=this._checkCreateBlend();i.setBlendEquation.apply(i,arguments)}get blendEquation(){return this._blend?this._blend.blendEquation:se.DefBlend.blendEquation}set enableStencil(e){this._enableStencil=e}get enableStencil(){return this._enableStencil}setStencil(e,t=!1){t?this._stencil?this._stencil.copy(e):this._stencil=e.clone():this._stencil=e}get stencil(){return this._stencil||_e.DefStencil}_checkCreateStencil(){let e=this._stencil;return e||(e=new _e,this._stencil=e),e}setStencilFunc(e,t,i,r=oe.DOUBLE){let s=this._checkCreateStencil();s.setStencilFunc.apply(s,arguments)}setStencilOp(e,t,i,r=oe.DOUBLE){let s=this._checkCreateStencil();s.setStencilOp.apply(s,arguments)}set depthFunc(e){this._depthFunc=e}get depthFunc(){return this._depthFunc||V.LESS}clearProperties(){this._properties.clear()}clearTextures(){this._textures.forEach(e=>{e.release()}),this._textures.clear()}_addMacro(e,t){let i=this._macros;i||(i={},this._macros=i),i[e]=t,this._computeKey()}_removeMacro(e){let t=this._macros;t&&(delete t[e],0===Object.keys(t).length&&delete this._macros,this._computeKey())}_computeKey(){let e=this._macros;if(!e)return void(this._key=null);let t=""+this.type;for(let i in e){let r=e[i];t+=void 0!==r?`_${i} ${r}`:`_${i}`}this._key=t}get key(){return this._key||this.type}get type(){return""}get shader(){return this._shader}clone(){}getMacros(){return this._macros}setDepthMap(e){this.setTexture(le.depthMap,e)}setDepthMatData(e){this.setProperty(le.depthMat,e)}setNormalMap(e){this.supportNormalMap&&e&&e!==ie.Normal&&(this._addMacro("NORMAL_MAP"),this.setTexture(le.normalMap,e))}removeNormalMap(){this.supportNormalMap&&(this._removeMacro("NORMAL_MAP"),this.removeTexture(le.normalMap))}setPointLights(e,t,i){if(this.supportLighting){if(e<=0)return this._removeMacro("POINT_LIGHT"),this.removeProperty("u_pointPos"),void this.removeProperty("u_pointColors");this._addMacro("POINT_LIGHT",e),this.setProperty("u_pointPos",t),this.setProperty("u_pointColors",i)}}setDirLights(e,t,i){if(this.supportLighting){if(e<=0)return this._removeMacro("DIRECTION_LIGHT"),this.removeProperty("u_directionDirs"),void this.removeProperty("u_directionColors");this._addMacro("DIRECTION_LIGHT",e),this.setProperty("u_directionDirs",t),this.setProperty("u_directionColors",i)}}setSpotLights(e,t,i,r){if(this.supportLighting){if(e<=0)return this._removeMacro("SPOT_LIGHT"),this.removeProperty("u_spotPos"),this.removeProperty("u_spotDirs"),void this.removeProperty("u_spotColors");this._addMacro("SPOT_LIGHT",e),this.setProperty("u_spotPos",t),this.setProperty("u_spotDirs",i),this.setProperty("u_spotColors",r)}}setDirShadowLights(e,t,i,r,s){if(this.supportShadow){if(e<=0)return this._removeMacro("DIRECTION_SHADOW_LIGHT"),this.removeProperty("u_directionShadowDirs"),this.removeProperty("u_directionShadowColors"),void this.removeProperty("u_directionMats");this._addMacro("DIRECTION_SHADOW_LIGHT",e),this.setProperty("u_directionShadowDirs",t),this.setProperty("u_directionShadowColors",i),this.setProperty("u_directionMats",r);for(let t=0;t<e;t++)this.setTexture(`u_directionShadowMaps_${t}`,s[t])}}setSpotShadowLights(e,t,i,r,s,n,a){if(this.supportShadow){if(e<=0)return this._removeMacro("SPOT_SHADOW_LIGHT"),this.removeProperty("u_spotShadowPos"),this.removeProperty("u_spotShadowDirs"),this.removeProperty("u_spotShadowColors"),this.removeProperty("u_spotRanges"),void this.removeProperty("u_spotMats");this._addMacro("SPOT_SHADOW_LIGHT",e),this.setProperty("u_spotShadowPos",t),this.setProperty("u_spotShadowDirs",i),this.setProperty("u_spotShadowColors",r),this.setProperty("u_spotRanges",s),this.setProperty("u_spotMats",n);for(let t=0;t<e;t++)this.setTexture(`u_spotShadowMaps_${t}`,a[t])}}setPointShadowPCF(e){if(this.supportShadow&&e)for(let t=0,i=e.length;t<i;t++)e[t]?this._addMacro(`POINT_SHADOW_PCF_${t}`):this._removeMacro(`POINT_SHADOW_PCF_${t}`)}setPointShadowLights(e,t,i,r,s){if(this.supportShadow){if(e<=0)return this._removeMacro("POINT_SHADOW_LIGHT"),this.removeProperty("u_pointShadowPos"),this.removeProperty("u_pointShadowColors"),void this.removeProperty("u_pointRanges");this._addMacro("POINT_SHADOW_LIGHT",e),this.setProperty("u_pointShadowPos",t),this.setProperty("u_pointShadowColors",i),this.setProperty("u_pointRanges",r);for(let t=0;t<e;t++)this.setTexture(`u_pointShadowMaps_${t}`,s[t])}}setBaseColor(e,t,i,r){}getBaseColor(){return null}get supportNormalMap(){return!1}get supportShadow(){return!1}get supportLighting(){return!1}get supportDeferred(){return!1}destroy(){this._shader.release(),this._textures.forEach(e=>{e.release()})}}class ce extends ue{constructor(e){super(),this._baseColor=new f,this.setTexture2DFromUrl(le.diffuseMap,e),this.setProperty(le.baseColor,this._baseColor),this._baseColor.set(1,1,1,1)}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}clone(){}get type(){return"diffuse"}}class de extends ue{constructor(e){super(),this._baseColor=new f,e?this._baseColor.copy(e):this._baseColor.set(1,1,1,1),this.setProperty(le.baseColor,this._baseColor)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}get type(){return"color"}}const pe=[{target:new m(1,0,0),up:new m(0,0,-1)},{target:new m(-1,0,0),up:new m(0,0,-1)},{target:new m(0,0,1),up:new m(0,-1,0)},{target:new m(0,0,-1),up:new m(0,1,0)},{target:new m(0,-1,0),up:new m(0,0,-1)},{target:new m(0,1,0),up:new m(0,0,-1)}];class me extends q{constructor(){super(),this._wrapS=V.CLAMP_TO_EDGE,this._wrapT=V.CLAMP_TO_EDGE,this._wrapR=V.CLAMP_TO_EDGE,this._texture2ds=[void 0,void 0,void 0,void 0,void 0,void 0]}static _gen1pxColorTextureCube(e){let t=new me;return t.setFormat(V.RGBA,V.RGBA),t.setDataType(V.UNSIGNED_BYTE),t.setTexture2ds(e,e,e,e,e,e),t}static get White(){return me._White||(me._White=me._gen1pxColorTextureCube(ie.White)),me._White}static get Black(){return me._Black||(me._Black=me._gen1pxColorTextureCube(ie.Black)),me._Black}setWarp(e,t){this._wrapS=e,this._wrapT=t,this.needsUpdate()}setTexture2ds(e,t,i,r,s,n){this._texture2ds[0]=e||this._texture2ds[0],this._texture2ds[1]=t||this._texture2ds[1],this._texture2ds[2]=i||this._texture2ds[2],this._texture2ds[3]=r||this._texture2ds[3],this._texture2ds[4]=s||this._texture2ds[4],this._texture2ds[5]=n||this._texture2ds[5],this.needsUpdate()}getTexture2ds(){return this._texture2ds}getWrapS(){return this._wrapS}getWrapT(){return this._wrapT}getWrapR(){return this._wrapR}getType(){return 1}setAllSize(e,t){this._texture2ds.forEach(i=>{i.setSize(e,t)})}destroy(){super.destroy(),this._texture2ds.forEach(e=>{e&&e.destroy()})}}class fe extends ue{constructor(e=ie.White,t=ie.Normal,i=ie.White,r=ie.White,s=ie.White,n=me.Black,a=me.Black){super(),this._baseColor=new f(1,1,1,1),this._specular=new m(1,1,1),this._uvOffset=new f(1,1,0,0),this.setTexture(le.diffuseMap,e),this.setNormalMap(t),this.setTexture(le.roughnessMap,i),this.setTexture(le.metallicMap,r),this.setTexture(le.aoMap,s),this.setTexture(le.irradianceMap,n),this.setTexture(le.prefilterMap,a),this.setTexture(le.brdfLUTMap,ie.BrdfLUT),this.setProperty(le.baseColor,this._baseColor),this.setProperty(le.specular,this._specular),this.setProperty(le.uvOffset,this._uvOffset)}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}setIrradianceMap(e){this.setTexture(le.irradianceMap,e)}setPrefilterMap(e){this.setTexture(le.prefilterMap,e)}setBrdfLUTMap(e){this.setTexture(le.brdfLUTMap,e)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}getBaseColor(){return this._baseColor}clone(){}setSpecular(e,t,i){this._specular.set(e,t,i)}setUVOffset(e,t,i,r){this._uvOffset.set(e,t,i,r)}get supportNormalMap(){return!0}get supportShadow(){return!0}get supportLighting(){return!0}get type(){return"standard"}get supportDeferred(){return!0}}class Te extends ue{constructor(e,t,i){super(),this.param=new f,this.setTexture2DFromUrl(le.baseColorMap,e),this.setTexture2DFromUrl(le.specularMap,t),this.setTexture2DFromUrl(le.emissiveMap,i),this.setTexture(le.cartoonLUTMap,Te.getCartoonStyleLUT()),this.reflectance=1,this.aoScale=1,this.glossiness=1,this.setProperty(le.merged,this.param)}get glossiness(){return this.param.v[0]}set glossiness(e){this.param.v[0]=e}get aoScale(){return this.param.v[1]}set aoScale(e){this.param.v[1]=e}get reflectance(){return this.param.v[2]}set reflectance(e){this.param.v[2]=e}get type(){return"cartoon"}static getCartoonStyleLUT(){if(!this._cartoonLUTMap){let e=new Uint8Array(64);for(let t=0;t<2;t++)0==t?(e[4*t]=51,e[4*t+1]=51,e[4*t+2]=51,e[4*t+3]=255,e[16+4*t]=255,e[16+4*t+1]=255,e[16+4*t+2]=255,e[16+4*t+3]=255,e[32+4*t]=178.5,e[32+4*t+1]=178.5,e[32+4*t+2]=178.5,e[32+4*t+3]=255,e[48+4*t]=102,e[48+4*t+1]=102,e[48+4*t+2]=102,e[48+4*t+3]=255):1==t&&(e[4*t]=51,e[4*t+1]=51,e[4*t+2]=51,e[4*t+3]=255,e[16+4*t]=255,e[16+4*t+1]=255,e[16+4*t+2]=255,e[16+4*t+3]=255,e[32+4*t]=204,e[32+4*t+1]=204,e[32+4*t+2]=204,e[32+4*t+3]=255,e[48+4*t]=153,e[48+4*t+1]=153,e[48+4*t+2]=153,e[48+4*t+3]=255);let t=new ie;t.setData(4,4,e),t.setFormat(V.RGBA,V.RGBA),this._cartoonLUTMap=t}return this._cartoonLUTMap}}class Ee extends ue{constructor(){super()}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}clone(){}get type(){return"skybox"}}class ve extends ue{constructor(e){super(),this._referMat=e}setReferMaterial(e){this._referMat=e,this.clearTextures(),this.clearProperties()}overrideProperty(e,t){super.setProperty(e,t)}overrideTexture(e,t){super.setTexture(e,t)}getProperty(e){let t=super.getProperty(e);return t||(t=this._referMat.getProperty(e)),t}getTexture(e){let t=super.getTexture(e);return t||(t=this._referMat.getTexture(e)),t}setUVOffset(e,t,i,r){let s=super.getProperty(le.uvOffset);s?s.v.set([arguments]):this.setProperty(le.uvOffset,new f(e,t,i,r))}get depthFunc(){return this._depthFunc||this._referMat.depthFunc}get alphaType(){return void 0===this._alphaType?this._referMat.alphaType:this._alphaType}get blend(){return this._blend||this._referMat.blend}get enableStencil(){return void 0===this._enableStencil?this._referMat.enableStencil:this._enableStencil}getMacros(){return this._referMat.getMacros()}enableShadow(){this._referMat._addMacro("SHADOW_MAP")}disableShadow(){this._referMat._removeMacro("SHADOW_MAP")}get stencil(){return this._stencil||this._referMat.stencil}get type(){return this._referMat.type}get supportDeferred(){return this._referMat.supportDeferred}}class Re extends ue{constructor(e){super(),this._baseColor=new f,this._texSize=new m(128,128,256),this._clim={data:new Float32Array([0,.5,.2])},e?this._baseColor.copy(e):this._baseColor.set(1,1,1,1),this.setProperty(le.baseColor,this._baseColor),this.setProperty("u_clim",this._clim),this.setProperty("u_texSize",this._texSize),this.setTexture(le.cmMap,ie.White)}setCmTexture(e){this.setTexture(le.cmMap,e)}setTexture3D(e){this._tex3D=e,this.setTexture("u_testTexture3DMap",e),this._texSize.set(e.width,e.height,e.depth)}setMaxStepDepth(e){this._addMacro("MAX_STEP_DEPTH",e)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}get type(){return"texture3d_test"}}class Me extends l{constructor(){super(),this._position=new m,this._rotate=new T,this._scale=new m(1,1,1),this._matrix=new E,this._visible=!0,this._parent=null,this._children=[],this._needsUpdate=!0}addChild(e){e&&e._parent!==this&&e.setParent(this)}removeChild(e){e&&e._parent===this&&e.setParent(null)}getChildren(){return this._children}enableUpdateMat(){this._needsUpdate=!0}_update(e,t){}update(e,t=!1){this._animater&&this._animater.update(e);let i=this._needsUpdate||t;this._makeMatrix(i),this._update(e,i);let r=this._children.length,s=this._children;for(let t=0;t<r;t++)s[t].update(e,i);i&&this._updateBounding()}lookAt(e,t){}setPositionAt(e){this._position.set(e.x,e.y,e.z),this.enableUpdateMat()}setPosition(e,t,i){this._position.set(e,t,i),this.enableUpdateMat()}getPosition(){return this._position}setRotateAt(e){this._rotate.setAt(e),this.enableUpdateMat()}setRotate(e,t,i,r){this._rotate.set(e,t,i,r),this.enableUpdateMat()}getRotate(){return this._rotate}setScaleAt(e){this._scale.set(e.x,e.y,e.z),this.enableUpdateMat()}setScale(e,t,i){this._scale.set(e,t,i),this.enableUpdateMat()}getScale(){return this._scale}getMatrix(){return this._matrix}_makeMatrix(e=!1){(this._needsUpdate||e)&&(this._matrix.compose(this._position,this._rotate,this._scale),this._parent&&this._matrix.premultiply(this._parent.getMatrix()),this._needsUpdate=!1)}_updateBounding(){this._bounding}set visible(e){this._visible=e}get visible(){return this._visible}setParent(e){if(this._parent!==e){if(this._parent){let e=this._parent._children;e.splice(1,e.indexOf(this))}e?e._children.push(this):this._preCleanup(),this._parent=e}}getParent(){return this._parent}beRendering(){return!1}getBounding(){return this._bounding}_preCleanup(){this._destroy()}_destroy(){this.event(B.DESTROTY,[this])}set x(e){this._position.x!==e&&(this.enableUpdateMat(),this._position.x=e)}get x(){return this._position.x}set y(e){this._position.y!==e&&(this.enableUpdateMat(),this._position.y=e)}get y(){return this._position.y}set z(e){this._position.z!==e&&(this.enableUpdateMat(),this._position.z=e)}get z(){return this._position.z}set rotateZ(e){}get rotateZ(){}get isCamera(){return!1}get isLight(){return!1}get isMesh(){return!1}get isScene(){return!1}get animater(){return this._animater}set animater(e){this._animater=e}raycast(e,t){}toJson(e){let t=super.toJson(e);t.position=this._position.toJson(),t.rotate=this._rotate.toJson(),t.scale=this._scale.toJson(),t.visible=this.visible;const i=[];return this._children.forEach(e=>{i.push(e.toJson())}),t.children=i,t}fromJson(e){}}var Se,xe,Ne,ye;Me.prototype.lookAt=function(){const e=new T,t=new E,i=new m,r=new m;return function(s,n){const a=this._parent;this._makeMatrix(!0),i.copy(s),r.setFromMatrixPosition(this._matrix),this.isCamera||this.isLight?t.lookAtR(r,i,n||m.ZUp):t.lookAtR(i,r,n||m.ZUp),this._rotate.setFromRotationMatrix(t),a&&(t.extractRotation(a.getMatrix()),e.setFromRotationMatrix(t),this._rotate.premultiply(e.invert())),this.enableUpdateMat()}}(),function(e){e[e.None=0]="None",e[e.Direction=1]="Direction",e[e.Point=2]="Point",e[e.Spot=3]="Spot"}(Se||(Se={}));class Oe extends Me{constructor(){super(),this._color=new f(1,1,1,1)}setColor(e,t,i){const r=this._color;r.set(e,t,i,r.w)}enableShadow(){}disableShadow(){}clearShadow(){}get shadow(){return null}setScale(e,t,i){}setScaleAt(e){}getScale(){return m.One}get pos(){return this._position}get isLight(){return!0}get color(){return this._color}get type(){return 0}}Oe.DefDir=new m(0,0,1),Oe.LumFactor=new f(.27,.67,.06,0);class De{constructor(){this.enalbed=!0}get depthTex(){return null}init(){}get type(){return Se.None}destroy(){}}class Fe{constructor(){this.isClearColor=!0,this.clearColor=new f(1,1,1,1),this.isClearDepth=!0,this.clearDepth=0,this.isClearStencil=!1,this.clearStencil=0,this.viewport=new f,this.needClear=!0}setClearColor(e,t){this.isClearColor=!0===e,t&&this.clearColor.copy(t)}setClearDepth(e,t){this.isClearDepth=!0===e,t&&(this.clearDepth=t)}setClearStencil(e,t){this.isClearStencil=!0===e,t&&(this.clearStencil=t)}setViewportAt(e){this.viewport.copy(e)}setViewports(e,t,i,r){this.viewport.set(e,t,i,r)}}!function(e){e[e.TEXTURE_2D=0]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=1]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=2]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=3]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=4]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=5]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=6]="TEXTURE_CUBE_MAP_NEGATIVE_Z"}(xe||(xe={}));class we extends K{constructor(){super(),this._textures=new Map,this._width=64,this._height=64,this._isFollowScreen=!1,this._depthStencilTexture=void 0,this._state=new Fe,this._needsUpdateSize=!1}update(){this._needsUpdateSize&&(this._needsUpdateSize=!1)}addTexture(e,t,i,r,s,n){t=t||V.RGBA,i=i||V.UNSIGNED_BYTE;let a=this._createTexture2d(t,n||t,i);a.setFilter(r,s),this._textures.set(e,{tex:a,target:xe.TEXTURE_2D}),this.needsUpdate()}setTexture2D(e,t){this._textures.set(e,{tex:t,target:xe.TEXTURE_2D}),this.needsUpdate()}setTextureCube(e,t,i){this._textures.set(e,{tex:t,target:i})}getState(){return this._state}getDepthStencilTexture(){return this._depthStencilTexture}_createTexture2d(e,t,i){let r=new ie;return r.setSize(this._width,this._height),r.setFormat(e,t),r.setDataType(i),r}enableDepthStencil(){this._state.setClearDepth(!0),this._state.setClearStencil(!0);let e=this._createTexture2d(V.DEPTH_STENCIL,V.DEPTH24_STENCIL8,V.UNSIGNED_INT_24_8);e.setFilter(V.LINEAR,V.LINEAR),this._depthStencilTexture=e,this.needsUpdate()}setDepthStencil(e){this._depthStencilTexture=e,this._state.setClearDepth(!0),this._state.setClearStencil(!0),this.needsUpdate()}setNeedsDepthStencil(e){this._needsDepthStencil=!0===e}isNeedsDepthStencil(){return this._needsDepthStencil}isFollowScreen(){return this._isFollowScreen}setFollowScreen(e){this._isFollowScreen=!0===e}_updateTextureSize(){const e=this._width,t=this._height;this._depthStencilTexture&&this._depthStencilTexture.setSize(e,t),this._textures.forEach((function(i,r){let s=i.tex;s instanceof ie&&s.setSize(e,t)}))}setSize(e,t){this._width===e&&this._height===t||(this._width=e,this._height=t,this._updateTextureSize(),this._state.setViewports(0,0,e,t),this.needsUpdate())}getWidth(){return this._width}getHeight(){return this._height}setOffset(e){this._state.setViewportAt(e)}getTextureFromType(e){return this._textures.get(e)}getTextureMap(){return this._textures}setClearColor(e){this._state.setClearColor(!0,e)}}class be extends De{constructor(){super(),this._size=512,this.range=200,this.far=2e3,this.autoRange=!1,this.matrix=new E}init(e=512){this._size=e;let t=this._depthTex;t||(t=new ie,t.setDataType(V.UNSIGNED_BYTE),t.setFilter(V.LINEAR,V.LINEAR),this._depthTex=t),t.setSize(e,e);let i=this.frame;i||(i=new we,i.setTexture2D(ne.COLOR,t),i.enableDepthStencil(),i.getState().clearColor.set(1,1,1,1),this.frame=i),i.setSize(e,e)}get depthTex(){return this._depthTex}set size(e){this._size=e,this._depthTex&&this._depthTex.setSize(e,e)}get size(){return this._size}get type(){return Se.Direction}}class Le extends Oe{constructor(){super(),this._dir=(new m).normalize(),this.setPosition(150,200,200);let e=m.pubTemp.set(1,1,1.5).normalize();this.setDirection(e)}setPosition(e,t,i){super.setPosition(e,t,i)}setDir(e,t,i){let r=m.pubTemp.set(e,t,i).normalize();this.setDirection(r)}setDirection(e){this._rotate.rotationTo(Oe.DefDir,e),this._dir.set(0,0,1),this._dir.applyQuaternion(this._rotate).normalize()}get dir(){return this._dir}enableShadow(){this._shadow||(this._shadow=new be,this._shadow.init()),this._shadow.enalbed=!0}disableShadow(){this._shadow&&(this._shadow.enalbed=!1)}clearShadow(){this._shadow&&(this._shadow.destroy(),this._shadow=null)}get shadow(){return this._shadow}get type(){return 1}get isDirectionLight(){return!0}}class Pe extends De{constructor(){super(),this.pcf=!1}_createTex2D(){let e=new ie;return e.setDataType(V.UNSIGNED_BYTE),e.setFilter(V.NEAREST,V.NEAREST),e}init(e=128){this._size=e;let t=this._depthTex;t||(t=new me,t.setDataType(V.UNSIGNED_BYTE),t.setFilter(V.NEAREST,V.NEAREST),t.setTexture2ds(this._createTex2D(),this._createTex2D(),this._createTex2D(),this._createTex2D(),this._createTex2D(),this._createTex2D()),this._depthTex=t),t.setAllSize(e,e);let i=this._frames;if(!i){i=[];for(let r=0;r<6;r++){let s=new we;s.setSize(e,e),s.setTextureCube(ne.COLOR,t,xe.TEXTURE_CUBE_MAP_POSITIVE_X+r),s.enableDepthStencil(),s.getState().clearColor.set(1,1,1,1),i.push(s)}this._frames=i}}get depthTex(){return this._depthTex}get type(){return Se.Point}get frames(){return this._frames}}class Ue extends Oe{constructor(){super(),this._bounding=new Z,this.setFactor(.9375)}_updateBounding(){let e=this._bounding;e.setPositionAt(this._position),e.setRadius(this._radius)}setColor(e,t,i){super.setColor(e,t,i)}setFactor(e){this._color.w=Math.min(e,1),this._radius=Math.sqrt(1/(1-e))}enableShadow(){this._shadow||(this._shadow=new Pe,this._shadow.init()),this._shadow.enalbed=!0}disableShadow(){this._shadow&&(this._shadow.enalbed=!1)}clearShadow(){this._shadow&&(this._shadow.destroy(),this._shadow=null)}get shadow(){return this._shadow}get radius(){return this._radius}get type(){return Se.Point}get isPointLight(){return!0}}class Be extends De{constructor(){super(),this._size=512,this.matrix=new E}init(e=256){this._size=e;let t=this._depthTex;t||(t=new ie,t.setDataType(V.UNSIGNED_BYTE),t.setFilter(V.NEAREST,V.NEAREST),this._depthTex=t),t.setSize(e,e);let i=this.frame;i||(i=new we,i.setTexture2D(ne.COLOR,t),i.enableDepthStencil(),i.getState().clearColor.set(1,1,1,1),this.frame=i),i.setSize(e,e)}get depthTex(){return this._depthTex}set size(e){this._size=e,this._depthTex&&this._depthTex.setSize(e,e)}get size(){return this._size}get type(){return Se.Spot}}class ze extends Oe{constructor(){super(),this._dir=new m,this._angle=0,this._bounding=new X,this.setFactor(.9375)}setDir(e,t,i){let r=m.pubTemp.set(e,t,i).normalize();this.setDirection(r)}setDirection(e){this._rotate.rotationTo(Oe.DefDir,e),this._dir.set(0,0,1),this._dir.applyQuaternion(this._rotate).normalize()}setRotate(e,t,i,r){super.setRotate(e,t,i,r),this._dir.set(0,0,-1).applyQuaternion(this._rotate)}setRotateAt(e){super.setRotateAt(e),this._dir.set(0,0,-1).applyQuaternion(this._rotate)}setColor(e,t,i){super.setColor(e,t,i)}setFactor(e){this.color.w=Math.min(e,1),this._radius=Math.sqrt(1/(1-e))}_updateBounding(){let e=this._angle,t=this._bounding,i=this._radius;if(e<=.5*Math.PI){let r=Math.sin(e)*i;t.setMax(r,r,0),t.setMin(-r,-r,-i)}else{let r=Math.cos(e);t.setMax(i,i,-r*i),t.setMax(-i,-i,-i)}this._bounding.applyMatrix(this._matrix)}get type(){return Se.Spot}enableShadow(){this._shadow||(this._shadow=new Be,this._shadow.init()),this._shadow.enalbed=!0}disableShadow(){this._shadow&&(this._shadow.enalbed=!1)}clearShadow(){this._shadow&&(this._shadow.destroy(),this._shadow=null)}get shadow(){return this._shadow}set angle(e){this._angle=e}get angle(){return this._angle}get dir(){return this._dir}get radius(){return this._radius}get isSpotLight(){return!1}}class Ge{constructor(e,t,i,r=V.FLOAT){this.attribType=e,this.num=t,this.offset=i,this.type=r}}class He extends K{constructor(){super(),this._type=V.FLOAT,this._attributes=[],this._stride=0,this._isIndex=!1}setParameter(e,t,i){this._stride=e,this._usage=t,this._type=i}setData(e,t=V.FLOAT){this._data=e instanceof Array?new Float32Array(e):e,this._type=t||He.TypeMap[e.constructor.name]}getData(){return this._data}addAttribute(e){this._attributes.push(e)}addAttributeData(e,t,i=0,r){let s=new Ge(e,t,i,r||this._type);this._attributes.push(s)}setType(e){this._type=e||this._type}getType(){return this._type}getLength(){return this._data.length}getByteLength(){return this._data.byteLength}findAttribute(e){let t=this._attributes,i=t.length;for(let r=0;r<i;r++){let i=t[r];if(i.attribType===e)return i}return null}getAttributes(){return this._attributes}getStride(){return this._stride}getUsage(){return this._usage}setIsIndex(e){this._isIndex=e}isIndex(){return this._isIndex}}He.TypeMap={Float32Array:V.FLOAT,Uint32Array:V.UNSIGNED_INT,Int32Array:V.INT,Uint16Array:V.UNSIGNED_SHORT,Int16Array:V.SHORT,Uint8Array:V.UNSIGNED_BYTE,Int8Array:V.BYTE},function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Ne||(Ne={}));class Ve extends K{constructor(){super(),this._drawParameter=void 0,this._display=!0,this._buffers=[]}addSingleAttribute(e,t,i,r,s,n=V.STATIC_DRAW){let a=new He,o=new Ge(t,i,0,r);a.addAttribute(o),a.setData(s),a.setParameter(0,n,r),this._buffers.push(a),t===le.position&&(this._posAttrib=o,this._posBuffer=a)}addMultiAttribute(e,t,i,r,s=V.STATIC_DRAW){let n=new He;n.setData(r),this._buffers.push(n),n.setParameter(i,s,t),e.forEach(e=>{let t=new Ge(e.attribute,e.num,e.offset,e.type);n.addAttribute(t),e.attribute===le.position&&(this._posAttrib=t,this._posBuffer=n)})}setIndexData(e,t=V.UNSIGNED_SHORT,i=V.STATIC_DRAW){let r=new He;r.setData(e),r.setParameter(0,i,t),r.setIsIndex(!0),this._indexBuffer=r}getIndexBuffer(){return this._indexBuffer}setDrawParameter(e,t=V.TRIANGLES,i=0){this._drawParameter={mode:t||V.TRIANGLES,count:e||0,offset:i||0}}getPosAttrib(){return this._posAttrib}getPosBuffer(){return this._posBuffer}getBuffers(){return this._buffers}getDrawParameter(){return this._drawParameter}getBounding(){return void 0===this._bounding&&this.buildBounding(),this._bounding}removeBounding(){this._bounding=null}buildBounding(){if(!this._posAttrib||!this._posBuffer)return;const e=this._posBuffer,t=this._posAttrib,i=e.getData(),r=0===e.getStride()?t.num:e.getStride()/i.BYTES_PER_ELEMENT,s=t.offset,n=t.num;let a=new m,o=new m;a.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);let g=new m;if(this._indexBuffer){const e=this._indexBuffer.getData(),t=e.length;let A;for(let I=0;I<t;I++)A=e[I]*r+s,g.set(i[A],i[A+1],2===n?0:i[A+2]),a.min(g),o.max(g)}else{const e=i.length/r;let t;for(let A=0;A<e;A++)t=A*r+s,g.set(i[t],i[t+1],2===n?0:i[t+2]),a.min(g),o.max(g)}let A=new X;A.setMinAt(a),A.setMaxAt(o),this._bounding=A}destroy(){}}class We extends q{constructor(){super(),this._wrapS=V.CLAMP_TO_EDGE,this._wrapT=V.CLAMP_TO_EDGE,this._wrapR=V.CLAMP_TO_EDGE}setWrap(e,t,i){this._wrapS=e,this._wrapT=t,this._wrapR=i}setData(e,t,i,r,s,n,a){this._width=e,this._height=t,this._depth=i,this._dataType=n,this.setFormat(r,s),this._data=a}setSubData(e,t,i,r,s,n,a){let o=this._data,g=this._width,A=this._height;for(let I=0;I<n;I++)for(let n=0;n<s;n++)for(let C=0;C<r;C++)o[g*A*(I+i)+A*(n+t)+C+e]=a[r*s*I+s*n+C];this.needsUpdate()}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get data(){return this._data}get wrapS(){return this._wrapS}get wrapT(){return this._wrapT}get wrapR(){return this._wrapR}getType(){return 3}}!function(e){e[e.Orthographic=0]="Orthographic",e[e.Perspective=1]="Perspective"}(ye||(ye={}));const ke=new m;class Xe extends Me{constructor(e,t,i,r,s){super(),this._type=ye.Perspective,this._projection=new E,this._viewProjection=new E,this._matrixInverse=new E,this._projectionInverse=new E;let n=.5*(e||800),a=.5*(t||600);this._far=s||2e3,this._near=r||1,this._left=-n,this._right=n,this._bottom=-a,this._top=a,this._fovy=i||Math.PI/4,this._aspect=n/a,this._projectionFunc=this._makePerspectiveMatrix.bind(this)}_update(e,t){t&&(this._matrixInverse.getInvert(this._matrix),this.makeProjectionMatrix(),this.makeViewProjectionMatrix())}enableOrthographicMode(e,t,i,r,s,n){this._projectionFunc=this._makeOrthographicMatrix,this._type=ye.Orthographic,this._left=e||this._left,this._right=t||this._right,this._bottom=i||this._bottom,this._top=r||this._top,this._near=s||this._near,this._far=n||this._far,this.resize(t-e,r-i)}enablePerspectiveMode(e,t,i,r){this._projectionFunc=this._makePerspectiveMatrix,this._type=ye.Perspective,this._fovy=e||this._fovy,this._aspect=t||this._aspect;let s=Math.abs(this._top-this._bottom),n=s*t;this._near=i,this._far=r,this.resize(n,s)}makeProjectionMatrix(){this._projectionFunc()}_makeOrthographicMatrix(){this._projection.orthographic(this._left,this._right,this._bottom,this._top,this._near,this._far),this._makeProjectionInverseMatrix()}_makePerspectiveMatrix(){this._projection.perspective(this._fovy,this._aspect,this._near,this._far),this._makeProjectionInverseMatrix()}_makeProjectionInverseMatrix(){this._projectionInverse.getInvert(this._projection)}getProjectionMatrix(){return this._projection}makeViewProjectionMatrix(){let e=this._viewProjection;e.copy(this._projection),e.multiply(this.getViewMatrix())}getViewProjectionMatrix(){return this._viewProjection}getViewMatrix(){return this._matrixInverse}getViewInverseMatrix(){return this._matrix}getProjectionInverseMatrix(){return this._projectionInverse}getWorldDir(e){e||(e=new m),this._makeMatrix();const t=this._matrix.m;return e.set(-t[8],-t[9],-t[10]).normalize()}resize(e,t){let i=.5*(this._right-this._left)+this._left,r=.5*(this._top-this._bottom)+this._bottom,s=.5*e,n=.5*t;this._left=i-s,this._right=i+s,this._bottom=r-n,this._top=r+n,this._aspect=e/t,this._needsUpdate=!0,this._projectionFunc(),this.update(0,!0)}forwardStep(e){const t=m.pool.create();this.getWorldDir(t),t.mul(e),this._addPosCenter(t)}horizontalStep(e){this.getWorldDir(ke),ke.mul(e),ke.crossAt(m.ZUp),this._addPosCenter(ke)}verticalStep(e){this._position.z+=e,this.enableUpdateMat()}_addPosCenter(e){this._position.addAt(e),this.enableUpdateMat()}get type(){return this._type}get fovy(){return this._fovy}get aspect(){return this._aspect}get far(){return this._far}get near(){return this._near}get isCamera(){return!0}}const Ye=A,je={Transform:Ye(),Geometry:Ye(),Material:Ye(),Camera:Ye(),Light:Ye(),Skeleton:Ye()};class Ze extends l{constructor(e,t){super(),this._object=e,this._type=t}update(e){this._object.update(e)}getObject(){return this._object}getType(){return this._type}setEntity(e){this._entity=e}getEntity(){return this._entity}static CreateTransfromComponent(e){return new Ze(e,je.Transform)}static CreateGeometryComponent(e){return new Ze(e,je.Geometry)}static CreateMaterialComponent(e){return new Ze(e,je.Material)}static CreateCameraComponent(e){return new Ze(e,je.Camera)}static CreateLightComponent(e){return new Ze(e,je.Light)}}class Ke extends l{constructor(){super(),this._parent=void 0,this._children=[],this._components=new Map}update(e){this._components.forEach((function(t,i){t.update(e)}))}addComponent(e){if(e instanceof Ze){if(void 0!==e.getEntity())return;switch(e.getType()){case je.Transform:this.transform=e.getObject();break;case je.Geometry:this.geometry=e.getObject();break;case je.Material:this.material=e.getObject();break;case je.Camera:this.camera=e.getObject();break;case je.Light:this.light=e.getObject()}e.setEntity(this),this._components.set(e.getType(),e)}}getComponent(e){return this._components.get(e)}getComponentObject(e){let t=this._components.get(e);return void 0!==t?t.getObject():void 0}removeComponent(e){e instanceof Ze&&this.removeFromType(e.getType())}removeFromType(e){let t=this.getComponent(e);if(t instanceof Ze){switch(e){case je.Transform:this.transform=void 0;break;case je.Geometry:this.geometry=void 0;break;case je.Material:this.material=void 0;break;case je.Camera:this.camera=void 0;break;case je.Light:this.light=void 0}t.setEntity(void 0),this._components.delete(e)}}canBeRendering(){return void 0!==this.geometry&&void 0!==this.material}addChild(e){this._children.push(e)}setParent(e){this._parent=e}getParent(e){return this._parent}static createRenderableEntity(e,t,i){let r=new Ke;return r.addComponent(Ze.CreateGeometryComponent(e)),r.addComponent(Ze.CreateMaterialComponent(t)),r.addComponent(Ze.CreateTransfromComponent(i)),r}}class qe extends Me{constructor(){super(),this.castShadow=!0,this.receiveShadow=!0}setGeometry(e){this._geometry&&this._geometry.destroy(),this._geometry=e}getGeometry(){return this._geometry}setMaterial(e){this._material&&this._material.destroy(),this._material=e}getMaterial(){return this._material}beRendering(){return!(!this._geometry||!this._material)}_updateBounding(){let e=this._geometry.getBounding();e&&(this._bounding&&this._bounding.getType()===e.getType()?(this._bounding.copy(e),this._bounding.applyMatrix(this._matrix)):(this._bounding=e.clone(),this._bounding.applyMatrix(this._matrix)))}get isMesh(){return!0}_destroy(){this._material&&this._material.destroy(),this._geometry&&this._geometry.destroy()}}qe.prototype.raycast=function(){const e=new E,t=new R,i=new U,r=i.p1,s=i.p2,n=i.p3,a=new m,o=new m;return function(g,A){const I=this._geometry,C=this._material;if(!I||!C)return;const h=C.faceMode,_=C.filpFace;if(h===V.FRONT_AND_BACK)return;if(this._bounding&&!this._bounding.intersectRay(g.ray))return;let l=!0;h&&h!==V.ZERO||(l=!1);let u=!1;(h===V.FRONT&&!_||h===V.BACK&&_)&&(u=!0);const c=I.getPosBuffer();if(!c)return;let d;c.getAttributes().forEach(e=>{e.attribType===le.position&&(d=e)}),t.copy(g.ray),t.applyMatrix4(e.getInvert(this._matrix));const p=I.getIndexBuffer(),m=c.getData(),f=d.offset/m.BYTES_PER_ELEMENT,T=c.getStride()/m.BYTES_PER_ELEMENT||d.num,E=d.num>2,v=I.getDrawParameter().mode;if(v===Ne.TRIANGLES)if(p){const e=p.getData();for(let I=0,C=e.length;I<C;I+=3){let C=e[I]*T+f,h=e[I+1]*T+f,_=e[I+2]*T+f;if(u){let e=h;h=_,_=e}if(r.set(m[C],m[C+1],E?m[C+2]:0),s.set(m[h],m[h+1],E?m[h+2]:0),n.set(m[_],m[_+1],E?m[_+2]:0),t.intersectTriangle(r,s,n,l,a)){i.computeNormal(o),a.applyMatrix4(this._matrix);let e=a.distanceTo(g.ray.origin);if(e<g.near||e>g.far)continue;A.push({target:a.clone(),normal:o.clone(),object:this,distance:e})}}}else for(let e=0,I=m.length;e<I;e+=3*T){let I=e+f;if(r.set(m[I],m[I+1],m[I+2]),I=u?e+2*T+f:e+T+f,s.set(m[I],m[I+1],m[I+2]),I=u?e+T+f:e+2*T+f,n.set(m[I],m[I+1],m[I+2]),t.intersectTriangle(r,s,n,l,a)){i.computeNormal(o),a.applyMatrix4(this._matrix);let e=a.distanceTo(g.ray.origin);if(e<g.near||e>g.far)continue;A.push({target:a.clone(),normal:o.clone(),object:this,distance:e})}}else Ne.LINES}}();class Qe extends qe{constructor(){super(),this._pointsList=[],this._needUpdateLines=!1;let e=new de;this._material=e;let t=new Ve;this.setGeometry(t)}setMaterial(e){}drawBox(e){for(let e=0;e<2;e++)for(let e=0;e<2;e++)for(let e=0;e<2;e++);}setPoints(e,t=3){if(!e||e.length<2)return;const i=[];for(let r=0,s=e.length;r<s;r+=t)i.push(e[r],e[r+1],t>2?e[r+2]:0);this._pointsList.push({points:i}),this._setNeedUpdateLines()}_setNeedUpdateLines(){this._needUpdateLines=!0,this._needsUpdate=!0}_update(e,t){super._update(e,t),this._needUpdateLines&&(this._needUpdateLines=!1,this._updateLinesData())}_updateLinesData(){let e=[],t=[],i=0;this._pointsList.forEach(r=>{const s=r.points;t.push(i++),e.push(s[0],s[1],s[2]);for(let r=3,n=s.length;r<n;r+=3)t.push(i),e.push(s[r],s[r+1],s[r+2]),t.push(i++);t.pop()}),this._geometry.addSingleAttribute("Position",le.position,3,V.FLOAT,new Float32Array(e)),this._geometry.setIndexData(new Uint16Array(t)),this._geometry.setDrawParameter(t.length,Ne.LINES,0),this._geometry.buildBounding()}}class Je extends Me{constructor(){super(),this._mainLight=new Le,this.addChild(this._mainLight),this._mainLight.name="mainLight"}getMainLight(){return this._mainLight}setActiveCamera(e){this._activeCamera=e}getActiveCamera(){return this._activeCamera}get isScene(){return!0}}class $e{constructor(){this._loadState=$e.State.NONE,this._entity=void 0}getLoadState(){return this._loadState}getEntity(){return this._loadState===$e.State.LOAD_COMPLETE?this._entity:void 0}load(e,t){this._changeState($e.State.LOADING_FILE),new Promise((t,i)=>{let r=new XMLHttpRequest;r.onreadystatechange=()=>{if(4==r.readyState)if(200==r.status){r.responseXML;t(r.responseXML)}else i(new Error(r.statusText))},r.open("GET",e,!0),r.send(null)}).then(e=>{this._changeState($e.State.CREATE_ENTITY),t("document",e),this._entity=this._loadVertices(e),this._entity||(this._changeState($e.State.LOAD_ERROR),t("error","file error")),this._changeState($e.State.LOAD_COMPLETE),t("entity",this._entity)}).catch(e=>{this._changeState($e.State.LOAD_ERROR),t("error",e)})}_changeState(e){this._loadState=e}_loadFromDoc(e){}_loadVertices(e){let t=e=>{if(!e)return;let t=e.id,i=e.getElementsByTagName("float_array")[0],r=e.getElementsByTagName("accessor")[0];if(!i||!r)return;let s=r.getAttribute("count"),n=r.getAttribute("stride");if(!s||!n)return;let a=i.textContent.split(" ");return{id:t,count:s,stride:parseInt(n),array:a,type:V.FLOAT}},i=i=>{let r=i.getAttribute("source"),s=i.getAttribute("semantic"),n=i.getAttribute("offset");if(!r||!s)return;let a=void 0;r="#"===r[0]?r.substr(1):r;let o=e.getElementById(r);switch(o.tagName){case"source":a=t(o);break;case"vertices":a=(i=>{if(!i)return;let r=i.getElementsByTagName("input")[0];if(!r)return;let s=r.getAttribute("semantic"),n=r.getAttribute("source");if(!s||!n)return;n="#"===n[0]?n.substr(1):n;let a=e.getElementById(n);return t(a)})(o)}return a?{semantic:s,offset:parseInt(n),data:a}:void 0},r=e.getElementsByTagName("library_geometries")[0];if(!r)return;let s=r.children;if(0===s.length)return;let n=s[0].children[0];if(!n)return;let a=n.getElementsByTagName("triangles")[0];if(!a)return;let o=a.getAttribute("count"),g=a.getElementsByTagName("input"),A=[],I=[];for(let e=0;e<g.length;e++){let t=i(g[e]);if(!t)return;A.push(t),I.push([])}let C=g.length,h=a.getElementsByTagName("p")[0];if(!h)return;let _=h.textContent.split(" "),l=new Map,u=[],c=0;for(let e=0;e<3*o;e++){let t=3*e,i="";for(let e=0;e<C;e++)i+=_[t+e]+" ";let r=l.get(i);if(r)u.push(r);else{for(let e=0;e<C;e++){let i=A[e].offset,r=A[e].data,s=_[t+i],n=r.array,a=I[e];for(let e=0;e<r.stride;e++){let t=n[3*s+e];a.push(t)}}l.set(i,c),u.push(c),c++}}if(u.length>65535)return;let d=new Ve;for(let e=0;e<C;e++){let t=A[e],i=I[e],r=t.semantic,s=t.data,n=void 0;switch(s.type){case V.FLOAT:n=new Float32Array(i)}let a=void 0;switch(r){case"POSITION":case"VERTEX":a=le.position;break;case"NORMAL":a=le.normal;break;case"TEXCOORD":a=le.texcoord;for(let e=0;e<n.length/s.stride;e++){let t=n[e*s.stride+1];n[e*s.stride+1]=1-t}}d.addSingleAttribute(r,a,s.stride,s.type,n)}return d.setIndexData(new Uint16Array(u)),d.setDrawParameter(u.length),d}}$e.State={NONE:"none",LOADING_FILE:"loading",CREATE_ENTITY:"createEntity",LOAD_COMPLETE:"loadComplete",LOAD_ERROR:"loadError"};let et=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];class tt{constructor(e,t){this.url=e,e&&this.load(e,t)}load(e,t){this.url=e,J.loadUrl(e).then(e=>{this._loadFromResponseText(e).then(e=>(t&&t("entity",e),e))})}_loadFromResponseText(e){const t=JSON.parse(e),i=this.url.substring(0,this.url.lastIndexOf("/")+1);return t.urlDir=i,t.promising={},Object.keys(t).forEach(e=>{const i=tt["pre_"+e];i&&i(t)}),Promise.all(Object.values(t.promising)).then(()=>(c.info("glTF.promising load complete"),c.info(t),this._loadGltfJson(t)))}_loadGltfJson(e){return["bufferViews","accessors","meshes","nodes","scenes","scene"].forEach(t=>{const i=tt[t];i&&i(e)}),e.cge_geometries}}Object.assign(tt,{meshes:e=>{const t=e.meshes,i=e.accessors,r=[];Object.keys(t).forEach(e=>{const s=t[e];s.name;s.primitives&&s.primitives.forEach(e=>{if(!e.attributes)return;let t=(e=>{let t=new Ve;const r=e.attributes;Object.keys(r).forEach(e=>{let s=void 0;const n=r[e],a=i[n];switch(e){case"POSITION":s=le.position;break;case"NORMAL":s=le.normal;break;case"TEXCOORD":case"TEXCOORD_0":s=le.texcoord;break;case"TANGENT":s=le.tangent;break;case"JOINT":case"JOINT_0":s=le.joints;break;case"WEIGHT":case"WEIGHT_0":s=le.weights}null!=s&&t.addSingleAttribute(e,s,a.strideCount,a.componentType,a.data)});let s=[V.POINTS,V.LINES,V.LINE_LOOP,V.LINE_STRIP,V.TRIANGLES,V.TRIANGLE_STRIP,V.TRIANGLE_FAN],n=e.mode?s[e.mode]:V.TRIANGLES;if(e.indices){const r=i[e.indices];t.setIndexData(r.data),t.setDrawParameter(r.data.length,n)}else{const i=e.attributes.POSITION||e.attributes.TEXCOORD||e.attributes.TEXCOORD_0;t.setDrawParameter(i.count/i.strideCount,n)}return t})(e);t&&r.push(t)}),s.extensions}),e.cge_geometries=r},accessors:e=>{const t={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},i=e.accessors;Object.keys(i).forEach(r=>{const s=i[r],n=e.bufferViews[s.bufferView].data,a=s.byteOffset,o=s.count;s.strideCount=t[s.type],s.data=((e,t,i,r,s)=>{switch(e){case 5120:t=new Int8Array(t,i,r*s);break;case 5121:t=new Uint8Array(t,i,r*s);break;case 5122:t=new Int16Array(t,i,r*s);break;case 5123:t=new Uint16Array(t,i,r*s);break;case 5126:t=new Float32Array(t,i,r*s)}return t})(s.componentType,n,a,o,s.strideCount),s.extensions})},bufferViews:e=>{const t=e.bufferViews;Object.keys(t).forEach(i=>{const r=t[i],s=e.buffers[r.buffer];s&&(r.data=s.data.slice(r.byteOffset,r.byteOffset+(r.byteLength||0)),r.extensions)})},pre_buffers:e=>{const t=e.buffers;Object.keys(t).forEach(i=>{const r=t[i];let s=r.uri;if(new RegExp("data:[\\S]+;base64,").test(s))r.data=function(e){let t,i,r,s,n,a,o,g;o=e.length,n=0,g="";let A=new Uint8Array(Math.ceil(3*o/4));for(a=0;n<o;){do{t=et[255&e.charCodeAt(n++)]}while(n<o&&-1==t);if(-1==t)break;do{i=et[255&e.charCodeAt(n++)]}while(n<o&&-1==i);if(-1==i)break;g+=String.fromCharCode(t<<2|(48&i)>>4),A[a++]=t<<2|(48&i)>>4;do{if(r=255&e.charCodeAt(n++),61==r)return A.buffer;r=et[r]}while(n<o&&-1==r);if(-1==r)break;g+=String.fromCharCode((15&i)<<4|(60&r)>>2);do{if(s=255&e.charCodeAt(n++),61==s)return A.buffer;s=et[s]}while(n<o&&-1==s);if(-1==s)break;g+=String.fromCharCode((3&r)<<6|s),A[a++]=t<<2|(48&i)>>4}return A.buffer}(s.split(",")[1]);else{new J;e.promising[i]=J.loadUrl(e.urlDir+s,r.type||"text").then(e=>{r.data=e})}})},pre_images:e=>{const t=e.images;Object.keys(t).forEach(e=>{t[e]})}});class it{constructor(){this._reObj=/^o/,this._reGroup=/^g/,this._reMtllib=/^mtllib /,this._reUsemtl=/^usemtl /,this._reSmooth=/^s /,this._reVertexPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this._reNormalPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this._reUvPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this._reFaceSpaces=/f\s+(([\d]{1,}[\s]?){3,})+/,this._reFaceVU=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this._reFaceVUN=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this._reFaceVN=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,this.posData=[],this.uvData=[],this.normalData=[],this.tangentData=[],this.indexData=[]}load(e){return J.loadUrl(e).then(e=>this.parseData(e))}parseData(e){return this._meshes=[],this._materialNamesAll=[],this._lines=e.split("\n"),this._lineIdx=0,this._posRawTot=0,this._uvRawTot=0,this._normalTot=0,this._numVertices=0,this._numFaces=0,this._posRawArray=[],this._uvRawArray=[],this._normalRawArray=[],this._mtlPath=null,this.createMesh(),this._mesh}resetRawArray(){this._posRawTot+=this._posRawArray.length/3,this._uvRawTot+=this._uvRawArray.length/2,this._normalTot+=this._normalRawArray.length/3,this._posRawArray=[],this._uvRawArray=[],this._normalRawArray=[]}createMesh(){let e,t,i,r,s,n,a,o,g,A=new Array,I=new Array,C=new Array,h=new Array,_=new Object,l=new Array,u=0,c=0,d=0,p=!1,m=!1,f=e=>{if(null==_[e]){_[e]=u;let t,i,r=e.split("/"),s=parseInt(r[0])-1;t=""!=r[1]?parseInt(r[1])-1:null,i=null!=r[2]?parseInt(r[2])-1:null,l.push({idPos:s,idUV:t,idNormal:i}),u++}h.push(_[e]),++d},T=e=>{let t=e.trim().split(" ");for(let e=0;e<3;e++)f(t[e]);4==t.length&&(f(t[0]),f(t[2]),f(t[3]))},E=this._lines.length;for(let e=this._lineIdx;e<E;e++){let t=this._lines[e];if(t.trim(),0!==t.length&&"#"!==t.charAt(0))if(null!==(o=this._reVertexPattern.exec(t))){if(null!=this._mesh&&h.length>0){p=!0,m=!0,this._lineIdx=e;break}this._posRawArray.push(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]))}else if(null!==(o=this._reNormalPattern.exec(t))){if(null!=this._mesh&&h.length>0){p=!0,m=!0,this._lineIdx=e;break}this._normalRawArray.push(parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]))}else if(null!==(o=this._reUvPattern.exec(t))){if(null!=this._mesh&&h.length>0){p=!0,m=!0,this._lineIdx=e;break}this._uvRawArray.push(parseFloat(o[1]),parseFloat(o[2]))}else if(null!==(o=this._reFaceVUN.exec(t)))T(o[1]);else if(null!==(o=this._reFaceVN.exec(t)))T(o[1]);else if(null!==(o=this._reFaceVU.exec(t)))T(o[1]);else if(null!==(o=this._reFaceSpaces.exec(t))){let e=o[1].trim().split(" ");for(let t=0;t<3;t++){let i=e[t];if(null==_[i]){_[i]=u;let e=parseInt(i)-1,t=e,r=e;l.push({idPos:e,idUV:t,idNormal:r}),u++}h.push(_[i])}d+=3}else if(this._reGroup.test(t)||this._reObj.test(t)){t.substring(2).trim();if(null==this._mesh)this._mesh=new qe,this._materialNames=[];else{if(0!=h.length){this._lineIdx=e,p=!0;break}this._mesh=new qe,this._materialNames=[]}}else if(this._reUsemtl.test(t)){if(g=t.substring(6).trim(),c!=d){let e;null==g||""==g?e=0:(e=this._materialNames.length,this._materialNames.push(g)),c=d}}else this._reMtllib.test(t)?this._mtlPath=t.substring(6).trim():this._reSmooth.test(t)||console.log("Unhandled expression at line : "+t)}if(h.length>0){if(c!=d){let e;null==g||""==g?e=0:(e=this._materialNames.length,this._materialNames.push(g)),c=d}for(let e=0;e<u;e++){let t=l[e].idPos,i=l[e].idUV,r=l[e].idNormal;A.push(this._posRawArray[3*(t-this._posRawTot)],this._posRawArray[3*(t-this._posRawTot)+1],this._posRawArray[3*(t-this._posRawTot)+2]),null!=i&&I.push(this._uvRawArray[2*(i-this._uvRawTot)],this._uvRawArray[2*(i-this._uvRawTot)+1]),null!=r&&C.push(this._normalRawArray[3*(r-this._normalTot)],this._normalRawArray[3*(r-this._normalTot)+1],this._normalRawArray[3*(r-this._normalTot)+2])}e=new Float32Array(A),0!=C.length?(n=!0,i=new Float32Array(C)):n=!1,0!=I.length?(s=!0,t=new Float32Array(I)):(s=!1,console.warn("OBJLoader:...unsupport no uv.")),r=this.getIndicesByPosition(A,h),a=!(!s||!n);let o=new Ve;o.addSingleAttribute("Position",le.position,3,V.FLOAT,e),o.addSingleAttribute("UV",le.texcoord,2,V.FLOAT,t),o.addSingleAttribute("Normal",le.normal,3,V.FLOAT,i),o.setIndexData(r),o.setDrawParameter(r.length),this._mesh.setGeometry(o),this._numVertices+=l.length,this._numFaces+=h.length/3,this._meshes.push(this._mesh),this._materialNamesAll.push(this._materialNames)}p&&(m&&this.resetRawArray(),this.createMesh())}getIndicesByPosition(e,t){let i=e.length/3;return i<=255?new Uint8Array(t):i<=65535?new Uint16Array(t):new Uint32Array(t)}merge(e,t){if(null==e)return t;if(null==t)return e;let i=new Int16Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}get mesh(){return this._mesh}}class rt{constructor(e,t,i){this.moveDelta=2,this.rotateDelta=.005,this._enable=!0,this._camera=e,this._sprite=t,this._timer=i,this._horizontalObj=new Me,this._verticalObj=new Me,this._horizontalObj.addChild(this._verticalObj),this.init()}init(){}rotateFromScreen(e,t){}}const st=new T,nt=new m;class at{constructor(e,t,i){this.moveDelta=2,this.rotateDelta=.005,this._enable=!0,this._camera=e,this._sprite=t,this._timer=i,this._horizontalObj=new Me,this._verticalObj=new Me,this._horizontalObj.addChild(this._verticalObj),this.init()}init(){const e=this._sprite;e.on(B.KEY_DOWN,this,this._onKeyDown),e.on(B.KEY_UP,this,this._onKeyUp),e.on(B.MOUSE_DOWN,this,this._onMouseDown),e.on(B.MOUSE_UP,this,this._onMouseUp),e.on(B.ON_BLUR,this,this.cancel)}dispose(){this.cancel();const e=this._sprite;e.off(B.KEY_DOWN,this,this._onKeyDown),e.off(B.KEY_UP,this,this._onKeyUp),e.off(B.MOUSE_DOWN,this,this._onMouseDown),e.off(B.MOUSE_UP,this,this._onMouseUp),e.off(B.ON_BLUR,this,this.cancel)}resetCamera(e){this.cancel(),this._camera=e}cancel(){const e=this._camera,t=this._timer;t.remove(e,e.forwardStep),t.remove(e,e.horizontalStep),t.remove(e,e.verticalStep)}_onKeyDown(e){const t=this._camera,i=this._timer,r=this.moveDelta;switch(e.key){case"w":i.frameLoop(1,t,t.forwardStep,[r]);break;case"s":i.frameLoop(1,t,t.forwardStep,[-r]);break;case"a":i.frameLoop(1,t,t.horizontalStep,[-r]);break;case"d":i.frameLoop(1,t,t.horizontalStep,[r]);break;case"e":i.frameLoop(1,t,t.verticalStep,[-r]);break;case"q":i.frameLoop(1,t,t.verticalStep,[r])}}_onKeyUp(e){const t=this._camera,i=this._timer;switch(e.key){case"w":case"s":i.remove(t,t.forwardStep);break;case"a":case"d":i.remove(t,t.horizontalStep);break;case"q":case"e":i.remove(t,t.verticalStep)}}_onMouseDown(e){this._sprite.on(B.MOUSE_MOVE,this,this._cameraRotate)}_onMouseUp(e){this._sprite.off(B.MOUSE_MOVE,this,this._cameraRotate)}_cameraRotate(e){let t=this.rotateDelta,i=e.movementX*t,r=e.movementY*t,s=st;nt.set(0,0,1),s.setAxisAngle(nt,-i);let n=this._horizontalObj.getRotate();n.multiply(s),nt.set(1,0,0),s.setAxisAngle(nt,-r),n=this._verticalObj.getRotate(),n.multiply(s),this._horizontalObj.update(0,!0),st.setFromRotationMatrix(this._verticalObj.getMatrix()),this._camera.setRotateAt(st),this._camera.enableUpdateMat(),this._camera.update(0,!0)}}const ot=new E;class gt{constructor(e,t=0,i=1/0){this.far=Number.MAX_VALUE,this.near=0,this.ray=e?e.clone():new R,this.near=t,this.far=i}setRay(e,t){this.ray.set(e,t)}_intersectObject(e,t=[],i=!0){if(!1===e.visible)return t;if(e.raycast(this,t),i){const r=e.getChildren();for(let e=0,s=r.length;e<s;e++)this._intersectObject(r[e],t,i)}return t}intersectObject(e,t=[],i=!0){return this._intersectObject(e,t,i),t.sort((e,t)=>e.distance-t.distance),t}setFromCamera(e,t){const i=this.ray;this.near=t.near,this.far=t.far,t.type===ye.Perspective?(i.origin.setFromMatrixPosition(t.getMatrix()),ot.copy(t.getViewProjectionMatrix()).invert(),i.dir.set(e.x,e.y,.5).applyMatrix4(ot).subAt(i.origin).normalize()):t.type===ye.Orthographic&&(c.warn(""),i.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),i.dir.set(0,0,-1).transformDirection(t.getMatrix()))}}class At extends l{constructor(){super(),this.rendererId=At.RendererNum++,At.Renderers.length<4?At.Renderers.push(this):c.error("Too many renderer instance")}static getRenderer(e){return At.Renderers[e]}removeShader(e){}}At.Renderers=[],At.RendererNum=0;class It extends Ve{constructor(){super(),this.makeTri()}makeTri(){let e=new Float32Array([-1,1,0,1,-1,-3,0,-1,3,1,2,1]),t=[{name:"Position",attribute:le.position,num:2,offset:0},{name:"UV",attribute:le.texcoord,num:2,offset:2*e.BYTES_PER_ELEMENT}];this.addMultiAttribute(t,V.FLOAT,4*e.BYTES_PER_ELEMENT,e),this.setDrawParameter(3)}}class Ct extends Ve{constructor(e=1,t=1,i=1){super(),this._size=new m,this.setBoxParameter(e,t,i)}setBoxParameter(e=1,t=1,i=1){this._size.set(.5*e,.5*t,.5*i),this._createGeo()}_createGeo(){let e=new Float32Array([-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1]),t=[{name:"Position",attribute:le.position,num:3,offset:0}];this.addMultiAttribute(t,V.FLOAT,3*e.BYTES_PER_ELEMENT,e),this.setDrawParameter(36)}}class ht extends Ve{constructor(e=1,t=16,i=16){super(),this._radius=1,this._widthSegments=16,this._heightSegments=16,this.setSphereParameter(e,t,i)}setSphereParameter(e=1,t=16,i=16){this._radius=e,this._widthSegments=t,this._heightSegments=i,this._createGeo()}_createGeo(){let e,t,i=this._radius,r=this._widthSegments,s=this._heightSegments,n=0,a=[],o=[],g=[],A=[],I=[],C=new m,h=new m,_=2*Math.PI,l=Math.PI;for(e=0;e<=s;e++){let o=[],u=e/s;for(t=0;t<=r;t++){let e=t/r;C.x=i*Math.cos(0+e*_)*Math.sin(0+u*l),C.y=i*Math.sin(0+e*_)*Math.sin(0+u*l),C.z=i*Math.cos(0+u*l),g.push(C.x,C.y,C.z),h.set(C.x,C.y,C.z).normalize(),A.push(h.x,h.y,h.z),I.push(e,1-u),o.push(n++)}a.push(o)}for(e=0;e<s;e++)for(t=0;t<r;t++){var u=a[e][t+1],c=a[e][t],d=a[e+1][t],p=a[e+1][t+1];0!==e&&o.push(u,c,p),e!==s-1&&o.push(c,d,p)}let f=$(g,I,A,o);this.addSingleAttribute("Position",le.position,3,V.FLOAT,new Float32Array(g)),this.addSingleAttribute("UV",le.texcoord,2,V.FLOAT,new Float32Array(I)),this.addSingleAttribute("Normal",le.normal,3,V.FLOAT,new Float32Array(A)),this.addSingleAttribute("Tangent",le.tangent,4,V.FLOAT,new Float32Array(f)),this.setIndexData(new Uint16Array(o)),this.setDrawParameter(o.length)}}class _t extends ue{constructor(e){super(),this._baseColor=new f,this.setProperty(le.baseColor,this._baseColor),this._baseColor.set(1,1,1,1),e?this.setTexture(le.diffuseMap,e):this.setTexture(le.diffuseMap,ie.White)}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}get type(){return"fullscreen"}}class lt extends class{constructor(){this._update=!0}needsUpdate(){this._update=!0}updated(){this._update=!1}getUpdate(){return this._update}remove(e){}}{}class ut{constructor(e,t,i,r){this._mode=e,this._offset=t,this._count=i,this._type=r}apply(e){e.drawArrays(this._mode,this._offset,this._count)}}class ct extends ut{constructor(e,t,i,r){super(e,t,i,r)}apply(e){e.drawElements(this._mode,this._count,this._type,this._offset)}}class dt extends lt{constructor(){super(),this._isIndex=!1}setData(e,t,i,r){let s=this._buffer;e.bindBuffer(t,s),e.bufferData(t,i,r),e.bindBuffer(t,null)}generateFromBuffer(e,t){let i=this._buffer;return i||(i=e.createBuffer(),this._buffer=i),this._isIndex=t.isIndex(),this.setData(e,t.isIndex()?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,t.getData(),t.getUsage()),this}getNativeBuffer(){return this._buffer}}const pt=new E,mt=new E,ft=new E,Tt=new E,Et=(new Float32Array(16),new Float32Array(4));class vt extends lt{constructor(){super(),this._textures=new Map,this._attributes=new Map,this._uniforms=new Map,this._macros=[]}_createShaderFromText(e,t,i){let r=e.createShader(t);return e.shaderSource(r,i),e.compileShader(r),0==e.getShaderParameter(r,e.COMPILE_STATUS)?(c.warn(i),c.error(e.getShaderInfoLog(r)),void e.deleteShader(r)):r}_build(e){let t=this._program;this.apply(e);let i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),r=0;this._uniforms.clear(),this._textures.clear();for(let s=0;s<i;s++){let i=e.getActiveUniform(t,s);if(!i)continue;let n=e.getUniformLocation(t,i.name);if(i.type===e.SAMPLER_2D||i.type===e.SAMPLER_CUBE||i.type===e.SAMPLER_3D){let t=le._getTextures();if(void 0!==t[i.name])e.uniform1i(n,r),this._textures.set(t[i.name],r++);else{let t=new Int32Array(i.size),s=te(i.name);for(let e=0,n=i.size;e<n;e++)t[e]=r,this._textures.set(`${s}_${e}`,r++);e.uniform1iv(n,t)}}else{let e=le._getUniforms();if(void 0!==e[i.name])this._uniforms.set(e[i.name],{location:n,type:i.type,name:i.name,size:i.size});else{let e=te(i.name);e?this._uniforms.set(e,{location:n,type:i.type,name:i.name,size:i.size}):this._uniforms.set(i.name,{location:n,type:i.type,name:i.name,size:i.size})}}}let s=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let i=0;i<s;i++){let r=e.getActiveAttrib(t,i),s=e.getAttribLocation(t,r.name);e.enableVertexAttribArray(s);let n=le._getAttributes();this._attributes.set(n[r.name],s)}}_createProgram(e,t,i){let r=e.createProgram();if(e.attachShader(r,t),e.attachShader(r,i),e.linkProgram(r),e.getProgramParameter(r,e.LINK_STATUS))return this._program=r,this._build(e),r;c.error("Could not initialise shaders shader "+e.getProgramInfoLog(r))}_createProgramFromText(e,t,i){let r=this._createShaderFromText(e,e.VERTEX_SHADER,t),s=this._createShaderFromText(e,e.FRAGMENT_SHADER,i);if(void 0===r||void 0===s)return;let n=this._createProgram(e,r,s);return void 0!==n?(e.deleteShader(r),e.deleteShader(s),n):void 0}generateFromText(e,t,i){return this._createProgramFromText(e,t,i)?(this.updated(),this):null}apply(e){vt._curr!==this&&(e.useProgram(this._program),vt._curr=this,vt.curUpdated=!0)}setUniformData(e,t,i,r){switch(t){case V.INT:e.uniform1iv(i,r);break;case V.FLOAT:e.uniform1f(i,r);break;case V.FLOAT_VEC2:e.uniform2fv(i,r);break;case V.FLOAT_VEC3:e.uniform3fv(i,r);break;case V.FLOAT_VEC4:e.uniform4fv(i,r);break;case V.FLOAT_MAT3:e.uniformMatrix3fv(i,!1,r);break;case V.FLOAT_MAT4:e.uniformMatrix4fv(i,!1,r)}}applyUniforms(e,t,i){let r=this,s=r.getUniforms();if(0===s.size)return;let n=t.getMaterial(),a=i?i.getPosition():m.Zero,o=pt,g=t.getMatrix(),A=vt.vMatrix,I=vt.pMatrix,C=vt.vpMatrix,h=vt.vIMatrix,_=vt.pIMatrix,l=vt.vpIMatrix,u=void 0,c=void 0,d=void 0,p=Et;s.forEach((t,s)=>{let m,f=t.location,T=t.type;switch(s){case le.mMat:m=g;break;case le.mIMat:m=o.copy(g).invert();break;case le.mITMat:m=o.copy(g).invertTranspose();break;case le.vMat:m=A;break;case le.vIMat:m=h;break;case le.pMat:m=I;break;case le.pIMat:m=_;break;case le.vpIMat:m=l;break;case le.vpMat:c=c||mt.copy(I).applyMatrix4(A),m=c;break;case le.mvpMat:d=d||Tt.copy(C).applyMatrix4(g),m=d;break;case le.mvMat:u=u||ft.copy(A).applyMatrix4(g),m=u;break;case le.cameraPos:m=a;break;case le.lightColor:m=vt.lightColor;break;case le.lightDir:m=vt.lightDir;break;case le.cameraRange:return i.type===ye.Orthographic?p.set([1,1,1,1]):p.set([i.far,1/i.far,i.aspect,Math.tan(.5*i.fovy)]),void r.setUniformData(e,T,f,p);default:m=n.getProperty(s)}m||(m=n.getProperty(t.name)),r.setUniformData(e,T,f,m.data)})}getTextures(){return this._textures}getTextureIndex(e){return this._textures.get(e)}getAttribLocation(e){return this._attributes.get(e)}getUniforms(){return this._uniforms}set shaderKey(e){this._shaderKey=e}get shaderKey(){return this._shaderKey}remove(e){At.getRenderer(e).removeShader(this)}}vt.curUpdated=!1,vt.vMatrix=new E,vt.pMatrix=new E,vt.vpMatrix=new E,vt.vIMatrix=new E,vt.pIMatrix=new E,vt.vpIMatrix=new E,vt.lightColor=new f,vt.lightDir=new m;class Rt extends lt{constructor(){super(),this._vbuffers=[],this._ibuffer=null,this._draw=null}bindVbo(e,t,i){if(Rt._curr===this&&!vt.curUpdated)return;vt.curUpdated=!1,Rt._curr=this;let r=this.getvBuffers(),s=i.getBuffers(),n=s.length;for(let i=0;i<n;i++){let n=s[i],a=!1;n.getAttributes().forEach(s=>{let o=t.getAttribLocation(s.attribType);void 0!==o&&-1!==o&&(a||(e.bindBuffer(e.ARRAY_BUFFER,r[i].getNativeBuffer()),a=!0),e.vertexAttribPointer(o,s.num,s.type,!1,n.getStride(),s.offset))})}return this.bindIbo(e),this}generateFromGeometry(e,t){let i=t.getBuffers(),r=t.getIndexBuffer(),s=t.getDrawParameter();if(0===i.length)return;let n=this._vbuffers;if(n.length=i.length,i.forEach((t,i)=>{let r=new dt;r.generateFromBuffer(e,t),n[i]=r}),r){let t=new dt;t.generateFromBuffer(e,r),this._ibuffer=t,this._draw=new ct(s.mode,s.offset,s.count,r.getType())}else this._draw=new ut(s.mode,s.offset,s.count,0);return this.updated(),this}bindIbo(e){this._ibuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._ibuffer.getNativeBuffer())}getvBuffers(){return this._vbuffers}getiBuffer(){return this._ibuffer}getDraw(){return this._draw}draw(e){this._draw.apply(e)}drawOther(e,t){e.apply(t)}}class Mt extends lt{constructor(){super(),this._frame=void 0,this._depthStencil=void 0,this._drawBufferMap=new Map,this._drawBuffers=[]}checkTextures(e,t,i){let r=!0;if(t.forEach(function(t,i){let s=e.initTexture(t.tex);void 0===s&&(r=!1),this._drawBufferMap.set(i,s)}.bind(this)),i){let t=e.initTexture(i);void 0!==t&&(this._depthStencil=t)}return r}generateFromFrame(e,t,i){let r=i.getTextureMap(),s=i.getDepthStencilTexture();if(this._drawBuffers=[],!1===this.checkTextures(t,r,s))return;let n=this._frame||e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,n),this._drawBufferMap.forEach((t,i)=>{if(i>=4)return void c.error("current just support 4 attachments, but you set "+i);let s=e.COLOR_ATTACHMENT0+i;this._drawBuffers.push(s);let n=r.get(i),a=n.target===xe.TEXTURE_2D?e.TEXTURE_2D:e.TEXTURE_CUBE_MAP_POSITIVE_X+n.target-xe.TEXTURE_CUBE_MAP_POSITIVE_X;e.framebufferTexture2D(e.FRAMEBUFFER,s,a,t.getHandler(),0)}),s&&e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,this._depthStencil.getHandler(),0),e.bindFramebuffer(e.FRAMEBUFFER,null),this._frame=n,this.updated(),this}apply(e,t){e.bindFramebuffer(e.FRAMEBUFFER,this._frame),this._drawBuffers.length>1&&t.drawBuffers&&t.drawBuffers(this._drawBuffers)}}class St extends lt{constructor(e){super(),this._minFilter=e.LINEAR,this._magFilter=e.LINEAR}static clear(){for(let e in St._texIdx)St._texIdx[e]=null}updateSubData(e,t){}setFilter(e,t){this._minFilter=e,this._magFilter=t}applyUnpackAlignment(e,t){e.pixelStorei(e.UNPACK_ALIGNMENT,t.getUnpackAlignment())}getHandler(){return this._texture}apply(e,t){this._apply(e,t)}_apply(e,t){}}St._texIdx={};class xt extends St{constructor(e){super(e),this._wrapS=e.CLAMP_TO_EDGE,this._wrapT=e.CLAMP_TO_EDGE}_applyParameter(e,t,i){e.texParameteri(t,e.TEXTURE_MIN_FILTER,this._minFilter),e.texParameteri(t,e.TEXTURE_MAG_FILTER,this._magFilter),e.texParameteri(t,e.TEXTURE_WRAP_S,this._wrapS),e.texParameteri(t,e.TEXTURE_WRAP_T,this._wrapT),e.TEXTURE_MAX_ANISOTROPY&&e.texParameteri(t,e.TEXTURE_MAX_ANISOTROPY,2),i&&e.generateMipmap(t)}_setTextureData(e,t,i){let r=i.getFormat(),s=i.getInternalformat(),n=i.getDataType();if(i.getUrl()&&i.getImage()){let a=i.getImage();e.texImage2D(t,0,s,r,n,a),this._isUrl=!0}else{if(0===i.getWidth()||0===i.getHeight())return;{let a=i.getData();e.texImage2D(t,0,s,i.getWidth(),i.getHeight(),0,r,n,a)}}return this}_createTextureDatas(e,t){let i=e.createTexture();if(e.bindTexture(e.TEXTURE_2D,i),void 0!==this._setTextureData(e,e.TEXTURE_2D,t))return i}_applyParameters(e,t){this._applyParameter(e,e.TEXTURE_2D,t)}_createGLTextureFromTexture(e,t){let i=this._createTextureDatas(e,t);if(i)return this.setFilter(t.getMinFilter(),t.getMagFilter()),this.setWarp(t.getWrapS(),t.getWrapT()),this._applyParameters(e,t.getMipmap()),i}generateFromTexture2D(e,t){let i=this._createGLTextureFromTexture(e,t);if(i)return this._texture=i,this.updated(),e.bindTexture(e.TEXTURE_2D,null),this}_apply(e,t){e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,this._texture)}setWarp(e,t){this._wrapS=e,this._wrapT=t}get isUrl(){return this._isUrl}}xt.ImageTexMap=new WeakMap;class Nt extends xt{constructor(e){super(e)}_createGLTextureFromTexture(e,t){return this._wrapR=t.getWrapR(),super._createGLTextureFromTexture(e,t)}_applyParameter(e,t,i){super._applyParameter(e,t,i)}_createTextureDatas(e,t){let i=e.createTexture();e.bindTexture(e.TEXTURE_CUBE_MAP,i);let r=t.getTexture2ds();for(let t=0;t<r.length;t++){let i=r[t];if(i.loaded||(i=i._def),i&&void 0===this._setTextureData(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i))return}return i}_applyParameters(e,t){this._applyParameter(e,e.TEXTURE_CUBE_MAP,t)}generateFromTextureCube(e,t){let i=this._createGLTextureFromTexture(e,t);if(i)return this._texture=i,this.updated(),e.bindTexture(e.TEXTURE_CUBE_MAP,null),this}_apply(e,t){e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_CUBE_MAP,this._texture)}}class yt{static init(){}static now(){return performance.now()||Date.now()}static document(){return document}static window(){return window}static createCanvas(){return document.createElement("canvas")}static get requestAnimationFrame(){return this.reqAniBindWin}static get cancelAnimationFrame(){return this.celAniBindWin}static get width(){return window.innerWidth}static get height(){return window.innerHeight}}yt.reqAniBindWin=window.requestAnimationFrame.bind(window),yt.celAniBindWin=window.cancelAnimationFrame.bind(window);const Ot="\nvec3 encodeFloat2RGB(float v)\n{\n    vec3 enc = vec3(1.0, 255.0, 65025.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzz * vec3(1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n",Dt="\nvec4 encodeFloat2RGBA(float v)\n{\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n",Ft="\nfloat decodeRGB2Float(vec3 rgb)\n{\n    return dot(rgb, vec3(1.0, 1.0 / 255.0, 1.0 / 65025.0));\n}\n",wt="\nfloat decodeRGBA2Float(vec4 rgba)\n{\n    return dot(rgba, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n",bt="\n// tone mapping (magic number);\nvec3 ACESToneMapping(vec3 color, float avgLum, float adapted_lum)\n{\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum / avgLum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n",Lt="\n#ifdef DIRECTION_SHADOW_LIGHT\n    uniform vec3 u_directionShadowDirs[DIRECTION_SHADOW_LIGHT];\n    uniform vec4 u_directionShadowColors[DIRECTION_SHADOW_LIGHT];\n    uniform sampler2D u_directionShadowMaps[DIRECTION_SHADOW_LIGHT];\n    varying vec3 u_directionDepths[DIRECTION_SHADOW_LIGHT];  \n#endif\n\n#ifdef POINT_SHADOW_LIGHT\n    uniform vec3 u_pointShadowPos[POINT_SHADOW_LIGHT];\n    uniform vec4 u_pointShadowColors[POINT_SHADOW_LIGHT];\n    uniform samplerCube u_pointShadowMaps[POINT_SHADOW_LIGHT];\n    uniform vec2 u_pointRanges[POINT_SHADOW_LIGHT];\n#endif\n\n#ifdef SPOT_SHADOW_LIGHT\n    uniform vec3 u_spotShadowPos[SPOT_SHADOW_LIGHT];\n    uniform vec4 u_spotShadowDirs[SPOT_SHADOW_LIGHT];\n    uniform vec4 u_spotShadowColors[SPOT_SHADOW_LIGHT];\n    uniform sampler2D u_spotShadowMaps[SPOT_SHADOW_LIGHT];\n    uniform mat4 u_spotMats[SPOT_SHADOW_LIGHT];\n    uniform vec4 u_spotRanges[SPOT_SHADOW_LIGHT];     \n#endif\n",Pt="\n#include <decodeRGB2Float>\n\nvec4 standardShadowMap()\n{\n    #ifdef SHADOW_MAP\n        // PCF\n        // vec2 uvoffset[9];\n        // const float fenmu = 1.0 / 1024.0;\n        // uvoffset[0] = vec2(0.0, 0.0);\n        // uvoffset[1] = vec2(0.0, fenmu);\n        // uvoffset[2] = vec2(0.0, -fenmu);\n        // uvoffset[3] = vec2(fenmu, 0.0);\n        // uvoffset[4] = vec2(-fenmu, 0.0);\n        // uvoffset[5] = vec2(fenmu, fenmu);\n        // uvoffset[6] = vec2(-fenmu, fenmu);\n        // uvoffset[7] = vec2(fenmu, -fenmu);\n        // uvoffset[8] = vec2(-fenmu, -fenmu);\n        \n        // float bias = max(0.005 * (1.0 - dot(N, L)), 0.0005);\n        // float shadow = 0.0;\n        // for (int i = 0; i < 9; i++) {\n        //     vec2 s_uv = v_depth3.xy + uvoffset[i];\n        //     if (any(lessThan(s_uv, vec2(0.0))) || any(greaterThan(s_uv, vec2(1.0)))) {\n        //         shadow += 1.0;\n        //     } else {\n        //         float depth2 = decodeRGBA2Float(texture2D(u_depthMap, s_uv).rgb);\n        //         shadow += clamp(exp(200.0 * (depth2 - depth)), 0.5, 1.0); \n        //         // shadow += (depth - bias > depth2 ? 0.5 : 1.0);\n        //     }\n        // }\n        // float shadow = (depth > depth2 ? 0.5 : 1.0);\n\n        // ESMencodefloatencode\n        // vec2 depthPixelSize = vec2(1.0 / 512.0);\n        // vec2 fullUV = v_depth3.xy * vec2(512.0, 512.0) - vec2(0.5);\n        // vec2 floorUV = floor(fullUV) + vec2(0.5);\n        // vec2 ceilUV = ceil(fullUV) + vec2(0.5);\n        // vec2 fractUV = fract(fullUV);\n        // vec2 invfractUV = vec2(1.0) - fractUV;\n\n        // float z0 = decodeRGBA2Float(texture2D(u_depthMap, ceilUV * depthPixelSize));\n        // float z1 = decodeRGBA2Float(texture2D(u_depthMap, vec2(ceilUV.x, floorUV.y) * depthPixelSize));\n        // float z2 = decodeRGBA2Float(texture2D(u_depthMap, vec2(floorUV.x, ceilUV.y) * depthPixelSize));\n        // float z3 = decodeRGBA2Float(texture2D(u_depthMap, floorUV * depthPixelSize));\n\n        // float nz0 = z3 * invfractUV.x * invfractUV.y;\n        // float nz1 = z2 * invfractUV.x * fractUV.y;\n        // float nz2 = z1 * fractUV.x * invfractUV.y;\n        // float nz3 = z0 * fractUV.x * fractUV.y;\n        // texture2D(u_depthMap, v_depth3.xy).r;// nz0 + nz1 + nz2 + nz3;// \n\n        // float d = v_depth3.z;\n        // float z = decodeRGBA2Float(texture2D(u_depthMap, v_depth3.xy)); \n        // float shadow;\n        // if (any(lessThan(v_depth3.xy, vec2(0.0))) || any(greaterThan(v_depth3.xy, vec2(1.0)))) {\n        //     shadow = 1.0;\n        // } else {\n        //     shadow = clamp(exp((z - d) * 300.0), 0.0, 1.0); //d > z ? 1.0 : \n        // }\n        // shadow = d > 1.0 ? 1.0 : shadow;\n        // lo = mix(lo * 0.75 + vec3(0.0, 0.0, 1.0) * 0.25, vec3(0.0), shadow);\n        // lo *= vec3(1.0 - shadow, 1.0, 1.0);\n    #endif    \n\n}\n\n",Ut="\n\n    vec3 pos = u_pointShadowPos[POINT_MAP_INDEX];\n    vec4 color = u_pointShadowColors[POINT_MAP_INDEX];\n    vec3 d3 = v_worldPos - pos;\n    float d = length(d3);\n    d3 /= d;\n    d3 = vec3(d3.x, d3.z, -d3.y);\n\n    vec3 L = normalize(pos - v_worldPos);\n    float bias = max(5.0 * (1.0 - dot(N, L)), 2.0);\n    float shadow = 0.0;\n    #ifdef POINT_SHADOW_PCF\n        float diskRadius = (1.0 + (d * u_pointRanges[POINT_MAP_INDEX].y)) * 0.005;// / 25.0;\n        for (int i = 0; i < 2; i++) {\n            for (int j = 0; j < 2; j++) {\n                for (int k = 0; k < 2; k++) {\n                    vec3 bbi = vec3( i == 0 ? 1.0: -1.0 ,  j == 0 ? 1.0: -1.0 ,  k == 0 ? 1.0: -1.0 ) * diskRadius;\n                    float z = u_pointRanges[POINT_MAP_INDEX].x * decodeRGBA2Float(textureCube(u_pointShadowMaps[POINT_MAP_INDEX], d3 + bbi));\n                    float sh = d - bias > z ? 0.0 : 1.0;\n                    shadow += d > u_pointRanges[POINT_MAP_INDEX].x ? 1.0 : sh;\n                }\n            }\n        }\n\n        for (int j = 0; j < 2; j++) {\n            for (int k = 0; k < 2; k++) {\n                vec3 bbi = vec3( 0,  j == 0 ? 1.0: -1.0 ,  k == 0 ? 1.0: -1.0 ) * diskRadius;\n                float z = u_pointRanges[POINT_MAP_INDEX].x * decodeRGBA2Float(textureCube(u_pointShadowMaps[POINT_MAP_INDEX], d3 + bbi));\n                float sh = d - bias > z ? 0.0 : 1.0;\n                shadow += d > u_pointRanges[POINT_MAP_INDEX].x ? 1.0 : sh;\n            }\n        }\n\n        for (int j = 0; j < 2; j++) {\n            for (int k = 0; k < 2; k++) {\n                vec3 bbi = vec3( k == 0 ? 1.0: -1.0,   j == 0 ? 1.0: -1.0 ,0   ) * diskRadius;\n                float z = u_pointRanges[POINT_MAP_INDEX].x * decodeRGBA2Float(textureCube(u_pointShadowMaps[POINT_MAP_INDEX], d3 + bbi));\n                float sh = d - bias > z ? 0.0 : 1.0;\n                shadow += d > u_pointRanges[POINT_MAP_INDEX].x ? 1.0 : sh;\n            }\n        }\n\n        for (int j = 0; j < 2; j++) {\n            for (int k = 0; k < 2; k++) {\n                vec3 bbi = vec3( j == 0 ? 1.0: -1.0 , 0,   k == 0 ? 1.0: -1.0 ) * diskRadius;\n                float z = u_pointRanges[POINT_MAP_INDEX].x * decodeRGBA2Float(textureCube(u_pointShadowMaps[POINT_MAP_INDEX], d3 + bbi));\n                float sh = d - bias > z ? 0.0 : 1.0;\n                shadow += d > u_pointRanges[POINT_MAP_INDEX].x ? 1.0 : sh;\n            }\n        }\n\n        shadow /= 20.0;\n    #else\n        float z = u_pointRanges[POINT_MAP_INDEX].x * decodeRGBA2Float(textureCube(u_pointShadowMaps[POINT_MAP_INDEX], d3));\n        shadow = d - bias > z ? 0.0 : 1.0;\n        shadow = d > u_pointRanges[POINT_MAP_INDEX].x ? 1.0 : shadow;\n    #endif\n\n    float factor = max(1.0 - (1.0 - color.w) * (d * d), 0.0);\n    // float factor = max(1.0 - (1.0 - color.w) * dot(d3, d3), 0.0);\n    lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, L, color) * factor * shadow;\n",Bt="\n// \nfloat distributionGGX(float NdotH, float roughness)\n{\n    float a2     = roughness * roughness;\n    float NdotH2 = NdotH * NdotH;\n\n    float nom    = a2;\n    float denom  = (NdotH2 * (a2 - 1.0) + 1.0);\n    denom        = PI * denom * denom;\n\n    return nom / denom;\n}\n",zt="\nfloat geometrySchlickGGX(float NdotV, float k)\n{\n    float nom   = NdotV;\n    float denom = NdotV * (1.0 - k) + k;\n\n    return nom / denom;\n}\n\n// Schlick\nfloat geometrySmith(float NdotV, float NdotL, float roughness) \n{\n    float r = (roughness + 1.0);\n    float k = (r * r) / 8.0;\n\n    float ggx2  = geometrySchlickGGX(NdotV, k);\n    float ggx1  = geometrySchlickGGX(NdotL, k);\n\n    return ggx1 * ggx2;\n}\n",Gt="\n//Schlick\nvec3 fresnelSchlick(float HdotV, vec3 F0)\n{\n    return F0 + (vec3(1.0) - F0) * pow((1.0 - HdotV), 5.0);\n}\n",Ht="\n//Schlick\nvec3 fresnelSchlickRoughness(float HdotV, vec3 F0, float roughness)\n{\n    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow((1.0 - HdotV), 5.0);\n}\n",Vt="\nfloat fastDFG(float roughness, float NoV, float NoL)\n{\n    float a = roughness * roughness;\n    float a2 = a * a;\n    float G_V = NoV + sqrt( (NoV - NoV * a2) * NoV + a2 );\n    float G_L = NoL + sqrt( (NoL - NoL * a2) * NoL + a2 );\n    return 1.0 / ( G_V * G_L );\n}\n",Wt="\n\n#ifndef LIGHTING_DEFINE\n#define LIGHTING_DEFINE\n\n#ifdef DIRECTION_LIGHT\n    uniform vec3 u_directionDirs[DIRECTION_LIGHT];\n    uniform vec4 u_directionColors[DIRECTION_LIGHT];\n#endif\n\n#ifdef POINT_LIGHT\n    uniform vec3 u_pointPos[POINT_LIGHT];\n    uniform vec4 u_pointColors[POINT_LIGHT];\n#endif\n\n#ifdef SPOT_LIGHT\n    uniform vec3 u_spotPos[SPOT_LIGHT];\n    uniform vec4 u_spotDirs[SPOT_LIGHT];\n    uniform vec4 u_spotColors[SPOT_LIGHT];\n#endif\n\n#endif\n\n";var kt="\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nvarying vec2 v_uv;\n\nvoid main()\n{\n    v_uv = a_texcoord; // vec2(a_texcoord.x, 1.0 - a_texcoord.y);\n    gl_Position = a_position;\n}\n",Xt="\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nattribute vec3 a_normal;\nattribute vec3 a_tangent;\n\nvarying vec2 v_uv;\nvarying vec3 v_worldPos;\nvarying vec3 v_viewPos;\nvarying vec3 v_normal;\n\n// #ifdef NORMAL_MAP\n    varying vec3 v_tangent;\n    varying vec3 v_binormal;\n// #endif\n\nvarying float v_depth;\n\nuniform vec4 u_uvOffset;\n\nuniform mat4 u_mMat;\nuniform mat4 u_mvMat;\nuniform mat4 u_mITMat;\nuniform mat4 u_mvpMat;\nuniform vec4 u_cameraRange;\n\n#ifdef DIRECTION_SHADOW_LIGHT\n    uniform mat4 u_directionMats[DIRECTION_SHADOW_LIGHT];\n    varying vec3 u_directionDepths[DIRECTION_SHADOW_LIGHT];  \n#endif\n\n#ifdef SPOT_SHADOW_LIGHT\n    // uniform mat4 u_spotMats[SPOT_SHADOW_LIGHT];\n    // uniform vec2 u_spotRanges[SPOT_SHADOW_LIGHT];\n    // varying vec3 v_spotDepths[SPOT_SHADOW_LIGHT];  \n    #if SPOT_SHADOW_LIGHT > 0\n        // varying highp vec3 v_spotDepths_0;\n    #endif\n\n#endif\n\n// #ifdef SHADOW_MAP\n//     uniform mat4 u_depthMat;\n//     varying vec3 v_depth3;  \n// #endif\n\nvoid main()\n{\n    v_uv = a_texcoord * u_uvOffset.xy + u_uvOffset.zw;\n\n    vec4 worldPos = u_mMat * a_position;\n    v_worldPos = worldPos.xyz;\n\n    // #ifdef NORMAL_MAP\n        v_tangent = normalize((u_mMat * vec4(a_tangent, 0.0)).xyz);\n        v_binormal = cross(v_tangent, v_normal);\n    // #endif\n    v_normal = normalize((u_mITMat * vec4(a_normal, 0.0)).xyz);\n\n    v_viewPos = (u_mvMat * a_position).xyz;\n\n    vec4 pos = u_mvpMat * a_position;\n    v_depth = pos.w * u_cameraRange.y;\n\n    // #ifdef SHADOW_MAP\n    //     vec4 depthVec = u_depthMat * vec4(v_worldPos, 1.0);\n    //     v_depth3 = depthVec.xyz * 0.5 + 0.5;\n    // #endif\n\n    #ifdef DIRECTION_SHADOW_LIGHT\n        for (int i = 0; i < DIRECTION_SHADOW_LIGHT; i++) {\n            vec4 depthVec = u_directionMats[i] * vec4(v_worldPos, 1.0);\n            u_directionDepths[i] = depthVec.xyz * 0.5 + 0.5;\n        }\n    #endif\n\n    #ifdef SPOT_SHADOW_LIGHT\n\n        #if SPOT_SHADOW_LIGHT > 0\n            // vec4 depthVec = u_spotMats[0] * vec4(v_worldPos, 1.0);\n            // v_spotDepths_0 = vec3(depthVec.xy / depthVec.w * 0.5 + 0.5, depthVec.w * u_spotRanges[0].y);\n        #endif\n\n        // for (int i = 0; i < SPOT_SHADOW_LIGHT; i++) {\n        //     vec4 depthVec = u_spotMats[i] * vec4(v_worldPos, 1.0);\n        //     u_spotDepths[i] = vec3(depthVec.xy / depthVec.w * 0.5 + 0.5, depthVec.w * u_spotRanges[i].y);\n        // }\n    #endif\n\n    gl_Position = pos;\n}\n";const Yt={};function jt(e){for(let t in e)Yt[t]=e[t]}jt(r),jt(s),jt(a),jt(o),jt(n),jt(g);const Zt=/#include\s*<([a-zA-Z0-9_./]+)>/;function Kt(e){let t,i=e;do{t=Zt.exec(i),t&&(i=i.replace(t[0],Yt[t[1]]))}while(t);return i}const qt={fullscreen:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D u_diffuseMap;\n\nvoid main()\n{\n    vec4 baseColor = texture2D(u_diffuseMap, v_uv);\n    // baseColor = pow(color, vec3(1.0/2.2)); \n    gl_FragColor = vec4(pow(baseColor.xyz, vec3(1.0/2.2)), 1.0);\n}\n")},color:{vert:Kt("\nattribute vec4 a_position;\nuniform mat4 u_mvpMat;\nvoid main()\n{\n    gl_Position = u_mvpMat * a_position;\n}\n"),frag:Kt("\nprecision mediump float;\nuniform vec4 u_baseColor;\n\nvoid main()\n{\n    gl_FragColor = vec4(u_baseColor.xyz, 1.0);\n}\n")},diffuse:{vert:Kt("\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nvarying vec2 v_uv;\nuniform mat4 u_mvpMat;\nvoid main()\n{\n    v_uv = vec2(a_texcoord.x, 1.0 - a_texcoord.y);\n    gl_Position = u_mvpMat * a_position;\n}\n"),frag:Kt("\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D u_diffuseMap;\nuniform vec4 u_baseColor;\n\nvoid main()\n{\n    vec4 baseColor = texture2D(u_diffuseMap, v_uv) * u_baseColor;\n    gl_FragColor = vec4(baseColor.xyz, 1.0);\n}\n")},cartoon:{vert:Kt("\nattribute vec4 a_position;\nattribute vec2 a_texcoord;\nattribute vec3 a_normal;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\nvarying vec3 v_position;\n\nuniform mat4 u_mvpMat;\nuniform mat4 u_mMat;\nuniform mat4 u_mITMat;\n\nvoid main()\n{\n    v_uv = vec2(a_texcoord.x, 1.0 - a_texcoord.y);\n    v_normal = normalize((u_mITMat * vec4(a_normal, 1.0)).xyz);\n    v_position = (u_mMat * a_position).xyz;\n    gl_Position = u_mvpMat * a_position;\n}\n"),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\nvarying vec3 v_position;\n\nuniform sampler2D u_baseColorMap;\nuniform sampler2D u_specularMap;\nuniform sampler2D u_emissiveMap;\nuniform sampler2D u_cartoonLUTMap;\n\nuniform vec3 u_cameraPos;\nuniform vec4 u_merged;\nuniform vec3 u_lightDir;\nuniform vec4 u_lightColor;\n\nvoid main()\n{\n    vec3 lightDir = u_lightDir;\n\n    vec3 lightIntensity = u_lightColor.xyz;\n\n    vec4 specular = texture2D(u_specularMap, v_uv);\n    vec4 emissive = texture2D(u_emissiveMap, v_uv);\n    vec4 baseColor = texture2D(u_baseColorMap, v_uv);\n\n    float aoScale = u_merged[1];\n    float glossiness = u_merged[2] * 3.5;\n    float reflectance = u_merged[0];\n\n    aoScale *= specular.y;\n    glossiness *= specular.x;\n    reflectance *= specular.z;\n\n    float NdotL = dot(v_normal, lightDir);\n\n    float darkness = NdotL * aoScale;\n\n    vec3 coldTint = vec3(0.4);//TEXTURE2D(u_cartoonLUTMap, vec2(1.0 / 8.0, 1.0 / 8.0)).xyz;\n    vec3 warmTint = vec3(1.0);//TEXTURE2D(u_cartoonLUTMap, vec2(1.0 / 8.0, 5.0 / 8.0)).xyz;\n    float threshold = 0.4;//TEXTURE2D(u_cartoonLUTMap, vec2(1.0 / 8.0, 7.0 / 8.0)).x;\n\n    vec3 tint = mix(coldTint, warmTint, smoothstep(threshold - 0.001, threshold + 0.001, darkness));\n\n    vec3 viewDir = normalize(u_cameraPos - v_position);\n\n    float NdotH = pow(dot(v_normal, normalize(viewDir + lightDir)), glossiness) * reflectance;\n    float specThreshold = 0.4;\n    \n    float s = 1.0 + smoothstep(specThreshold - 0.001, specThreshold + 0.001, NdotH) * 0.2;\n\n    \n    gl_FragColor = vec4(s * tint * lightIntensity * baseColor.rgb, 1.0);\n    // gl_FragColor = vec4(v_normal, 1.0); //specular;//\n}\n")},standard:{vert:Kt(Xt),frag:Kt("\n#if __VERSION__ == 300\n\n#else\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\nprecision mediump float;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\nvarying vec3 v_worldPos;\n\n#include <ShadowMapDefine>\n#include <LightingDefine>\n\n#ifdef NORMAL_MAP\n    varying vec3 v_tangent;\n    varying vec3 v_binormal;\n    uniform sampler2D u_normalMap;\n#endif\n\n#ifdef ALPHA_TEST\n    uniform sampler2D u_ODMap;\n    uniform vec2 u_odOffset;\n#endif\n\nuniform sampler2D u_diffuseMap;\n\nuniform sampler2D u_roughnessMap;\nuniform sampler2D u_brdfLUTMap;\n\nuniform samplerCube u_irradianceMap;\nuniform samplerCube u_prefilterMap;\n\nconst float PI = 3.14159265359;\nconst float inv_PI = 1.0 / PI;\n\nfloat dot_plus(vec3 v1, vec3 v2)\n{\n    return max(dot(v1, v2), 0.0);\n}\n\nuniform vec3 u_specular;\nuniform vec3 u_cameraPos;\nuniform vec4 u_baseColor;\n\n#include <distributionGGX>\n#include <geometrySmith>\n#include <fresnelSchlick>\n#include <fresnelSchlickRoughness>\n\n#include <decodeRGBA2Float>\n\nvec3 directionLight(float NdotV, float roughness, float metallic, vec3 albedo, vec3 F0, vec3 N, vec3 V, vec3 dir, vec4 color) {\n    vec3 L = dir;\n    vec3 H = normalize(V + L);\n\n    float NdotL = dot_plus(N, L); \n    float NdotH = dot_plus(N, H); \n    float HdotV = dot_plus(H, V);\n\n    float G = geometrySmith(NdotV, NdotL, roughness);\n    float D = distributionGGX(NdotH, roughness);\n    vec3 F = fresnelSchlick(HdotV, F0);\n\n    vec3 nominator = D * G * F;//\n    float denominator = 4.0 * NdotV * NdotL + 0.0001;// \n    vec3 brdf = nominator / denominator;\n\n    vec3 kD = vec3(1.0) - F;\n    kD *= 1.0 - metallic;\n\n    return (kD * (albedo) * inv_PI + brdf) * color.xyz * NdotL;\n}\n\n// esm c300\nfloat calcShadow(vec3 depth3, float z) {\n    float d = depth3.z;\n    float shadow;\n    if (any(lessThan(depth3.xy, vec2(0.0))) || any(greaterThan(depth3.xy, vec2(1.0)))) {\n        shadow = 1.0;\n    } else {\n        shadow = clamp(exp((z - d + 0.0005) * 300.0), 0.0, 1.0);\n    }\n    return (d > 1.0 || d < 0.0) ? 1.0 : shadow;\n}\n\nvoid main()\n{\n    vec4 bc = texture2D(u_diffuseMap, v_uv);\n    bc.xyz = pow(bc.xyz, vec3(2.2));\n    vec4 baseColor = bc * u_baseColor;\n    #ifdef ALPHA_TEST\n        float alpha = texture2D(u_ODMap, fract((gl_FragCoord.xy + u_odOffset) * vec2(1.0 / 16.0))).a;\n        if (baseColor.a <= alpha) {\n            discard;\n        }\n    #endif\n\n    vec4 spec = texture2D(u_roughnessMap, v_uv);\n    \n    float roughness = spec.r * u_specular.r;\n    float metallic = spec.g * u_specular.g;\n    float ao = spec.b * u_specular.b;\n\n    vec3 albedo = baseColor.xyz;\n\n    vec3 F0 = vec3(0.04);\n    \n    F0 = F0 * (1.0 - metallic) + albedo * metallic;\n\n    // \n    #ifdef NORMAL_MAP\n        vec3 normal = texture2D(u_normalMap, v_uv).xyz * 2.0 - 1.0;\n        vec3 N = normalize(normal.x * v_tangent + normal.y * v_binormal + normal.z * v_normal);\n    #else\n        vec3 N = normalize(v_normal);\n    #endif\n\n    vec3 V = normalize(u_cameraPos - v_worldPos);\n\n    float NdotV = dot_plus(N, V);\n\n    vec3 lo = vec3(0.0);\n\n    // \n    #ifdef DIRECTION_SHADOW_LIGHT\n        #if DIRECTION_SHADOW_LIGHT > 0\n        {\n            vec3 depth3 = u_directionDepths[0];\n            float z = decodeRGBA2Float(texture2D(u_directionShadowMaps[0], depth3.xy)); \n            float shadow = calcShadow(u_directionDepths[0], z);\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, u_directionShadowDirs[0], u_directionShadowColors[0]) * shadow;\n        }\n        #endif\n        #if DIRECTION_SHADOW_LIGHT > 1\n        {\n            vec3 depth3 = u_directionDepths[1];\n            float z = decodeRGBA2Float(texture2D(u_directionShadowMaps[1], depth3.xy)); \n            float shadow = calcShadow(u_directionDepths[1], z);\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, u_directionShadowDirs[1], u_directionShadowColors[1]) * shadow;\n        }\n        #endif\n    #endif\n\n    #ifdef DIRECTION_LIGHT\n        for (int i = 0; i < DIRECTION_LIGHT; i++) {\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, u_directionDirs[i], u_directionColors[i]);\n        }\n    #endif\n\n    // \n    #ifdef POINT_SHADOW_LIGHT\n        #if POINT_SHADOW_LIGHT > 0\n        {\n            #define POINT_MAP_INDEX 0\n            #ifndef POINT_SHADOW_PCF_0\n                #define POINT_SHADOW_PCF\n            #endif\n            #include<PointShadowCalc>\n            #ifndef POINT_SHADOW_PCF_0\n                #undef POINT_SHADOW_PCF\n            #endif\n            #undef POINT_MAP_INDEX\n        }\n        #endif\n\n        #if POINT_SHADOW_LIGHT > 1\n        {\n            #define POINT_MAP_INDEX 1\n            #ifndef POINT_SHADOW_PCF_0\n                #define POINT_SHADOW_PCF\n            #endif\n            #include<PointShadowCalc>\n            #ifndef POINT_SHADOW_PCF_0\n                #undef POINT_SHADOW_PCF\n            #endif\n            #undef POINT_MAP_INDEX\n        }\n        #endif\n    #endif\n\n    #ifdef POINT_LIGHT\n        for (int i = 0; i < POINT_LIGHT; i++) {\n            vec3 pos = u_pointPos[i];\n            vec4 color = u_pointColors[i];\n            vec3 d3 = pos - v_worldPos;\n            float d3len = length(d3);\n            float factor = max(1.0 - (1.0 - color.w) * (d3len * d3len), 0.0);\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, normalize(d3), color) * factor;\n        }\n    #endif\n\n    // \n    #ifdef SPOT_SHADOW_LIGHT\n        #if SPOT_SHADOW_LIGHT > 0\n        {\n            vec4 depthVec = u_spotMats[0] * vec4(v_worldPos, 1.0);\n            vec3 depth3 = vec3(depthVec.xy / depthVec.w * 0.5 + 0.5, depthVec.w * u_spotRanges[0].y); //v_spotDepths_0;// \n            \n            vec3 pos = u_spotShadowPos[0];\n            vec4 color = u_spotShadowColors[0];\n            vec4 dir = u_spotShadowDirs[0];\n\n            vec3 d3 = pos - v_worldPos;\n            vec3 L = normalize(d3);\n            \n            float bias = max(0.05 * (1.0 - dot(N, L)), 0.01);\n\n            float shadow = 0.0;\n            for (int i = -1; i <= 1; i++) {\n                for (int j = -1; j <= 1; j++) {\n                    vec2 sp_uv = depth3.xy + u_spotRanges[0].zw * vec2(float(i), float(j));\n                    float z = decodeRGBA2Float(texture2D(u_spotShadowMaps[0], sp_uv));\n                    float sh = depth3.z - bias > z ? 0.0 : 1.0;\n                    sh = (any(lessThan(sp_uv, vec2(0.0))) || any(greaterThan(sp_uv, vec2(1.0)))) ? 1.0 : sh;\n                    shadow += (depth3.z > 1.0 || depth3.z < 0.0) ? 1.0 : sh;\n                }\n            }\n            shadow /= 9.0;\n\n            float ag = step(dir.w, dot(dir.xyz, L));\n            float factor = max(1.0 - (1.0 - color.w) * dot(d3, d3), 0.0);\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, L, color) * factor * ag * shadow;   \n        }\n        #endif\n        #if SPOT_SHADOW_LIGHT > 1\n        #endif\n    #endif\n\n    #ifdef SPOT_LIGHT\n        for (int i = 0; i < SPOT_LIGHT; i++) {\n            vec3 pos = u_spotPos[i];\n            vec4 color = u_spotColors[i];\n            vec4 dir = u_spotDirs[i];\n            vec3 d3 = pos - v_worldPos;\n            vec3 d3_norm = normalize(d3);\n            float ag = step(dir.w, dot(dir.xyz, d3_norm));\n            float factor = max(1.0 - (1.0 - color.w) * dot(d3, d3), 0.0);\n            lo += directionLight(NdotV, roughness, metallic, albedo, F0, N, V, d3_norm, color)  * factor * ag;\n        }\n    #endif\n\n    // \n    vec3 coordN = vec3(N.x, N.z, -N.y);\n    vec3 irradiance = textureCubeLodEXT(u_irradianceMap, coordN, 8.0).xyz;\n    vec3 diffuse = irradiance * albedo;\n    vec3 F_s = fresnelSchlickRoughness(NdotV, F0, roughness);\n    vec3 kD_a = vec3(1.0) - F_s;\n    kD_a *= 1.0 - metallic;\n\n    vec3 R = N * dot_plus(N, V) * 2.0 - V; \n    R = vec3(R.x, R.z, -R.y);\n\n    vec2 envBRDF  = texture2D(u_brdfLUTMap, vec2(NdotV, roughness)).rg;\n    vec3 prefilteredColor = textureCubeLodEXT(u_prefilterMap, R, roughness * 8.0).rgb; \n    // vec3 prefilteredColor = textureCube(u_prefilterMap, R).rgb * (1.0 - roughness) + irradiance * roughness;\n    vec3 specular = prefilteredColor * (F_s * envBRDF.x + envBRDF.y);\n    vec3 ambient = (kD_a * diffuse + specular) * ao;\n\n    vec3 color = (ambient) + lo;\n    gl_FragColor = vec4(color, baseColor.w);\n}\n"),defer_src:{vert:Kt(Xt),frag:Kt("\n\n#if __VERSION__ == 300\n    layout(location = 1) out mediump vec4 fragColor1;\n    layout(location = 2) out mediump vec4 fragColor2;\n#else\n    #extension GL_EXT_draw_buffers : enable\n#endif\n\nprecision mediump float;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\n\n#ifdef NORMAL_MAP\n    varying vec3 v_tangent;\n    varying vec3 v_binormal;\n#endif\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_normalMap;\nuniform sampler2D u_roughnessMap;\nuniform sampler2D u_metallicMap;\nuniform sampler2D u_aoMap;\n\n#ifdef ALPHA_TEST\n    uniform sampler2D u_ODMap;\n#endif\n\nuniform mat4 u_vMat;\nuniform vec3 u_specular;\nuniform vec4 u_baseColor;\nuniform vec2 u_matType;\nvarying vec3 v_viewPos;\nvarying float v_depth;\n\n#include <encodeFloat2RGB>\n\nvoid main()\n{\n    vec4 baseColor = pow(texture2D(u_diffuseMap, v_uv), vec4(2.2)) * u_baseColor;\n    #ifdef ALPHA_TEST\n        float alpha = texture2D(u_ODMap, fract(gl_FragCoord.xy * vec2(1.0 / 16.0))).a;\n        if (baseColor.a <= alpha) {\n            discard;\n        }\n    #endif\n\n    vec4 spec = texture2D(u_roughnessMap, v_uv);\n    \n    float roughness = spec.r * u_specular.r;\n    float metallic = spec.g * u_specular.g;\n    float ao = spec.b * u_specular.b;\n\n    vec3 albedo = baseColor.xyz;\n    \n    #ifdef NORMAL_MAP\n        vec3 normal = texture2D(u_normalMap, v_uv).xyz * 2.0 - 1.0;\n        normal = normalize(normal.x * v_tangent + normal.y * v_binormal + normal.z * v_normal);\n    #else \n        vec3 normal = v_normal;\n    #endif\n    \n    // normal = (u_vMat * vec4(normal, 0.0)).xyz;\n\n    vec3 depth3 = encodeFloat2RGB(v_depth);\n\n\n    #if __VERSION__ == 300\n        fragColor0 = vec4(albedo, roughness);\n        fragColor1 = vec4(normal * 0.5 + 0.5, metallic);\n        fragColor2 = vec4(depth3, ao);\n    #else\n        gl_FragData[0] = vec4(albedo, roughness);\n        gl_FragData[1] = vec4(normal * 0.5 + 0.5, metallic);\n        gl_FragData[2] = vec4(depth3, ao);\n    #endif\n\n    \n}\n")}},fxaa:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\n\nuniform vec2 u_pixelSize;\n\nvec4 o_fragColor;\n\n// NvidiaFXAA\nvoid main(){\n    const float FXAA_SPAN_MAX = 8.0;\n    const float FXAA_REDUCE_MUL = 1.0 / 8.0;\n    const float FXAA_REDUCE_MIN = 1.0 / 128.0;\n\n    vec3 rgbNW = texture2D(u_diffuseMap, v_uv + (vec2(-1.0, -1.0) * u_pixelSize)).xyz;\n    vec3 rgbNE = texture2D(u_diffuseMap, v_uv + (vec2(1.0, -1.0) * u_pixelSize)).xyz;\n    vec3 rgbSW = texture2D(u_diffuseMap, v_uv + (vec2(-1.0, 1.0) * u_pixelSize)).xyz;\n    vec3 rgbSE = texture2D(u_diffuseMap, v_uv + (vec2(1.0, 1.0) * u_pixelSize)).xyz;\n    vec3 rgbM = texture2D(u_diffuseMap, v_uv).xyz;\n\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\n    dir = min(vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),\n        max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n        dir * rcpDirMin)) * u_pixelSize;\n\n    vec3 rgbA = 0.5 * (\n        texture2D(u_diffuseMap, v_uv.xy + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(u_diffuseMap, v_uv.xy + dir * (2.0 / 3.0 - 0.5)).xyz);\n\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(u_diffuseMap, v_uv.xy - dir * 0.5).xyz +\n        texture2D(u_diffuseMap, v_uv.xy + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if((lumaB < lumaMin) || (lumaB > lumaMax)){\n        o_fragColor.xyz = rgbA;\n    }else{\n        o_fragColor.xyz = rgbB;\n    }\n \n    gl_FragColor = vec4(o_fragColor.xyz, 1.0);\n    // gl_FragColor = vec4(pow(o_fragColor.xyz, vec3(1.0/2.2)), 1.0);\n}\n")},down_sample4:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform vec2 u_pixelSize;\n\nvoid main()\n{\n    vec4 result_color = vec4(0.0);\n\n    vec2 pixelSize = u_pixelSize.xy;\n\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(0.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(0.5, 1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(1.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(1.5, 1.5) + v_uv);\n\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-0.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-0.5, 1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-1.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-1.5, 1.5) + v_uv);\n\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(0.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(0.5, -1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(1.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(1.5, -1.5) + v_uv);\n\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-0.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-0.5, -1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-1.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, pixelSize * vec2(-1.5, -1.5) + v_uv);\n\n    result_color *= 1.0 / 16.0;\n\n    gl_FragColor = vec4(result_color.xyz, 1.0);\n}\n")},gaussian_blur:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform vec2 u_pixelSize;\nuniform vec2 u_pixelDir;\n\nvoid main()\n{\n    vec2 dir = u_pixelDir * u_pixelSize;\n    \n    vec4 result_color = vec4(0.0);\n\n    // 0.398943, 0.241971, 0.053991, 0.004432, 0.000134\n    result_color += texture2D(u_diffuseMap, dir * vec2(4.0, 4.0) + v_uv) * 0.000134;\n    result_color += texture2D(u_diffuseMap, dir * vec2(3.0, 3.0) + v_uv) * 0.004432;\n    result_color += texture2D(u_diffuseMap, dir * vec2(2.0, 2.0) + v_uv) * 0.053991;\n    result_color += texture2D(u_diffuseMap, dir * vec2(1.0, 1.0) + v_uv) * 0.241971;\n\n    result_color += texture2D(u_diffuseMap, dir * vec2(0.0, 0.0) + v_uv) * 0.398943;\n\n    result_color += texture2D(u_diffuseMap, dir * vec2(-1.0, -1.0) + v_uv) * 0.241971;\n    result_color += texture2D(u_diffuseMap, dir * vec2(-2.0, -2.0) + v_uv) * 0.053991;\n    result_color += texture2D(u_diffuseMap, dir * vec2(-3.0, -3.0) + v_uv) * 0.004432;\n    result_color += texture2D(u_diffuseMap, dir * vec2(-4.0, -4.0) + v_uv) * 0.000134;\n\n    gl_FragColor = result_color;//vec4(result_color.xyz, 1.0);\n}\n\n")},down_sample_to1:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_lumMap;\nuniform vec2 u_pixelSize;\nuniform vec2 u_lumPCT;\n\nvoid main()\n{\n    vec4 result_color = vec4(0.0);\n\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(0.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(0.5, 1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(1.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(1.5, 1.5) + v_uv);\n\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-0.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-0.5, 1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-1.5, 0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-1.5, 1.5) + v_uv);  \n\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(0.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(0.5, -1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(1.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(1.5, -1.5) + v_uv);\n\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-0.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-0.5, -1.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-1.5, -0.5) + v_uv);\n    result_color += texture2D(u_diffuseMap, u_pixelSize * vec2(-1.5, -1.5) + v_uv);\n    \n\n    float l = result_color.x / 16.0;\n\n    vec2 lum = vec2(texture2D(u_lumMap, vec2(0.5, 0.5)).x, l);\n    vec2 pct = vec2((1.0 - u_lumPCT.x), u_lumPCT.x);\n    float fin = dot(lum, pct);\n    \n    gl_FragColor = vec4(fin, fin, fin, 1.0);\n}\n")},bloom:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_lumMap;\nuniform vec2 u_lumPCT;\n\n#include <ACESToneMapping>\n\nvoid main()\n{\n    vec3 lum_fact = vec3(0.27, 0.67, 0.06);\n    vec3 color = texture2D(u_diffuseMap, v_uv).xyz;\n\n    float ave_lum = texture2D(u_lumMap, vec2(0.5, 0.5)).x;\n    \n    vec3 ecolor = ACESToneMapping(color, ave_lum, u_lumPCT.x);\n\n    float t = dot(ecolor, vec3(1.0 / 3.0, 1.0 / 3.0, 1.0 / 3.0));\n\n    gl_FragColor = t > 0.9 ? vec4(color, 1.0) : vec4(0.0);\n}\n")},tone_mapping:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_bloomMap;\nuniform sampler2D u_lumMap;\nuniform sampler2D u_aoMap;\nuniform vec2 u_lumPCT;\nuniform vec2 u_pixelSize;\n\n#include <ACESToneMapping>\n\nvoid main()\n{\n    vec3 lum_fact = vec3(0.27, 0.67, 0.06);\n    vec3 color = texture2D(u_diffuseMap, v_uv).xyz;\n\n    float ave_lum = texture2D(u_lumMap, vec2(0.5, 0.5)).x;\n    \n    color = ACESToneMapping(color, ave_lum, u_lumPCT.x);\n\n    vec3 bloom = texture2D(u_bloomMap, v_uv).xyz * 1.3;\n    float ao = texture2D(u_aoMap, v_uv).a;\n    vec3 final_color = clamp(color * ao + bloom, 0.0, 1.0);\n\n    gl_FragColor = vec4(final_color, 1.0);\n}\n")},lum_sample:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\n\nvoid main()\n{\n    vec3 color = texture2D(u_diffuseMap, v_uv).xyz;\n    float lum = dot(vec3(0.299, 0.587, 0.114), color) + 0.0001;\n    \n    gl_FragColor = vec4(vec3(lum), 1.0);\n}\n")},ssao:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\n#ifdef NORMAL_MAP\n    uniform sampler2D u_normalMap;\n#endif \n\nuniform sampler2D u_depthMap;\nuniform sampler2D u_randomMap;\n\nuniform mat4 u_pMat;\nuniform mat4 u_pIMat;\nuniform vec4 u_multiUsing;\nuniform vec4 u_cameraRange;\nuniform vec2 u_pixelSize;\n\nuniform vec3 u_samples[SAMPLE_NUM];\n\n#include <decodeRGB2Float>\n\nfloat linearToDepth(float l, float f, float n) \n{\n    return (f + n - 2.0 * n * f) / (l * (f - n));\n}\n\nvoid main()\n{\n    // vec2 randomUV = v_uv * u_pixelSize;\n    // vec3 randomDir = texture2D(u_randomMap, randomUV).xyz * 2.0;\n\n    #ifdef NORMAL_MAP\n        vec4 rt2 = texture2D(u_depthMap, v_uv);\n        float d = decodeRGB2Float(rt2.xyz);\n        float depth = linearToDepth(d * 2.0 - 1.0, u_cameraRange.x, u_cameraRange.y);\n    #else\n        float depth = texture2D(u_depthMap, v_uv).x;\n        float d = depth;\n    #endif \n\n    vec4 pos = u_pIMat * (vec4(v_uv, depth, 1.0) * 2.0 - 1.0);\n    pos.xyz /= pos.w;\n\n    float ao = 0.0;\n\n    for (int i = 0; i < SAMPLE_NUM; i++) {\n        vec4 np = u_pMat * vec4(vec3(pos.xyz + u_samples[i]), 1.0);\n        np.xyz /= np.w;\n        np.xyz = np.xyz * 0.5 + 0.5;\n\n        #ifdef NORMAL_MAP\n            vec4 rtn = texture2D(u_depthMap, np.xy);\n            float nzSrc = decodeRGB2Float(rtn.xyz);\n            float nz = linearToDepth(nzSrc * 2.0 - 1.0, u_cameraRange.x, u_cameraRange.y);\n            float rangeCheck = smoothstep(0.0, 1.0, u_cameraRange.z / abs(nzSrc - d));\n        #else\n            float nz = texture2D(u_depthMap, np.xy).x;\n            vec4 nView = u_pIMat * (vec4(np.xy, nz, 1.0) * 2.0 - 1.0);\n            nView.xyz /= nView.w;\n            float rangeCheck = smoothstep(0.0, 1.0, 1.0 / abs(pos.z - nView.z));\n        #endif \n    \n        ao += (nz < np.z ? 1.0 : 0.0) * rangeCheck;\n    }\n    ao /= float(SAMPLE_NUM);\n\n    gl_FragColor = vec4(vec3(0.0), 1.0 - ao);\n    // gl_FragColor = vec4(vec3(1.0 - ao), 1.0);\n}\n")},deferred_shading:{vert:Kt("\n\nattribute vec4 a_position;\n\n#ifdef POINT_LIGHT\n    uniform mat4 u_mvpMat;\n#endif\n\nvoid main()\n{\n    #ifdef POINT_LIGHT\n        gl_Position = u_mvpMat * a_position;\n    #else\n        gl_Position = a_position;\n    #endif   \n}\n"),frag:Kt("\n#if __VERSION__ == 300\n\n#else\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\nprecision mediump float;\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_normalMap;\nuniform sampler2D u_depthMap;\n\nuniform sampler2D u_brdfLUTMap;\n\nuniform samplerCube u_irradianceMap;\nuniform samplerCube u_prefilterMap;\n\nuniform mat4 u_vIMat;\n\nuniform vec2 u_pixelSize;\nuniform vec3 u_cameraPos;\n\nuniform vec4 u_lightColor;\nuniform vec4 u_cameraRange;\n\n#ifdef POINT_LIGHT\n    uniform vec3 u_lightPos;\n#endif\n\n#ifdef SPOT_LIGHT\n    uniform vec3 u_lightPos;\n#endif\n\nuniform vec3 u_lightDir;\n\nconst float PI = 3.14159265359;\n\nfloat dot_plus(vec3 v1, vec3 v2)\n{\n    return max(dot(v1, v2), 0.0);\n}\n\n#include <distributionGGX>\n#include <geometrySmith>\n#include <fresnelSchlick>\n#include <fresnelSchlickRoughness>\n\n#include <decodeRGB2Float>\n\nvec3 getViewPos(vec2 texCoord, float depth, vec4 cameraRange){\n    //cameraRange.x: far\n    //cameraRange.y: 1.0 / far\n    //cameraRange.z: aspectRatio\n    //cameraRange.w: tan(fovy * 0.5)\n    float d = depth * cameraRange.x;\n    float temp = d * cameraRange.w;\n    return vec3(texCoord.x * cameraRange.z * temp, texCoord.y * temp, -d);\n}\n\nvoid main() \n{\n    vec2 uv = gl_FragCoord.xy * u_pixelSize;\n\n    vec4 rt0 = texture2D(u_diffuseMap, uv);\n    vec4 rt1 = texture2D(u_normalMap, uv);\n    vec4 rt2 = texture2D(u_depthMap, uv);\n\n    vec3 albedo = rt0.xyz;\n    vec3 normal = rt1.xyz * 2.0 - 1.0;\n    float depth = decodeRGB2Float(rt2.xyz);\n\n    vec3 viewPos = getViewPos(uv * 2.0 - 1.0, depth, u_cameraRange);\n    vec3 worldPos = (u_vIMat * vec4(viewPos, 1.0)).xyz;\n\n    float roughness = rt0.w;\n    float metallic = rt1.w;\n    float ao = rt2.w;\n\n    vec3 F0 = vec3(0.04);\n    F0 = F0 * (1.0 - metallic) + albedo * metallic;\n\n    vec3 L;\n\n    #ifdef POINT_LIGHT\n        L = normalize(u_lightPos - worldPos.xyz);\n    #else\n        L = u_lightDir.xyz;\n    #endif\n\n    vec3 V = normalize(u_cameraPos - worldPos.xyz);\n    vec3 N = normalize(normal);\n    vec3 H = normalize(V + L);\n\n    float NdotL = dot_plus(N, L); \n    float NdotH = dot_plus(N, H); \n    float HdotV = dot_plus(H, V);\n    float NdotV = dot_plus(N, V);\n\n    float G = geometrySmith(NdotV, NdotL, roughness);\n    float D = distributionGGX(NdotH, roughness);\n    vec3 F = fresnelSchlick(HdotV, F0);\n\n    vec3 nominator = D * G * F;//\n    float denominator = 4.0 * NdotV * NdotL + 0.0001;// \n    vec3 brdf = nominator / denominator;\n\n    vec3 kS = F;\n    vec3 kD = vec3(1.0) - kS;\n    kD *= 1.0 - metallic;\n\n    // \n    vec3 lo = (kD * (albedo) / PI + brdf) * u_lightColor.xyz * NdotL;\n\n    #ifdef POINT_LIGHT\n        vec3 d3 = u_lightPos - worldPos.xyz;\n        lo *= 1.0 / dot(d3, d3);\n        gl_FragColor = vec4(lo, 1.0);\n    #else\n        vec3 R = N * dot_plus(N, V) * 2.0 - V; \n        R = vec3(R.x, R.z, -R.y);\n        // \n        vec3 coordN = vec3(N.x, N.z, -N.y);\n        vec3 irradiance = textureCube(u_irradianceMap, coordN).xyz;\n        vec3 diffuse = irradiance * albedo;\n        vec3 F_s = fresnelSchlickRoughness(NdotV, F0, roughness);\n        vec3 kD_a = vec3(1.0) - F_s;\n        kD_a *= 1.0 - metallic;\n\n        vec2 envBRDF  = texture2D(u_brdfLUTMap, vec2(NdotV, roughness)).rg;\n        vec3 prefilteredColor = textureCubeLodEXT(u_prefilterMap, R, roughness * 8.0).rgb;  \n        vec3 specular = prefilteredColor * (F_s * envBRDF.x + envBRDF.y);\n        vec3 ambient = (kD_a * diffuse + specular) * ao;\n\n        // \n        vec3 color = ambient + lo;\n\n        gl_FragColor = vec4(color, 1.0);\n    #endif\n}\n")},skybox:{vert:Kt("\n\nattribute vec3 a_position;\n\nvarying vec3 v_uv;\n\nuniform mat4 u_vpMat;\nuniform vec3 u_cameraPos;\n\nvoid main()\n{\n    v_uv = vec3(-a_position.x, -a_position.z, a_position.y);\n    vec4 pos = u_vpMat * vec4(u_cameraPos - a_position, 1.0);\n    gl_Position = pos.xyww;\n}\n"),frag:Kt("\nprecision mediump float;\n\nvarying vec3 v_uv;\nuniform samplerCube u_diffuseMap;\n\nvoid main()\n{\n    vec4 baseColor = textureCube(u_diffuseMap, v_uv);\n    gl_FragColor = vec4(baseColor.xyz, 1.0);\n}\n")},blendAO:{vert:Kt(kt),frag:Kt("\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_aoMap;\n\nvoid main()\n{\n    vec4 color = texture2D(u_diffuseMap, v_uv);\n\n    vec4 ao = texture2D(u_aoMap, v_uv);\n\n    vec4 result = color * ao.a + ao * (1.0 - ao.a);\n\n    result.a = 1.0;\n\n    gl_FragColor = result;\n}\n")},depth:{vert:Kt("\n\nattribute vec4 a_position;\n\nvarying float v_depth;\nuniform mat4 u_mvpMat;\nuniform vec4 u_cameraRange;\n\n\n#ifdef POINT_SHADOW\n    uniform mat4 u_mMat;\n    uniform vec3 u_cameraPos;\n#endif\n\n#ifdef ALPHA_TEST\n    attribute vec2 a_texcoord;\n\n    varying vec2 v_uv;\n    uniform vec4 u_uvOffset;\n#endif\n\nconst float dd = 1.0 / sqrt(3.0);\n\nvoid main()\n{\n    #ifdef ALPHA_TEST\n        v_uv = a_texcoord * u_uvOffset.xy + u_uvOffset.zw;\n    #endif\n\n    vec4 pos = u_mvpMat * a_position;\n\n    #ifdef POINT_SHADOW\n        vec4 mpos = u_mMat * a_position;\n        v_depth = length(mpos.xyz - u_cameraPos) * u_cameraRange.y * dd;\n    #else\n        v_depth = pos.w == 1.0 ? pos.z * 0.5 + 0.5 : pos.w * u_cameraRange.y; //\n    #endif\n    gl_Position = pos;\n}\n"),frag:Kt("\nprecision mediump float;\n\n#ifdef ALPHA_TEST\n    varying vec2 v_uv;\n    uniform sampler2D u_ODMap;\n    uniform sampler2D u_diffuseMap;\n    uniform vec4 u_baseColor;\n#endif\n\nvarying float v_depth;\n\n#include <encodeFloat2RGBA>\n\nvoid main()\n{\n    #ifdef ALPHA_TEST\n        vec4 bc = texture2D(u_diffuseMap, v_uv);\n        bc.xyz = pow(bc.xyz, vec3(2.2));\n        vec4 baseColor = bc * u_baseColor;\n\n        float alpha = texture2D(u_ODMap, fract(gl_FragCoord.xy * vec2(1.0 / 16.0))).a;\n        if (baseColor.a <= alpha) {\n            discard;\n        }\n    #endif\n\n    float depth = v_depth; //exp(v_depth * 80.0);\n    gl_FragColor = vec4(encodeFloat2RGBA(v_depth));\n    // gl_FragColor = vec4(depth);\n}\n")},log_blur:{vert:Kt(kt),frag:Kt("\n\nprecision mediump float;\n\nvarying vec2 v_uv;\n\nuniform sampler2D u_diffuseMap;\nuniform vec2 u_pixelSize;\nuniform vec2 u_pixelDir;\nuniform vec4 u_cameraRange;\n#ifdef KERNEL_RADIUS \n    uniform float u_weight[KERNEL_RADIUS];\n#endif\n\n#include <encodeFloat2RGBA>\n#include <decodeRGBA2Float>\n\nvoid main()\n{\n    vec2 dir = u_pixelDir * u_pixelSize;\n\n    #ifdef KERNEL_RADIUS\n        \n    #else\n        \n    #endif\n\n    float u_weight[4];\n    u_weight[0] = 0.241971;\n    u_weight[1] = 0.053991;\n    u_weight[2] = 0.004432;\n    u_weight[3] = 0.000134;\n\n    float z = 300.0;\n    float w = 1.0 / z;\n\n    float d0 = decodeRGBA2Float(texture2D(u_diffuseMap, v_uv)) * z;\n\n    float color = 0.398943;\n\n    #ifdef KERNEL_RADIUS\n        for (int i = 0; i < KERNEL_RADIUS; i++) \n    #else\n       \n    #endif\n    for (int i = 0; i < 4; i++) \n    {\n        float d1 = decodeRGBA2Float(texture2D(u_diffuseMap, dir * vec2(float(i+1)) + v_uv)) * z;\n        float d2 = decodeRGBA2Float(texture2D(u_diffuseMap, dir * vec2(float(-i-1)) + v_uv)) * z;\n        // float d1 = texture2D(u_diffuseMap, dir * vec2(float(i+1)) + v_uv).x * z;\n        // float d2 = texture2D(u_diffuseMap, dir * vec2(float(-i-1)) + v_uv).x * z;\n        color += (exp(d1 - d0) + exp(d2 - d0)) * u_weight[i];\n    }\n\n    float result = clamp((d0 + log(color)) * w, 0.0, 0.999);\n    gl_FragColor = vec4(encodeFloat2RGBA(result));\n}\n")},texture3d_test:{vert:Kt("\nprecision highp float;\n\nattribute vec4 a_position;\nuniform mat4 u_mvpMat;\nuniform mat4 u_mMat;\nuniform mat4 u_vMat;\n\nvarying vec4 v_nearpos;\nvarying vec4 v_farpos;\nvarying vec3 v_position;\n\nmat4 inversemat(mat4 m) {\n    float\n    a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n    a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n    a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n    a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n    b00 = a00 * a11 - a01 * a10,\n    b01 = a00 * a12 - a02 * a10,\n    b02 = a00 * a13 - a03 * a10,\n    b03 = a01 * a12 - a02 * a11,\n    b04 = a01 * a13 - a03 * a11,\n    b05 = a02 * a13 - a03 * a12,\n    b06 = a20 * a31 - a21 * a30,\n    b07 = a20 * a32 - a22 * a30,\n    b08 = a20 * a33 - a23 * a30,\n    b09 = a21 * a32 - a22 * a31,\n    b10 = a21 * a33 - a23 * a31,\n    b11 = a22 * a33 - a23 * a32,\n\n    det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n    return mat4(\n    a11 * b11 - a12 * b10 + a13 * b09,\n    a02 * b10 - a01 * b11 - a03 * b09,\n    a31 * b05 - a32 * b04 + a33 * b03,\n    a22 * b04 - a21 * b05 - a23 * b03,\n    a12 * b08 - a10 * b11 - a13 * b07,\n    a00 * b11 - a02 * b08 + a03 * b07,\n    a32 * b02 - a30 * b05 - a33 * b01,\n    a20 * b05 - a22 * b02 + a23 * b01,\n    a10 * b10 - a11 * b08 + a13 * b06,\n    a01 * b08 - a00 * b10 - a03 * b06,\n    a30 * b04 - a31 * b02 + a33 * b00,\n    a21 * b02 - a20 * b04 - a23 * b00,\n    a11 * b07 - a10 * b09 - a12 * b06,\n    a00 * b09 - a01 * b07 + a02 * b06,\n    a31 * b01 - a30 * b03 - a32 * b00,\n    a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\nvoid main()\n{\n    mat4 viewtransformf = u_vMat;\n    mat4 viewtransformi = inversemat(u_vMat);\n\n    vec4 position = u_mMat * a_position - 0.5;\n    position.w = 1.0;\n    vec4 pos_in_cam = viewtransformf * position;\n\n    pos_in_cam.z = -pos_in_cam.w;\n    v_nearpos = viewtransformi * pos_in_cam;\n\n    pos_in_cam.z = pos_in_cam.w;\n    v_farpos = viewtransformi * pos_in_cam;\n\n    v_position = position.xyz;\n    gl_Position = u_mvpMat * a_position;\n}\n"),frag:Kt("\n// #define MAX_STEP_DEPTH 64\n\nprecision highp float;\nprecision highp sampler3D;\n\nvarying vec4 v_nearpos;\nvarying vec4 v_farpos;\nvarying vec3 v_position;\n\n\nuniform sampler3D u_testTexture3DMap;\nuniform sampler2D u_cmMap;\n\nuniform vec4 u_baseColor;\nuniform vec3 u_cameraPos;\nuniform vec3 u_texSize;\nuniform vec3 u_clim;\n\nconst int REFINEMENT_STEPS = 4;\nconst float relative_step_size = 1.0;\nconst vec4 ambient_color = vec4(0.2, 0.4, 0.2, 1.0);\nconst vec4 diffuse_color = vec4(0.8, 0.2, 0.2, 1.0);\nconst vec4 specular_color = vec4(1.0, 1.0, 1.0, 1.0);\nconst float shininess = 40.0;\n\nvoid cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);\nvoid cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);\n\nfloat sample1(vec3 texcoords);\nvec4 apply_colormap(float val);\nvec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray);\n\nvoid main()\n{\n    vec3 farpos = v_farpos.xyz / v_farpos.w;\n    vec3 nearpos = v_nearpos.xyz / v_nearpos.w;\n\n    vec3 view_ray = normalize(nearpos.xyz - farpos.xyz);\n\n    float distance = dot(nearpos - v_position, view_ray);\n    distance = max(distance, min((- 0.5 - v_position.x) / view_ray.x, (u_texSize.x - 0.5 - v_position.x) / view_ray.x));\n\tdistance = max(distance, min((- 0.5 - v_position.y) / view_ray.y, (u_texSize.y - 0.5 - v_position.y) / view_ray.y));\n\tdistance = max(distance, min((- 0.5 - v_position.z) / view_ray.z, (u_texSize.z - 0.5 - v_position.z) / view_ray.z));\n\n    vec3 front = v_position + view_ray * distance;\n\n    int nsteps = int(-distance / relative_step_size + 0.5);\n    if ( nsteps < 1 )\n\t\tdiscard;\n    vec3 step = ((v_position - front) / u_texSize) / float(nsteps);\n    vec3 start_loc = front / u_texSize;\n\n    // if (u_renderstyle == 0)\n        cast_mip(start_loc, step, nsteps, view_ray);\n    // else if (u_renderstyle == 1)\n        // cast_iso(start_loc, step, nsteps, view_ray);\n\n    if (gl_FragColor.a < 0.05)\n        discard;\n\n    // gl_FragColor = gl_FragColor * 0.5 + 0.5;\n\n    // vec4 result = vec4(0);\n\n    // for (int i = 0; i < MAX_STEP_DEPTH; i++) \n    // {\n    //     if (i >= nsteps) \n    //         break;\n\n    //     result += texture(u_testTexture3DMap, start_loc);\n    //     start_loc += step;\n    // }\n\n    // gl_FragColor = result;\n    // result.a = result.a > 1.0 ? 1.0 : result.a;\n}\n\nfloat sample1(vec3 texcoords) {\n    /* Sample float value from a 3D texture. Assumes intensity data. */\n    return texture(u_testTexture3DMap, texcoords.xyz).r;\n}\n\n\nvec4 apply_colormap(float val) {\n    val = (val - u_clim[0]) / (u_clim[1] - u_clim[0]);\n    return texture2D(u_cmMap, vec2(val, 0.5));\n}\n\n\nvoid cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {\n\n    float max_val = -1e6;\n    int max_i = 100;\n    vec3 loc = start_loc;\n\n    // Enter the raycasting loop. In WebGL 1 the loop index cannot be compared with\n    // non-constant expression. So we use a hard-coded max, and an additional condition\n    // inside the loop.\n    for (int iter=0; iter<MAX_STEP_DEPTH; iter++) {\n        if (iter >= nsteps)\n            break;\n        // Sample from the 3D texture\n        float val = sample1(loc);\n        // Apply MIP operation\n        if (val > max_val) {\n            max_val = val;\n            max_i = iter;\n        }\n        // Advance location deeper into the volume\n        loc += step;\n    }\n\n    // Refine location, gives crispier images\n    vec3 iloc = start_loc + step * (float(max_i) - 0.5);\n    vec3 istep = step / float(REFINEMENT_STEPS);\n    for (int i=0; i<REFINEMENT_STEPS; i++) {\n        max_val = max(max_val, sample1(iloc));\n        iloc += istep;\n    }\n\n    // Resolve final color\n    gl_FragColor = apply_colormap(max_val);\n}\n\n\nvoid cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {\n\n    gl_FragColor = vec4(0.0);\t// init transparent\n    vec4 color3 = vec4(0.0);\t// final color\n    vec3 dstep = 1.5 / u_texSize;\t// step to sample derivative\n    vec3 loc = start_loc;\n\n    float low_threshold = u_clim[2] - 0.02 * (u_clim[1] - u_clim[0]);\n\n    // Enter the raycasting loop. In WebGL 1 the loop index cannot be compared with\n    // non-constant expression. So we use a hard-coded max, and an additional condition\n    // inside the loop.\n    for (int iter=0; iter<MAX_STEP_DEPTH; iter++) {\n        if (iter >= nsteps)\n            break;\n\n        // Sample from the 3D texture\n        float val = sample1(loc);\n\n        if (val > low_threshold) {\n        // Take the last interval in smaller steps\n            vec3 iloc = loc - 0.5 * step;\n            vec3 istep = step / float(REFINEMENT_STEPS);\n            for (int i=0; i<REFINEMENT_STEPS; i++) {\n                val = sample1(iloc);\n                if (val > u_clim[2]) {\n                    gl_FragColor = add_lighting(val, iloc, dstep, view_ray);\n                    return;\n                }\n                iloc += istep;\n            }\n        }\n\n        // Advance location deeper into the volume\n        loc += step;\n    }\n}\n\n\nvec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray)\n{\n    // Calculate color by incorporating lighting\n\n    // View direction\n    vec3 V = normalize(view_ray);\n\n    // calculate normal vector from gradient\n    vec3 N;\n    float val1, val2;\n    val1 = sample1(loc + vec3(-step[0], 0.0, 0.0));\n    val2 = sample1(loc + vec3(+step[0], 0.0, 0.0));\n    N[0] = val1 - val2;\n    val = max(max(val1, val2), val);\n    val1 = sample1(loc + vec3(0.0, -step[1], 0.0));\n    val2 = sample1(loc + vec3(0.0, +step[1], 0.0));\n    N[1] = val1 - val2;\n    val = max(max(val1, val2), val);\n    val1 = sample1(loc + vec3(0.0, 0.0, -step[2]));\n    val2 = sample1(loc + vec3(0.0, 0.0, +step[2]));\n    N[2] = val1 - val2;\n    val = max(max(val1, val2), val);\n\n    float gm = length(N); // gradient magnitude\n    N = normalize(N);\n\n    // Flip normal so it points towards viewer\n    float Nselect = float(dot(N, V) > 0.0);\n    N = (2.0 * Nselect - 1.0) * N;\t// ==\tNselect * N - (1.0-Nselect)*N;\n\n    // Init colors\n    vec4 ambient_color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec4 diffuse_color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec4 specular_color = vec4(0.0, 0.0, 0.0, 0.0);\n\n    // note: could allow multiple lights\n    for (int i=0; i<1; i++)\n    {\n        // Get light direction (make sure to prevent zero devision)\n        vec3 L = normalize(view_ray);\t//lightDirs[i];\n        float lightEnabled = float( length(L) > 0.0 );\n        L = normalize(L + (1.0 - lightEnabled));\n\n        // Calculate lighting properties\n        float lambertTerm = clamp(dot(N, L), 0.0, 1.0);\n        vec3 H = normalize(L+V); // Halfway vector\n        float specularTerm = pow(max(dot(H, N), 0.0), shininess);\n\n        // Calculate mask\n        float mask1 = lightEnabled;\n\n        // Calculate colors\n        ambient_color += mask1 * ambient_color;\t// * gl_LightSource[i].ambient;\n        diffuse_color += mask1 * lambertTerm;\n        specular_color += mask1 * specularTerm * specular_color;\n    }\n\n    // Calculate final color by componing different components\n    vec4 final_color;\n    vec4 color = apply_colormap(val);\n    final_color = color * (ambient_color + diffuse_color) + specular_color;\n    final_color.a = color.a;\n    return final_color;\n}\n")}};class Qt{constructor(e){this._caches=new Map,this.genStr=this.genWebGLStr,this._renderer=e,this.genStr=e.isWebGL2?this.genWebGL2Str:this.genWebGLStr}genShaderProgram(e,t,i){let r=this._renderer,s=e.shader,n=s.getRenderObjectRef(r),a=e.supportDeferred&&t,o=this.genMatKey(e,a,i),g=n?n.shaderKey:"-1";if(g===o)return n;let A=this._caches;n&&this.removeKey(g);let I=A.get(o);if(I)return n=I.program,s.setRenderObjectRef(r,n),I.count++,n;n=new vt,n.shaderKey=o;let C=e.type,h=qt[C],_=r.getContext();a&&h.defer_src&&(h=h.defer_src);let l=e.getMacros(),u=this.genStr(h.vert,l,i,!1),c=this.genStr(h.frag,l,i,!0);return n=n.generateFromText(_,u,c),n?(A.set(o,{program:n,count:1}),s.setRenderObjectRef(r,n),n):null}releaseMaterial(e){let t=e.shader.getRenderObjectRef(this._renderer);if(!t)return;let i=t.shaderKey;this.removeKey(i)}removeShader(e){if(!e)return;let t=e.shaderKey;this.removeKey(t)}removeKey(e){let t=this._caches,i=t.get(e);return!(!i||(i.count--,0!==i.count))&&(t.delete(e),!0)}genWebGLStr(e,t,i){let r=this._genStr(e,t,i);return r="#version 100\n"+r,r}genWebGL2Str(e,t,i,r){let s=this._genStr(e,t,i);return s=`#version 300 es\n\n${r?"":"#define attribute in"}\n#define varying ${r?"in":"out"}\n#define gl_FragColor fragColor0\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\n\n${r?"layout(location = 0) out mediump vec4 fragColor0;":""}\n`+s,s}_genStr(e,t,i){let r=e;if(t){let e="";for(let i in t){let r=t[i];e+=void 0!==r?`#define ${i} ${r}\n`:`#define ${i}\n`}r=e+r}if(i){let e="";i.forEach(t=>{e+=`#define ${t}\n`}),r=e+r}return r}genMatKey(e,t,i){let r=e.key;return t&&(r+="_def"),i&&i.length>0&&i.forEach(e=>{r+=`_${e}`}),r}}var Jt,$t,ei,ti;!function(e){e[e.None=0]="None",e[e.FXAA=1]="FXAA",e[e.SSAO=2]="SSAO",e[e.HDR=3]="HDR",e[e.SSR=4]="SSR"}(Jt||(Jt={})),function(e){e[e.None=0]="None",e[e.AA=1]="AA",e[e.HDR=2]="HDR",e[e.SSR=3]="SSR",e[e.AO=4]="AO"}($t||($t={})),function(e){e[e.FLOAT_COLOR=0]="FLOAT_COLOR",e[e.LAST_COLOR=1]="LAST_COLOR",e[e.LAST_DEPTH=2]="LAST_DEPTH",e[e.LAST_NORMAL=3]="LAST_NORMAL",e[e.COLOR=4]="COLOR",e[e.NORMAL=5]="NORMAL",e[e.DEPTH=6]="DEPTH"}(ei||(ei={}));class ii{constructor(e){this._enable=!1,this._isInit=!1,this._pipe=e}render(){}enable(){this._enable=!0}disable(){}resize(e,t){}srcRequires(){return[]}pipeRequires(){return[]}destroy(e){}get render2Target(){return!1}get type(){return Jt.None}get order(){return $t.None}get isInit(){return this._isInit}}class ri extends ue{constructor(e){super(),this._data=new d(1,1),this.setProperty(le.pixelSize,this._data),e&&this.setSrcTexture(e),this.enableDepth=!1}setSrcTexture(e){if(!e)return;this.setTexture(le.diffuseMap,e);let t=e.getWidth(),i=e.getHeight();t&&i&&this.setPixelSize(1/t,1/i)}setPixelSize(e,t){this._data.set(e,t)}get type(){return"fxaa"}}class si extends ii{constructor(e){super(e)}init(e){let t=new ri(null);this._material=t;let i=new qe;i.setGeometry(e),i.setMaterial(t),this._mesh=i,this._isInit=!0}resize(e,t){this._material.setPixelSize(1/e,1/t)}render(){const e=this._pipe;let t=0===e.peNumber?e.srcFrame:e.currentFrame,i=e.targetFrame,r=t.getTextureFromType(ne.COLOR).tex;this._material.setSrcTexture(r),e.renderPass(this._mesh,i)}srcRequires(){return si.SrcReqs}destroy(e){this._pipe;e.releaseMesh(this._mesh),this._pipe=null,this._mesh=null,this._material=null}get render2Target(){return!0}get type(){return Jt.FXAA}get order(){return $t.AA}}si.SrcReqs=[ei.COLOR];class ni extends ue{constructor(){super(),this._pixelSize=new d(1,1),this.setProperty(le.pixelSize,this._pixelSize)}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}setPixelSize(e,t){this._pixelSize.set(e,t)}get type(){return"down_sample4"}}class ai extends ue{constructor(){super(),this._size=new d(1,1),this.setProperty(le.pixelSize,this._size),this._dir=new d(1,0),this.setProperty(le.pixelDir,this._dir)}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}setPixelSize(e,t){this._size.set(e,t)}setPiexlDir(e,t){this._dir.set(e,t)}get type(){return"gaussian_blur"}}class oi extends ue{constructor(){super(),this._pixelSize=new d(1,1),this.setProperty(le.pixelSize,this._pixelSize),this._lumPCT=new d(1,1),this.setProperty(le.lumPCT,this._lumPCT)}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}setLumTexture(e){this.setTexture(le.lumMap,e)}setPixelSize(e,t){this._pixelSize.set(e,t)}setLumPCT(e){this._lumPCT.x=e}get type(){return"down_sample_to1"}}class gi extends ue{constructor(){super(),this._lumPCT=new d,this.setProperty(le.lumPCT,this._lumPCT)}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}setLumTexture(e){this.setTexture(le.lumMap,e)}setLumPCT(e){this._lumPCT.x=e}get type(){return"bloom"}}class Ai extends ue{constructor(){super(),this._pixelSize=new d,this.setProperty(le.pixelSize,this._pixelSize),this._lumPCT=new d,this.setProperty(le.lumPCT,this._lumPCT),this.setTexture(le.aoMap,ie.White)}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}setLumTexture(e){this.setTexture(le.lumMap,e)}setBloomTexture(e){this.setTexture(le.bloomMap,e)}setAoTexture(e){this.setTexture(le.aoMap,e)}setPixelSize(e,t){this._pixelSize.set(e,t)}setLumPCT(e){this._lumPCT.x=e}get type(){return"tone_mapping"}}class Ii extends ue{constructor(){super()}setSrcTexture(e){this.setTexture(le.diffuseMap,e)}get type(){return"lum_sample"}}class Ci extends ii{constructor(e){super(e),this._adaptationTime=1e3,this._lumFact=.35,this._downTo1Idx=0,this._bloomNum=4}init(e){const t=this._pipe;let i,r=t.width,s=t.height,n=Math.floor(.25*r),a=Math.floor(.25*s);this._down4Frame=new we,i=this._down4Frame,i.setSize(n,a),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._down4Frame2=new we,i=this._down4Frame2,i.setSize(n,a),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.LINEAR,V.LINEAR),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1;let o=Math.floor(.25*n),g=Math.floor(.25*a);this._down16Frame=new we,i=this._down16Frame,i.setSize(o,g),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.LINEAR,V.LINEAR),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo32Frame=new we,i=this._downTo32Frame,i.setSize(32,32),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo32Frame2=new we,i=this._downTo32Frame2,i.setSize(32,32),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo8Frame=new we,i=this._downTo8Frame,i.setSize(8,8),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.LINEAR,V.LINEAR),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo2Frame=new we,i=this._downTo2Frame,i.setSize(2,2),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),this._downTo1Frame=[],i=new we,i.setSize(1,1),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo1Frame.push(i),i=new we,i.setSize(1,1),i.addTexture(ne.COLOR,V.RGB,V.FLOAT,V.NEAREST,V.NEAREST),i.getState().clearColor.set(0,0,0,0),i.getState().needClear=!1,this._downTo1Frame.push(i);let A=new qe,I=new ni;this._down4Mat=I,A.setGeometry(e),A.setMaterial(I),this._downSampleMesh=A,A=new qe;let C=new ai;this._blurMat=C,A.setGeometry(e),A.setMaterial(C),this._blurMesh=A,A=new qe;let h=new oi;this._downTo1Mat=h,A.setGeometry(e),A.setMaterial(h),this._downTo1Mesh=A,A=new qe;let _=new gi;this._bloomMat=_,A.setGeometry(e),A.setMaterial(_),this._bloomMesh=A,A=new qe;let l=new Ai;this._toneMat=l,A.setGeometry(e),A.setMaterial(l),this._toneMesh=A,A=new qe;let u=new Ii;this._lumMat=u,A.setGeometry(e),A.setMaterial(u),this._logMesh=A,this._isInit=!0}resize(e,t){let i=Math.floor(.25*e),r=Math.floor(.25*t);this._down4Frame.setSize(i,r),this._down4Frame2.setSize(i,r);let s=Math.floor(.25*i),n=Math.floor(.25*r);this._down16Frame.setSize(s,n)}render(){const e=this._pipe,t=e.deltaTime;let i=1/e.width,r=1/e.height,s=e.srcFrame,n=e.targetFrame;const a=this._downSampleMesh,o=this._downTo1Mesh,g=this._blurMesh,A=this._bloomMesh,I=this._toneMesh,C=this._logMesh,h=this._down4Mat,_=this._downTo1Mat,l=this._blurMat,u=this._bloomMat,c=this._toneMat,d=this._lumMat,p=this._down4Frame,m=this._down4Frame2,f=this._down16Frame,T=this._downTo32Frame,E=this._downTo32Frame2,v=this._downTo8Frame,R=this._downTo2Frame,M=this.src1Frame,S=this.dst1Frame;let x=s.getTextureFromType(ne.COLOR).tex;h.setSrcTexture(x),h.setPixelSize(i,r),e.renderPass(a,p);let N=1/p.getWidth(),y=1/p.getHeight();x=p.getTextureFromType(ne.COLOR).tex,h.setSrcTexture(x),h.setPixelSize(N,y),e.renderPass(a,f),x=f.getTextureFromType(ne.COLOR).tex,h.setSrcTexture(x),h.setPixelSize(1/f.getWidth(),1/f.getHeight()),e.renderPass(a,T),x=T.getTextureFromType(ne.COLOR).tex,d.setSrcTexture(x),e.renderPass(C,E),x=E.getTextureFromType(ne.COLOR).tex,h.setSrcTexture(x),h.setPixelSize(1/32,1/32),e.renderPass(a,v),x=v.getTextureFromType(ne.COLOR).tex,h.setSrcTexture(x),h.setPixelSize(1/8,1/8),e.renderPass(a,R),x=R.getTextureFromType(ne.COLOR).tex,_.setSrcTexture(x),x=M.getTextureFromType(ne.COLOR).tex,_.setLumTexture(x),_.setPixelSize(.25,.25),_.setLumPCT(Math.min(t/this._adaptationTime,1)),e.renderPass(o,S),x=p.getTextureFromType(ne.COLOR).tex,u.setSrcTexture(x),x=S.getTextureFromType(ne.COLOR).tex,u.setLumTexture(x),u.setLumPCT(this._lumFact),e.renderPass(A,m),l.setPixelSize(N,y);for(let t=0;t<this._bloomNum;t++)x=m.getTextureFromType(ne.COLOR).tex,l.setSrcTexture(x),l.setPiexlDir(1,0),e.renderPass(g,p),x=p.getTextureFromType(ne.COLOR).tex,l.setSrcTexture(x),l.setPiexlDir(0,1),e.renderPass(g,m);x=m.getTextureFromType(ne.COLOR).tex,c.setBloomTexture(x),x=s.getTextureFromType(ne.COLOR).tex,c.setSrcTexture(x),x=S.getTextureFromType(ne.COLOR).tex,c.setLumTexture(x);let O=e.getAoFrame();x=O?O.getTextureFromType(ne.COLOR).tex:ie.White,c.setAoTexture(x),c.setPixelSize(N,y),c.setLumPCT(this._lumFact),e.renderPass(I,n),this.exchange1Frame()}exchange1Frame(){this._downTo1Idx=(this._downTo1Idx+1)%this._downTo1Frame.length}get dst1Frame(){return this._downTo1Frame[this._downTo1Idx]}get src1Frame(){return this._downTo1Frame[(this._downTo1Idx+1)%this._downTo1Frame.length]}destroy(e){this._pipe;e.releaseMesh(this._downSampleMesh),e.releaseMesh(this._downTo1Mesh),e.releaseMesh(this._blurMesh),e.releaseMesh(this._bloomMesh),e.releaseMesh(this._toneMesh),e.releaseMesh(this._logMesh),this._pipe=null,this._downSampleMesh=null,this._downTo1Mesh=null,this._blurMat=null,this._bloomMesh=null,this._toneMesh=null}srcRequires(){return Ci.SrcReqs}setBloomNum(e){e=e>0?e:1,this._bloomNum=e}get render2Target(){return!0}get type(){return Jt.HDR}get order(){return $t.HDR}}Ci.SrcReqs=[ei.FLOAT_COLOR,ei.COLOR];class hi extends ue{constructor(){super(),this._sampleNum=64,this._pixelSize=new d(1,1),this.setProperty(le.pixelSize,this._pixelSize),this._multiUsing=new f(1,1,1,1),this.setProperty(le.multiUsing,this._multiUsing),this.createSampleData(16);let e=new ie;e.setUrl("./resources/randomMap.gif",ie.Normal),e.setFilter(V.NEAREST,V.NEAREST),e.setWarp(V.REPEAT,V.REPEAT),this.setTexture(le.randomMap,e)}createSampleData(e=64){this._samples&&this._sampleNum===e||(this._addMacro("SAMPLE_NUM",e),this._sampleNum=e,this._samples={data:new Float32Array(3*e)},this.setProperty("u_samples",this._samples));let t=[],i=new m;for(let s=0;s<e;s++){var r=s/e;i.set(2*Math.random()-1,2*Math.random()-1,2*Math.random()-1),i.normalize().mul(r*r*.9+.1),t.push(i.x,i.y,i.z)}this._samples.data.set(t)}setDiffuseTexture(e){this.setTexture(le.diffuseMap,e)}setDepthTexture(e){this.setTexture(le.depthMap,e)}setAsptRtoTanHfFov(e,t,i,r){this._multiUsing.set(e,t,i,r)}setNormalTexture(e){e?(this._addMacro("NORMAL_MAP"),this.setTexture(le.normalMap,e)):(this._removeMacro("NORMAL_MAP"),this.removeTexture(le.normalMap))}setPixelSize(e,t){this._pixelSize.set(e,t)}get type(){return"ssao"}}class _i extends ue{constructor(){super()}setSrcTexture(e){this.setTexture(le.aoMap,e)}setDstTexture(e){this.setTexture(le.diffuseMap,e)}get type(){return"blendAO"}}class li extends ii{constructor(e){super(e),this._render2Target=!1}init(e){let t=new hi;this._mat=t;let i=new qe;i.setGeometry(e),i.setMaterial(t),this._mesh=i;let r=new _i;this._blendMat=r,i=new qe,i.setGeometry(e),i.setMaterial(r),this._blendMesh=i;let s=this._pipe,n=Math.floor(s.width),a=Math.floor(s.height),o=new we;o.setSize(n,a),o.addTexture(ne.COLOR,V.RGBA,V.UNSIGNED_BYTE,V.LINEAR,V.LINEAR),o.setClearColor(f.One),this._frame=o,s.setRequestFrame($t.AO,this._frame),this._isInit=!0}setSampleNum(e){this._mat.createSampleData(e)}resize(e,t){this._mat.setPixelSize(e/4,t/4),this._frame.setSize(e,t)}render(){const e=this._pipe,t=this._mat;let i=e.defCamera,r=e.srcFrame,s=this._frame,n=1/r.getWidth(),a=1/r.getHeight(),o=i.aspect,g=Math.tan(i.fovy/2),A=i.near,I=i.far;t.setNormalTexture(null),t.setDepthTexture(r.getDepthStencilTexture()),t.setDiffuseTexture(r.getTextureFromType(ne.COLOR).tex),t.setPixelSize(n,a),t.setAsptRtoTanHfFov(o,g,(-A-I)/(A-I),2*I*A/(A-I)),e.renderPass(this._mesh,s),e.isEnablePEOrder($t.HDR)?this._render2Target=!1:(this._render2Target=!0,this._blendMat.setSrcTexture(s.getTextureFromType(ne.COLOR).tex),this._blendMat.setDstTexture(r.getTextureFromType(ne.COLOR).tex),e.renderPass(this._blendMesh,e.targetFrame))}srcRequires(){return li.SrcReqs}get render2Target(){return this._render2Target}destroy(e){this._pipe.removeRequsetFrame($t.AO,this._frame),e.releaseMesh(this._mesh),this._pipe=null,this._mesh=null,this._mat=null}get type(){return Jt.SSAO}get order(){return $t.AO}}li.SrcReqs=[ei.DEPTH,ei.COLOR];class ui{constructor(e){this._renderer=e,this._requestFrames=new Map}init(e){this._defGeo=e,this._postEffects=[],this._srcRequires=[],this._initFrame()}_initFrame(){let e=this._renderer,t=e.getWidth(),i=e.getHeight(),r=[];for(let e=0;e<2;e++){let e=new we;e.setSize(t,i),e.addTexture(ne.COLOR,V.RGBA,V.UNSIGNED_BYTE,V.NEAREST,V.NEAREST),e.enableDepthStencil(),e.getState().clearColor.set(0,0,0,0),r.push(e)}this._cacheFrames=r,this._frameIndex=0}render(e,t=!1){e&&(this._isDeferredRendering=t,this._srcFrame=e,this._postEffects.forEach((e,t)=>{this._peNumber=t,e.render(),e.render2Target&&this.exchangeFrame()}))}renderPass(e,t){this._renderer.useFrame(t),this._renderer.directRenderMesh(e)}resize(e,t){this._postEffects.forEach(i=>{i.resize(e,t)}),this._cacheFrames.forEach(i=>{i.setSize(e,t)})}_updateSrcReqs(){let e=this._postEffects,t=[],i=[];e.forEach(e=>{i.push[e.order]=!0,e.srcRequires().forEach(e=>{t.indexOf(e)<0&&t.push(e)})}),this._srcRequires=t,this._enabledPEOrders=i}_enablePostEffect(e){let t=this._postEffects,i=t.length;for(let r=0;r<i;r++)if(t[r].order===e.order)return void(t[r]=e);t.push(e),t.sort((e,t)=>t.order-e.order),this._updateSrcReqs()}_disablePostEffect(e){let t=this._postEffects.indexOf(e);t>-1&&(this._postEffects.splice(t,1),e.destroy(this._renderer),this._updateSrcReqs())}_createPEFromType(e){let t;switch(e){case Jt.FXAA:let e=new si(this);e.init(this._defGeo),t=e;break;case Jt.HDR:let i=new Ci(this);i.init(this._defGeo),t=i;break;case Jt.SSAO:let r=new li(this);r.init(this._defGeo),t=r}return t}disablePostEffect(e){if(e instanceof ii)this._disablePostEffect(e);else{let t=this._postEffects,i=t.length;for(let r=0;r<i;r++)if(t[r].type===e)return void this._disablePostEffect(t[r])}}disablePostEffectByOrder(e){let t=this._postEffects,i=t.length;for(let r=0;r<i;r++)if(t[r].order===e)return void this._disablePostEffect(t[r])}enablePostEffect(e){if(e instanceof ii)this._enablePostEffect(e);else{let t=this._createPEFromType(e);t&&this._enablePostEffect(t)}}getEnablingPostEffect(){let e=[];return this._postEffects.forEach(t=>{e.push(t.type)}),e}exchangeFrame(){this._frameIndex=(this._frameIndex+1)%this._cacheFrames.length}get targetFrame(){return this._cacheFrames[this._frameIndex]}get currentFrame(){return this._cacheFrames[(this._frameIndex+1)%this._cacheFrames.length]}getAoFrame(){return this._requestFrames.get($t.AO)}setRequestFrame(e,t){t&&this._requestFrames.set(e,t)}removeRequsetFrame(e,t){this._requestFrames.delete(e)}get srcFrame(){return this._srcFrame}getSrcReqs(){return this._srcRequires}get width(){return this._renderer.getWidth()}get height(){return this._renderer.getHeight()}get deltaTime(){return this._renderer.deltaTime}get defCamera(){return this._renderer.defCamera}get isDeferredRendering(){return this._isDeferredRendering}get gBufferFrame(){return this._renderer.getGBufferFrame()}get peNumber(){return this._peNumber}isEnablePEOrder(e){return this._enabledPEOrders[e]}get length(){return this._postEffects.length}}class ci{constructor(){this.MAX_COLOR_ATTACHMENTS=1,this.MAX_DRAW_BUFFERS=1,this._isWebGL2=!1}initWebGL(e,t){let i;return i=e.getContext("webgl2"),i?(this._gl=i,this.getWebGL2Extensions(),this._isWebGL2=!0,i):(i=e.getContext("webgl"),i?(this._gl=i,this.getWebGLExtensions(),i):(i=e.getContext("experimental-webgl"),i?(this._gl=i,this.getWebGLExtensions(),i):void 0))}getWebGLExtensions(){let e=this._gl;this._vao=e.getExtension("OES_vertex_array_object");let t=e.getExtension("WEBGL_draw_buffers");t?(this._drawBuffers=t,this.MAX_COLOR_ATTACHMENTS=t.MAX_COLOR_ATTACHMENTS_WEBGL,this.MAX_DRAW_BUFFERS=t.MAX_DRAW_BUFFERS_WEBGL,this.drawBuffers=t.drawBuffersWEBGL.bind(t)):this.drawBuffers=null,this._shaderTexLod=e.getExtension("EXT_shader_texture_lod"),this._texFloat=e.getExtension("OES_texture_float"),this._texFloatLinear=e.getExtension("OES_texture_float_linear"),this._texHalfFloat=e.getExtension("OES_texture_half_float"),this._texHalfFloatLinear=e.getExtension("OES_texture_half_float_linear"),this._texFilterAni=e.getExtension("EXT_texture_filter_anisotropic"),this._depthTex=e.getExtension("WEBGL_depth_texture"),this._standardDerivatives=e.getExtension("OES_standard_derivatives"),this._instanceArrays=e.getExtension("ANGLE_instanced_arrays"),this._elementIdxUint=e.getExtension("OES_element_index_uint"),this._instanceArrays&&(this.drawArraysInstanced=this._instanceArrays.drawArraysInstancedANGLE.bind(this._instanceArrays))}getWebGL2Extensions(){const e=this._gl;e.getExtension("EXT_color_buffer_float"),e.getExtension("OES_texture_float_linear")}drawBuffers(e){this._drawBuffers}drawArraysInstanced(e,t,i,r){}get WebGL2(){return this._isWebGL2}}class di{constructor(){this.clearColor=[1,1,1,1],this.clearDepth=0,this.clearStencil=0,this.viewport=[0,0,800,600],this.colorMask=[!0,!0,!0,!0],this.enableDepth=!0,this.depthFunc=V.LESS,this.depthMask=!0,this.enableStencil=!1,this.stencil=_e.DefStencil,this.enableBlend=!1,this.blend=se.DefBlend,this.enableCullFace=!1,this.cullFaceMode=V.BACK,this.frontFace=V.CCW,this.enableScissor=!1,this.scissor=[0,0,800,600],this.enablePolygonOffset=!1,this.polygonOffset=[0,0]}init(e){e.clearColor.apply(e,this.clearColor),e.colorMask.apply(e,this.colorMask),this.enableDepth?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthFunc(this.depthFunc),e.depthMask(this.depthMask),this.enableBlend?e.enable(e.BLEND):e.disable(e.BLEND);let t=this.blend;e.blendFuncSeparate.apply(e,t.blendFunc),e.blendEquationSeparate.apply(e,t.blendEquation),this.enableStencil?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.clearStencil(this.clearStencil);let i=this.stencil;e.stencilMaskSeparate(e.FRONT,i.stencilMask),e.stencilMaskSeparate(e.BACK,i.stencilBackMask),e.stencilFuncSeparate.apply(e,i.stencilFunc),e.stencilFuncSeparate.apply(e,i.stencilBackFunc),e.stencilOpSeparate.apply(e,i.stencilOp),e.stencilOpSeparate.apply(e,i.stencilBackOp),this.enableCullFace?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.cullFace(this.cullFaceMode),e.frontFace(this.frontFace)}setViewport(e,t){let i=this.viewport;for(let r=0;r<4;r++)if(i[r]!==t[r]){for(e.viewport(t[0],t[1],t[2],t[3]);r<4;r++)i[r]=t[r];return}}setClearColor(e,t){let i=this.clearColor;for(let r=0;r<4;r++)if(i[r]!==t[r]){for(e.clearColor(t[0],t[1],t[2],t[3]);r<4;r++)i[r]=t[r];return}}setClearDepth(e,t){this.clearDepth!==t&&(e.clearDepth(t),this.clearDepth=t)}setClearStencil(e,t){this.clearStencil!==t&&(e.clearStencil(t),this.clearStencil=t)}setColor(e){}setDepth(e,t,i,r=V.LESS){t?(this.enableDepth||(e.enable(e.DEPTH_TEST),this.enableDepth=!0),this.depthMask!==i&&(e.depthMask(i),this.depthMask=i),this.depthFunc!==r&&(e.depthFunc(r),this.depthFunc=r)):this.enableDepth&&(e.disable(e.DEPTH_TEST),this.enableDepth=!1)}setStencil(e,t,i){if(!t)return void(this.enableStencil&&(this.enableStencil=!1,e.disable(e.STENCIL_TEST)));if(this.enableStencil||(e.enable(e.STENCIL_TEST),this.enableStencil=!0),this.stencil===i)return;let r=this.stencil;r.stencilMask!==i.stencilMask&&e.stencilMaskSeparate(e.FRONT,i.stencilMask),r.stencilBackMask!==i.stencilBackMask&&e.stencilMaskSeparate(e.BACK,i.stencilBackMask);let s=i.stencilFunc,n=r.stencilFunc;s[1]===n[1]&&s[2]===n[2]&&s[3]===n[3]||e.stencilFuncSeparate.apply(e,s),s=i.stencilBackFunc,n=r.stencilBackFunc,s[1]===n[1]&&s[2]===n[2]&&s[3]===n[3]||e.stencilFuncSeparate.apply(e,s),s=i.stencilOp,n=r.stencilOp,s[1]===n[1]&&s[2]===n[2]&&s[3]===n[3]||e.stencilOpSeparate.apply(e,s),s=i.stencilBackOp,n=r.stencilBackOp,s[1]===n[1]&&s[2]===n[2]&&s[3]===n[3]||e.stencilOpSeparate.apply(e,s),this.stencil=i}setBlend(e,t,i){if(t!==ae.BLEND)return void(this.enableBlend&&(e.disable(e.BLEND),this.enableBlend=!1));if(this.enableBlend||(e.enable(e.BLEND),this.enableBlend=!0),this.blend===i)return;let r=i.blendFunc,s=i.blendEquation,n=this.blend.blendFunc;for(let t=0;t<4;t++)if(r[t]!==n[t]){e.blendFuncSeparate.apply(e,r);break}let a=this.blend.blendEquation;a[0]===s[0]&&a[1]===s[1]||e.blendEquationSeparate(a[0],a[1]),this.blend=i}setFaceMode(e,t,i){let r=i?V.CW:V.CCW;r!==this.frontFace&&(e.frontFace(r),this.frontFace=r);let s=!!t;s!==this.enableCullFace&&(s?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.enableCullFace=s),t&&t!==this.cullFaceMode&&(e.cullFace(t),this.cullFaceMode=t)}setPolygonOffset(e,t,i){t?(this.enablePolygonOffset||(e.enable(e.POLYGON_OFFSET_FILL),this.enablePolygonOffset=!1),this.polygonOffset[0]===i[0]&&this.polygonOffset[1]===i[1]||(e.polygonOffset(i[0],i[1]),this.polygonOffset[0]=i[0],this.polygonOffset[1]=i[1])):this.enablePolygonOffset&&(e.disable(e.POLYGON_OFFSET_FILL),this.enablePolygonOffset=!1)}}class pi{constructor(){this._planes=[new v,new v,new v,new v,new v,new v]}set(e,t,i,r,s,n){const a=this._planes;for(let e=0;e<6;e++)arguments[e]&&a[e].copy(arguments[e]);return this}setFromMatrix(e){const t=this._planes,i=e.m,r=i[0],s=i[1],n=i[2],a=i[3],o=i[4],g=i[5],A=i[6],I=i[7],C=i[8],h=i[9],_=i[10],l=i[11],u=i[12],c=i[13],d=i[14],p=i[15];return t[0].set(a-r,I-o,l-C,p-u).normalize(),t[1].set(a+r,I+o,l+C,p+u).normalize(),t[2].set(a+s,I+g,l+h,p+c).normalize(),t[3].set(a-s,I-g,l-h,p-c).normalize(),t[4].set(a-n,I-A,l-_,p-d).normalize(),t[5].set(a+n,I+A,l+_,p+d).normalize(),this}intersectBox(e){return!1}intersectSphere(e){const t=this._planes,i=e.pos,r=-e.radius;for(var s=0;s<6;s++){if(t[s].distanceToPoint(i)<r)return!1}return!0}containsPoint(e){const t=this._planes;for(var i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}getPlane(e){return this._planes[e]}copy(e){let t=this._planes,i=e._planes;for(let e=0;e<6;e++)t[e].copy(i[e]);return this}}pi.prototype.intersectBox=function(){const e=new m;return function(t){const i=this._planes,r=t.max,s=t.min;for(let t=0;t<6;t++){let n=i[t],a=n.normal;if(e.x=a.x>0?r.x:s.x,e.y=a.y>0?r.y:s.y,e.z=a.z>0?r.z:s.z,n.distanceToPoint(e)<0)return!1}return!0}}();class mi{}!function(e){e[e.None=0]="None",e[e.Positive=1]="Positive",e[e.Inveried=2]="Inveried"}(ti||(ti={}));class fi{constructor(){this._objPool=new p(mi,32),this.frustum=new pi,this.opacities=new Array(64),this.opacitySize=0,this.noDeferOpacities=new Array(8),this.alphaTests=new Array(16),this.alphaTestSize=0,this.noDeferAlphaTests=new Array(4),this.noDeferAlphaTestSize=0,this.alphaBlends=new Array(16),this.alphaBlendSize=0,this.dirLights=new Array(4),this.dirLightSize=0,this.dirShadowLights=new Array(2),this.dirShadowLightSize=0,this.pointLights=new Array(4),this.pointLightSize=0,this.pointShadowLights=new Array(2),this.pointShadowLightSize=0,this.spotLights=new Array(4),this.spotLightSize=0,this.spotShadowLights=new Array(2),this.spotShadowLightSize=0,this.visibleBox=new k}culling(e,t,i,r){this.frustum.setFromMatrix(t),this.basePlane=this.frustum.getPlane(4),this.opacitySize=this.noDeferOpacitySize=this.alphaTestSize=this.noDeferAlphaTestSize=this.alphaBlendSize=this.dirLightSize=this.dirShadowLightSize=this.pointLightSize=this.pointShadowLightSize=this.spotLightSize=this.spotShadowLightSize=0,this.visibleBox.reset(),this._cutObject3D(e,e.visible,i,r),this._postCulling(this.opacities,this.opacitySize,ti.Positive),this._postCulling(this.noDeferOpacities,this.noDeferOpacitySize,ti.Positive),this._postCulling(this.alphaTests,this.alphaTestSize,ti.Positive),this._postCulling(this.noDeferAlphaTests,this.noDeferAlphaTestSize,ti.Positive),this._postCulling(this.alphaBlends,this.alphaBlendSize,ti.Inveried),this._postCulling(this.dirLights,this.dirLightSize),this._postCulling(this.dirShadowLights,this.dirShadowLightSize),this._postCulling(this.pointLights,this.pointLightSize),this._postCulling(this.pointShadowLights,this.pointShadowLightSize),this._postCulling(this.spotLights,this.spotLightSize),this._postCulling(this.spotShadowLights,this.spotShadowLightSize)}_postCulling(e,t,i=ti.None){this._clearTail(e,t),i===ti.Positive?this._sortObjects(e,!1):i===ti.Inveried&&this._sortObjects(e,!0)}_clearTail(e,t){for(let i=t,r=e.length;i<r&&e[i];i++)this._objPool.recovery(e[i]),e[i].obj=null,e[i]=null}_sortObjects(e,t=!1){t?e.sort((e,t)=>t?e?e.distance-t.distance:1:-1):e.sort((e,t)=>t?e?t.distance-e.distance:1:-1)}_cutObject3D(e,t,i,r){let s=e.visible&&t;e.isMesh&&s?this._cutMesh(e,i,r):e.isLight&&this._cutLight(e);let n=e.getChildren(),a=n.length;for(let e=0;e<a;e++)this._cutObject3D(n[e],s,i,r)}_setObjToArray(e,t,i){let r=e[i];r||(r=this._objPool.create(),e[i]=r),r.obj=t,r.distance=this.basePlane.distanceToPoint(t.getPosition())}_cutMesh(e,t,i){if(!e.beRendering()||i&&!e.castShadow)return;let r=this.visibleBox,s=this.frustum,n=e.getBounding(),a=e.getMaterial();if(n)switch(n.getType()){case H.TYPE_AABB:let e=n.box;if(e){if(!s.intersectBox(e))return;r.expandAtBox(e)}}a.alphaBlend?this._setObjToArray(this.alphaBlends,e,this.alphaBlendSize++):a.alphaTest?t&&!a.supportDeferred?this._setObjToArray(this.noDeferAlphaTests,e,this.noDeferAlphaTestSize++):this._setObjToArray(this.alphaTests,e,this.alphaTestSize++):t&&!a.supportDeferred?this._setObjToArray(this.noDeferOpacities,e,this.noDeferOpacitySize++):this._setObjToArray(this.opacities,e,this.opacitySize++)}_cutLight(e){switch(e.type){case Se.Direction:e.shadow&&e.shadow.enalbed?this._setObjToArray(this.dirShadowLights,e,this.dirShadowLightSize++):this._setObjToArray(this.dirLights,e,this.dirLightSize++);break;case Se.Spot:e.shadow&&e.shadow.enalbed?this._setObjToArray(this.spotShadowLights,e,this.spotShadowLightSize++):this._setObjToArray(this.spotLights,e,this.spotLightSize++);break;case Se.Point:e.shadow&&e.shadow.enalbed?this._setObjToArray(this.pointShadowLights,e,this.pointShadowLightSize++):this._setObjToArray(this.pointLights,e,this.pointLightSize++)}}}class Ti extends ue{constructor(){super(),this._baseColor=new f,this.setProperty(le.baseColor,this._baseColor),this._baseColor.set(1,1,1,1)}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}setBaseColor(e,t,i,r){this._baseColor.set(e,t,i,r)}setRange(e,t){}enablePointShadow(){this._addMacro("POINT_SHADOW")}disablePointShadow(){this._removeMacro("POINT_SHADOW")}get type(){return"depth"}}class Ei extends ai{get type(){return"log_blur"}}class vi{constructor(e){this._shadowMaps=new Map,this._culling=new fi,this._renderer=e,this._material=new Ti,this._camera=new Xe;let t=new Ei;this._blurMat=t,this._pointMat=new Ti,this._pointMat.enablePointShadow();let i=new It,r=new qe;this._blurMesh=r,r.setMaterial(t),r.setGeometry(i);let s=new we;this._blurFrame=s}setSize(e,t){}renderShadow(e,t,i,r){switch(t.type){case Se.Direction:this._directionShadow(e,t,i,r);break;case Se.Point:this._pointShadow(e,t);break;case Se.Spot:this._spotShadow(e,t)}}_getCachedMap(e){let t=this._shadowMaps.get(e);return t||(t=new ie,t.setSize(e,e),t.setDataType(V.UNSIGNED_BYTE),t.setFilter(V.NEAREST,V.NEAREST),this._shadowMaps.set(e,t),t)}_directionShadow(e,t,i,r){let s=this._culling,n=this._camera,a=this._material,o=t.shadow,g=t.dir,A=o.frame,I=i.min,C=i.max,h=m.pool.create(),_=m.pubTemp;h.copy(C).subAt(I).mul(.5).addAt(I);let l=E.pubTemp;_.copy(h).addAt(g),l.lookAt(h,_,m.ZUp);let u=k.pubTemp;u.reset();for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let i=0;i<2;i++)_.set(e?I.x:C.x,t?I.y:C.y,i?I.z:C.z),_.applyMatrix4(l),u.expandAtPoint(_);u.min,u.max;let c=o.range,d=o.far;n.setPositionAt(t.getPosition()),n.lookAt(_.copy(t.getPosition()).subAt(g),m.ZUp),n.enableOrthographicMode(-c,c,-c,c,0,d),n.update(0),o.matrix.copy(n.getViewProjectionMatrix()),s.culling(e,n.getViewProjectionMatrix(),!1,!0);let p=this._renderer;p.useCamera(n),p.useFrame(A),p.directRenderOrderedList(s.opacities,s.opacitySize,a),m.pool.recovery(h);let f=this._blurMat;f.setPixelSize(1/o.size,1/o.size);for(let e=0;e<1;e++)f.setSrcTexture(o.depthTex),f.setPiexlDir(1,0),A=this._blurFrame,A.setTexture2D(ne.COLOR,this._getCachedMap(o.size)),A.setSize(o.size,o.size),p.useFrame(A),this._renderer.directRenderMesh(this._blurMesh),f.setSrcTexture(A.getTextureFromType(ne.COLOR).tex),f.setPiexlDir(0,1),A.setTexture2D(ne.COLOR,o.depthTex),p.useFrame(A),p.directRenderMesh(this._blurMesh)}_spotShadow(e,t){let i=this._culling,r=this._camera,s=this._material,n=t.shadow,a=t.dir,o=n.frame,g=m.pool.create(),A=m.pubTemp,I=t.radius,C=t.radius/2e3;r.setPositionAt(t.getPosition()),r.lookAt(A.copy(t.getPosition()).subAt(a),m.ZUp),r.enablePerspectiveMode(2*t.angle,1,C,I),r.update(0),n.near=C,n.far=I,n.matrix.copy(r.getViewProjectionMatrix()),i.culling(e,r.getViewProjectionMatrix(),!1,!0);let h=this._renderer;h.useCamera(r),h.useFrame(o),h.directRenderOrderedList(i.opacities,i.opacitySize,s),m.pool.recovery(g)}_pointShadow(e,t){let i=this._culling,r=this._camera,s=this._pointMat,n=pe,a=t.shadow,o=a.frames,g=m.pubTemp,A=t.pos,I=t.radius,C=t.radius/2e3,h=this._renderer;a.far=I,r.enablePerspectiveMode(.5*Math.PI,1,C,I);for(let t=0;t<6;t++){let a=o[t],I=n[t];g.copy(A).addAt(I.target),r.setPositionAt(A),r.lookAt(g,I.up),r.update(0),i.culling(e,r.getViewProjectionMatrix(),!1,!0),h.useCamera(r),h.useFrame(a),h.directRenderOrderedList(i.opacities,i.opacitySize,s)}}}class Ri extends ue{constructor(){super(),this._lightType=Se.Direction,this._pixelSize=new d,this.setProperty(le.pixelSize,this._pixelSize),this._lightPos=new m,this.setProperty(le.lightPos,this._lightPos),this.setTexture(le.irradianceMap,me.Black),this.setTexture(le.prefilterMap,me.Black),this.setTexture(le.brdfLUTMap,ie.BrdfLUT)}setDiffuseMap(e){this.setTexture(le.diffuseMap,e)}setNormalMap(e){this.setTexture(le.normalMap,e)}setSpecularMap(e){this.setTexture(le.specularMap,e)}setDepthMap(e){this.setTexture(le.depthMap,e)}setBrdfLUT(e){this.setTexture(le.brdfLUTMap,e)}setPixelSize(e,t){this._pixelSize.set(e,t)}setLightPos(e){this._lightPos.copy(e)}useForDirectionLight(){this._lightType===Se.Point?this._removeMacro("POINT_LIGHT"):this._lightType===Se.Spot&&this._removeMacro("SPOT_LIGHT")}useForPointLight(){this._lightType!==Se.Point&&(this._lightType===Se.Spot&&this._removeMacro("SPOT_LIGHT"),this._addMacro("POINT_LIGHT"))}uesForSpotLight(){this._lightType!==Se.Spot&&(this._lightType===Se.Point&&this._removeMacro("POINT_LIGHT"),this._addMacro("SPOT_LIGHT"))}get type(){return"deferred_shading"}}class Mi{constructor(e){this._renderer=e,this._init()}setSize(e,t){this._gFrame.setSize(e,t),this._notClearDepthState.setViewports(0,0,e,t)}_init(){let e=this._renderer,t=new we;t.setSize(e.getWidth(),e.getHeight()),t.addTexture(ne.RT0,V.RGBA,V.UNSIGNED_BYTE,V.NEAREST,V.NEAREST),t.addTexture(ne.RT1,V.RGBA,V.UNSIGNED_BYTE,V.NEAREST,V.NEAREST),t.addTexture(ne.RT2,V.RGBA,V.UNSIGNED_BYTE,V.NEAREST,V.NEAREST),t.enableDepthStencil(),t.getState().setClearColor(!0,f.Zero),this._gFrame=t;let i=new Ri,r=t.getTextureFromType(ne.RT0).tex;i.setDiffuseMap(r),r=t.getTextureFromType(ne.RT1).tex,i.setNormalMap(r),r=t.getTextureFromType(ne.RT2).tex,i.setDepthMap(r),i.enableStencil=!0,i.setStencilFunc(V.EQUAL,128,128),i.setStencilOp(V.KEEP,V.KEEP,V.KEEP),i.enableDepth=!1,this._deferMat=i;let s=new qe,n=new It;s.setGeometry(n),s.setMaterial(i),this._deferMesh=s,i=new Ri,r=t.getTextureFromType(ne.RT0).tex,i.setDiffuseMap(r),r=t.getTextureFromType(ne.RT1).tex,i.setNormalMap(r),r=t.getTextureFromType(ne.RT2).tex,i.setDepthMap(r),i.useForPointLight(),i.enableStencil=!0,i.setStencil(this._deferMat.stencil),i.enableAlphaBlend(),i.setBlendFunc(V.ONE,V.ONE,V.ONE,V.ONE),i.setBlendEquation(V.FUNC_ADD,V.FUNC_ADD),i.enableDepth=!1,i.setFlipFace(!0),this._pointLightMat=i;let a=new ht(1,32,32);s=new qe,s.setGeometry(a),s.setMaterial(i),this._pointLightMesh=s;let o=e.getDefFrameState(),g=new Fe;g.setClearDepth(!1),g.setClearColor(!0,o.clearColor),g.setClearStencil(!1,o.clearStencil),g.setViewportAt(o.viewport),this._notClearDepthState=g}render(e,t,i){let r=this._renderer,s=this._gFrame,n=1/r.getWidth(),a=1/r.getHeight();r.useCamera(t),r.useFrame(s),r.directRenderOrderedList(e.opacities,e.opacitySize),r.directRenderOrderedList(e.alphaTests,e.alphaTestSize);let o=i.getDepthStencilTexture();i.setDepthStencil(s.getDepthStencilTexture()),s.setDepthStencil(o),this._deferMat.setPixelSize(n,a),r.useCamera(t),r.useFrame(i,this._notClearDepthState),r.directRenderMesh(this._deferMesh);let g=this._pointLightMesh,A=this._pointLightMat;A.setPixelSize(n,a);let I=e.pointLightSize,C=e.pointLights;for(let e=0;e<I;e++){let t=C[e].obj,i=t.radius;A.setLightPos(t.getPosition()),g.setScale(i,i,i),g.setPositionAt(t.getPosition()),g.update(0,!0),vt.lightColor.copy(t.color),r.directRenderMesh(g)}r.directRenderOrderedList(e.noDeferOpacities,e.noDeferOpacitySize),r.directRenderOrderedList(e.noDeferAlphaTests,e.noDeferAlphaTestSize),r.directRenderOrderedList(e.alphaBlends,e.alphaBlendSize)}get gFrame(){return this._gFrame}}class Si{constructor(){this._dirs=new Map,this._points=new Map,this._spots=new Map,this._shadowDirs=new Map,this._shadowPoints=new Map,this._shadowSpots=new Map}_getDir(e,t){let i=t?this._shadowDirs:this._dirs,r=i.get(e);return r||(r={dir:{data:new Float32Array(3*e)},colors:{data:new Float32Array(4*e)}},t&&(r.textures=new Array(e),r.mats={data:new Float32Array(16*e)}),i.set(e,r),r)}_getPoint(e,t){let i=t?this._shadowPoints:this._points,r=i.get(e);return r||(r={pos:{data:new Float32Array(3*e)},colors:{data:new Float32Array(4*e)}},t&&(r.textures=new Array(e),r.ranges={data:new Float32Array(2*e)}),i.set(e,r),r)}_getSpot(e,t){let i=t?this._shadowSpots:this._spots,r=i.get(e);return r||(r={pos:{data:new Float32Array(3*e)},dir:{data:new Float32Array(4*e)},colors:{data:new Float32Array(4*e)}},t&&(r.textures=new Array(e),r.mats={data:new Float32Array(16*e)},r.ranges={data:new Float32Array(4*e)}),i.set(e,r),r)}updateDatasFromCulling(e){let t,i,r,s,n,a,o=this;if(e.dirShadowLightSize>0){let t=e.dirShadowLights,n=o.getShadowDir(e.dirShadowLightSize);i=n.dir.data,r=n.colors.data,s=n.textures,a=n.mats.data;for(let n=0,o=e.dirShadowLightSize;n<o;n++){let e=t[n].obj;i.set(e.dir.v,3*n),r.set(e.color.v,4*n),a.set(e.shadow.matrix.data,16*n),s[n]=e.shadow.depthTex}}if(e.spotShadowLightSize>0){let g=e.spotShadowLights,A=o.getShadowSpot(e.spotShadowLightSize);i=A.dir.data,t=A.pos.data,r=A.colors.data,n=A.ranges.data,a=A.mats.data,s=A.textures;for(let o=0,A=e.spotShadowLightSize;o<A;o++){let e=g[o].obj,A=e.shadow;i.set(e.dir.v,4*o),i[4*o+3]=Math.cos(e.angle),t.set(e.pos.v,3*o),r.set(e.color.v,4*o),a.set(A.matrix.data,16*o),n[4*o]=A.far,n[4*o+1]=1/A.far,n[4*o+2]=n[4*o+3]=1/A.size,s[o]=A.depthTex}}if(e.pointShadowLightSize>0){let i=e.pointShadowLights,a=o.getShadowPoint(e.pointShadowLightSize);t=a.pos.data,r=a.colors.data,n=a.ranges.data,s=a.textures;for(let a=0,o=e.pointShadowLightSize;a<o;a++){let e=i[a].obj,o=e.shadow;t.set(e.pos.v,3*a),r.set(e.color.v,4*a);let g=o.far*Math.sqrt(3);n[2*a]=g,n[2*a+1]=1/g,s[a]=o.depthTex}}let g=e.pointLights,A=e.dirLights,I=e.spotLights,C=o.getDir(e.dirLightSize),h=o.getPoint(e.pointLightSize),_=o.getSpot(e.spotLightSize);i=C.dir.data,r=C.colors.data;for(let t=0,s=e.dirLightSize;t<s;t++){let e=A[t].obj;i.set(e.dir.v,3*t),r.set(e.color.v,4*t)}t=h.pos.data,r=h.colors.data;for(let i=0,s=e.pointLightSize;i<s;i++){let e=g[i].obj;t.set(e.pos.v,3*i),r.set(e.color.v,4*i)}t=_.pos.data,i=_.dir.data,r=_.colors.data;for(let s=0,n=e.spotLightSize;s<n;s++){let e=I[s].obj;t.set(e.pos.v,3*s),i.set(e.dir.v,4*s),i[4*s+3]=Math.cos(e.angle),r.set(e.color.v,4*s)}}getDir(e){return this._getDir(e,!1)}getShadowDir(e){return this._getDir(e,!0)}getPoint(e){return this._getPoint(e,!1)}getShadowPoint(e){return this._getPoint(e,!0)}getSpot(e){return this._getSpot(e,!1)}getShadowSpot(e){return this._getSpot(e,!0)}}class xi extends St{constructor(e){super(e),this._wrapS=e.CLAMP_TO_EDGE,this._wrapT=e.CLAMP_TO_EDGE,this._wrapR=e.CLAMP_TO_EDGE}_applyParameter(e,t,i){e.texParameteri(t,e.TEXTURE_MIN_FILTER,this._minFilter),e.texParameteri(t,e.TEXTURE_MAG_FILTER,this._magFilter),e.texParameteri(t,e.TEXTURE_WRAP_S,this._wrapS),e.texParameteri(t,e.TEXTURE_WRAP_T,this._wrapT),e.texParameteri(t,e.TEXTURE_WRAP_R,this._wrapR),e.TEXTURE_MAX_ANISOTROPY&&e.texParameteri(t,e.TEXTURE_MAX_ANISOTROPY,2),i&&e.generateMipmap(t)}_setTextureData(e,t){let i=t.getFormat(),r=t.getInternalformat(),s=t.getDataType();return e.texImage3D(e.TEXTURE_3D,0,r,t.width,t.height,t.depth,0,i,s,t.data),this}_subTextureData(e,t){}_createTextureDatas(e,t){let i=e.createTexture();if(e.bindTexture(e.TEXTURE_3D,i),void 0!==this._setTextureData(e,t))return i}_applyParameters(e,t){this._applyParameter(e,e.TEXTURE_3D,t)}_createGLTextureFromTexture(e,t){let i=this._createTextureDatas(e,t);if(i)return this.applyUnpackAlignment(e,t),this.setFilter(t.getMinFilter(),t.getMagFilter()),this.setWarp(t.wrapS,t.wrapT,t.wrapR),this._applyParameters(e,t.getMipmap()),i}updateSubData(e,t){}generateFromTexture3D(e,t){let i=this._createGLTextureFromTexture(e,t);if(i)return this._texture=i,this.updated(),e.bindTexture(e.TEXTURE_3D,null),this}_apply(e,t){e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_3D,this._texture)}setWarp(e,t,i){this._wrapS=e,this._wrapT=t,this._wrapR=i}}class Ni extends At{constructor(){super(),this._defFrameState=new Fe,this._screenWidth=-1,this._screenHeight=-1,this._width=-1,this._height=-1,this._scaleW=1,this._scaleH=1,this._renderCount=0,this._deferredRendering=!1,this._renderCulling=new fi,this._lightDatasCache=new Si}init(e,t){this._canvas=yt.createCanvas(),this._initWebGL(),this._initDefFrame(e,t),this._initDefMesh(),this._postEffectPipeline=new ui(this),this._postEffectPipeline.init(this._defGeo),this.setSize(e,t),this._stateCache=new di,this._stateCache.init(this._gl),this._timeNow=Date.now(),this._shaderCache=new Qt(this)}setSize(e,t){const i=this._canvas;i.width=e,i.height=t,this._screenWidth=e,this._screenHeight=t,this._defFrameState.setViewports(0,0,e,t),this._defFrameState.setClearStencil(!0),this._cacheFrames.forEach(i=>{i.setSize(e,t),this.initFrame(i)}),this._defFrame.setSize(e,t),this._postEffectPipeline.resize(e,t),this._deferredPipeling&&this._deferredPipeling.setSize(e,t),this._shadowMapPipeline&&this._shadowMapPipeline.setSize(e,t),this.event(B.RENDERER_RESIZE,[e,t])}_initDefMesh(){let e=new qe,t=new It;this._defGeo=t;let i=new _t;this._defMat=i,e.setGeometry(t),e.setMaterial(i),this._defMesh=e}_initDefFrame(e,t){let i=new we;i.setSize(e,t),i.addTexture(ne.COLOR,V.RGBA,V.HALF_FLOAT,V.NEAREST,V.NEAREST,V.RGBA16F),i.enableDepthStencil(),i.getState().clearColor.set(0,0,0,0),this._defFrame=i;let r=[];for(let i=0;i<2;i++){let i=new we;i.setSize(e,t),i.addTexture(ne.COLOR,V.RGBA,V.UNSIGNED_BYTE,V.NEAREST,V.NEAREST),i.enableDepthStencil(),i.getState().clearColor.set(0,0,0,0),this.initFrame(i),r.push(i)}this._cacheFrames=r,this._frameIndex=0}_initWebGL(){let e=new ci;this._gl=e.initWebGL(this._canvas,!0),this._glSupports=e}enableDepthTest(){this._defFrameState.setClearDepth(!0)}disableDepthTest(){this._defFrameState.setClearDepth(!1)}setViewports(e,t,i,r){this._defFrameState.setViewports(e,t,i,r)}setClearColor(e,t,i,r){this._defFrameState.setClearColor(!0,new f(e,t,i,r))}initGeometry(e){let t=e.getRenderObjectRef(this);return t||(t=new Rt,e.setRenderObjectRef(this,t)),t.getUpdate()?(t.generateFromGeometry(this._gl,e)||(t=null,e.setRenderObjectRef(this,null)),t):t}initTexture(e){let t=this._gl,i=e.getRenderObjectRef(this);if(void 0!==i&&!i.getUpdate())return i.updated(),i;if(0===e.getType()){let i=e;if(i.isUrl){if(!i.loaded)return this.initTexture(i._def);let e=xt.ImageTexMap,r=i.getImage(),s=e.get(r);if(s)return i.setRenderObjectRef(this,s),s;if(s=new xt(t),s.generateFromTexture2D(t,i))return i.setRenderObjectRef(this,s),e.set(r,s),s}else if(i.getWidth()>0&&i.getHeight()>0){let e=i.getRenderObjectRef(this);if(e&&!e.isUrl||(e=new xt(t)),e.generateFromTexture2D(t,i))return i.setRenderObjectRef(this,e),e}}else if(1===e.getType()){let i=e,r=new Nt(t);if(r.generateFromTextureCube(t,i))return i.setRenderObjectRef(this,r),r}else if(3===e.getType()){let r=e,s=i||new xi(t);if(s.generateFromTexture3D(t,r))return r.setRenderObjectRef(this,s),s}return null}initFrame(e){let t=e.getRenderObjectRef(this);return t||(t=new Mt,e.setRenderObjectRef(this,t)),t.getUpdate()?(t.generateFromFrame(this._gl,this,e)||(t=null,e.setRenderObjectRef(this,null)),t):t}initMaterial(e){let t=this._shaderCache.genShaderProgram(e,this._deferredRendering);return t||null}retainMesh(e,t){let i=this._gl;if(!this.initGeometry(e.getGeometry()))return!1;let r=t||e.getMaterial(),s=this.initMaterial(r);if(!s)return!1;const n=new Map;return s.getTextures().forEach((e,t)=>{let i=r.getTexture(t);if(!i)return;let s=this.initTexture(i);s&&n.set(e,s)}),n.forEach((e,t)=>{e.apply(i,t)}),!0}releaseMesh(e){let t=e.getMaterial();t&&this._shaderCache.releaseMaterial(t)}useFrameState(e){const t=this._gl;let i=this._stateCache,r=0;i.setViewport(t,e.viewport.v),e.needClear&&(e.isClearColor&&(r|=t.COLOR_BUFFER_BIT,i.setClearColor(t,e.clearColor.v)),e.isClearDepth,e.isClearDepth&&(r|=t.DEPTH_BUFFER_BIT,i.setClearDepth(t,e.clearDepth)),e.isClearStencil&&(r|=t.STENCIL_BUFFER_BIT,i.setClearStencil(t,e.clearStencil)),0!==r&&t.clear(r))}useFrame(e,t){const i=this._gl;if(!e)return i.bindFramebuffer(i.FRAMEBUFFER,null),this.useFrameState(this._defFrameState),void(this._curFrame=null);let r=this.initFrame(e);r&&(r.apply(i,this._glSupports),this.useFrameState(t||e.getState()),this._curFrame=e)}_renderMesh(e,t,i,r){let s=this._gl,n=t||e.getMaterial();if(i){if(i.d>0){let e=this._lightDatasCache.getShadowDir(i.d);n.setDirShadowLights(i.d,e.dir,e.colors,e.mats,e.textures)}else n.setDirShadowLights(0,null,null,null,null);if(i.s>0){let e=this._lightDatasCache.getShadowSpot(i.s);n.setSpotShadowLights(i.s,e.pos,e.dir,e.colors,e.ranges,e.mats,e.textures)}else n.setSpotShadowLights(0,null,null,null,null,null,null);if(i.p>0){let e=this._lightDatasCache.getShadowPoint(i.p);n.setPointShadowLights(i.p,e.pos,e.colors,e.ranges,e.textures)}else n.setPointShadowLights(0,null,null,null,null)}else n.setDirShadowLights(0,null,null,null,null),n.setSpotShadowLights(0,null,null,null,null,null,null),n.setPointShadowLights(0,null,null,null,null);if(r){let e=this._lightDatasCache.getDir(r.d);n.setDirLights(r.d,e.dir,e.colors);let t=this._lightDatasCache.getPoint(r.p);n.setPointLights(r.p,t.pos,t.colors);let i=this._lightDatasCache.getSpot(r.s);n.setSpotLights(r.s,i.pos,i.dir,i.colors)}if(!this.retainMesh(e,t))return;let a=e.getGeometry(),o=a.getRenderObjectRef(this);this._useMaterialState(n);let g=n.shader.getRenderObjectRef(this);g.apply(s),o.bindVbo(s,g,a),g.applyUniforms(s,e,this._curCamera),o.draw(s)}_renderDefScene(e,t){}_renderScene2Frame(e,t,i){}useCamera(e){e&&(vt.vMatrix.copy(e.getViewMatrix()),vt.pMatrix.copy(e.getProjectionMatrix()),vt.vpMatrix.copy(e.getViewProjectionMatrix()),vt.vIMatrix.copy(e.getViewInverseMatrix()),vt.pIMatrix.copy(e.getProjectionInverseMatrix()),vt.vpIMatrix.getInvert(vt.vpMatrix),this._curCamera=e)}_useMaterialState(e){let t=this._gl,i=this._stateCache;i.setBlend(t,e.alphaType,e.blend),i.setFaceMode(t,e.faceMode,e.filpFace),i.setStencil(t,e.enableStencil,e.stencil),i.setDepth(t,e.enableDepth,e.depthMask,e.depthFunc),i.setPolygonOffset(t,e.enablePolygonOffset,e.polygonOffset)}_renderShadow(e,t,i,r){let s=this._shadowMapPipeline;s||(s=new vi(this),this._shadowMapPipeline=s),s.renderShadow(e,t,i,r)}directRenderList(e,t,i){this._renderList(e,t,i)}directRenderOrderedList(e,t,i){this._renderOrderedList(e,t,i)}directRenderMesh(e,t){this._renderMesh(e,t,null)}_renderOrderedList(e,t,i,r,s){for(let n=0;n<t;n++)this._renderMesh(e[n].obj,i,r,s)}_renderList(e,t,i,r,s){for(let n=0;n<t;n++)this._renderMesh(e[n],i,r,s)}_renderShadows(e,t){let i=this._renderCulling;for(let r=0,s=i.dirShadowLightSize;r<s;r++){let s=i.dirShadowLights[r];this._renderShadow(e,s.obj,i.visibleBox,t)}for(let r=0,s=i.spotShadowLightSize;r<s;r++){let s=i.spotShadowLights[r];this._renderShadow(e,s.obj,i.visibleBox,t)}for(let r=0,s=i.pointShadowLightSize;r<s;r++){let s=i.pointShadowLights[r];this._renderShadow(e,s.obj,i.visibleBox,t)}}renderScene(e,t,i,r){if(!i){let e=Date.now();this._deltaTime=e-this._timeNow,this._timeNow=e,this._defCamera=t,St.clear()}if(e.isScene){let t=e.getMainLight();vt.lightDir.copy(t.dir),vt.lightColor.copy(t.color)}let s,n=this._renderCulling;if(this.useCamera(t),r&&r.frustumCamera?s=r.frustumCamera.getViewProjectionMatrix():t&&(s=t.getViewProjectionMatrix()),i)this.useFrame(i),this.useCamera(t),n.culling(e,s,!0,!1),this._renderOrderedList(n.opacities,n.opacitySize),this._renderOrderedList(n.alphaTests,n.alphaTestSize),this._renderOrderedList(n.alphaBlends,n.alphaBlendSize);else{if(n.culling(e,s,this._deferredRendering,!1),this._renderShadows(e,t),this._lightDatasCache.updateDatasFromCulling(n),this._deferredRendering)this._deferredPipeling.render(n,t,this._defFrame);else{this.useCamera(this._defCamera),this.useFrame(this._defFrame,this._defFrameState);let e={d:n.dirShadowLightSize,p:n.pointShadowLightSize,s:n.spotShadowLightSize},t={d:n.dirLightSize,p:n.pointLightSize,s:n.spotLightSize};this._renderOrderedList(n.opacities,n.opacitySize,null,e,t),this._renderOrderedList(n.alphaTests,n.alphaTestSize,null,e,t),this._renderOrderedList(n.alphaBlends,n.alphaBlendSize,null,e,t)}let i;this.useCamera(this._defCamera),this._postEffectPipeline.length>0?(this.renderPostEffects(),i=this._postEffectPipeline.currentFrame):i=this._defFrame,this.useFrame(null),this._defMat.setDiffuseMap(i.getTextureFromType(ne.COLOR).tex),this._renderMesh(this._defMesh),this.exchangeFrame()}}renderPostEffects(){this._postEffectPipeline.render(this._defFrame,this._deferredRendering)}getCanvas(){return this._canvas}getContext(){return this._gl}getRendererId(){return this.rendererId}getWidth(){return this._screenWidth}getHeight(){return this._screenHeight}exchangeFrame(){this._frameIndex=(this._frameIndex+1)%this._cacheFrames.length}get currectFrame(){return this._cacheFrames[this._frameIndex]}get lastFrame(){return this._cacheFrames[(this._frameIndex+1)%this._cacheFrames.length]}get deltaTime(){return this._deltaTime}get defCamera(){return this._defCamera}updateDefFrame(){this._postEffectPipeline.getSrcReqs()}disablePostEffect(e){this._postEffectPipeline.disablePostEffect(e),this.updateDefFrame()}enablePostEffect(e){this._postEffectPipeline.enablePostEffect(e),this.updateDefFrame()}getEnablingPostEffect(){return this._postEffectPipeline.getEnablingPostEffect()}getGBufferFrame(){return this._deferredRendering?this._deferredPipeling.gFrame:null}_swtichDeferredRendering(e){this._deferredRendering!==e&&(e&&(this._deferredPipeling||(this._deferredPipeling=new Mi(this))),this._deferredRendering=e)}enableDeferredRendering(){this._swtichDeferredRendering(!0)}disableDeferredRendering(){this._swtichDeferredRendering(!1)}get isEnableDeferredRender(){return this._deferredRendering}removeShader(e){let t=e;this._shaderCache.removeShader(t)}getDefFrameState(){return this._defFrameState}get isWebGL2(){return this._glSupports.WebGL2}}class yi{constructor(e,t){this.x=e,this.y=t}set(e,t){}}class Oi extends Me{constructor(){super(),this._=new Float32Array(4),this._isThrough=!1,this.mouseEnable=!0}_update(){this._needsUpdate&&(this._needsUpdate=!1)}needsUpdate(){this._needsUpdate=!0}setSize(e,t){this._[0]=e,this._[1]=t,this.needsUpdate()}set width(e){this._[0]=e}get width(){return this._[0]}set height(e){this._[1]=e}get height(){return this._[1]}set rotate(e){this._[2]=e}get rotate(){return this._[2]=0}set mouseEnable(e){this._[3]=e?1:0}get mouseEnable(){return 0!==this._[3]}getRectData(){return[this.x,this.y,this.width,this.height]}getStageData(){let e=this.getRectData(),t=this._matrix,i=e[0],r=e[1],s=i+e[2],n=r+e[3],a=[[i,r],[i,n],[s,n],[s,r]],o=[],g=new m;for(let e=0;e<4;e++){let i=a[e];g.set(i[0],i[1],0),g.applyMatrix4(t),o.push(g.x,g.y)}return o}isRender(){return!1}getUIData(){return""}getIsFont(){return!1}checkPick(e,t){let i=this._parent?this._parent.getMatrix():E.unitMat4,r=E.pubTemp.copy(this._matrix).multiply(i);r.invert();let s=new m(e,t,0);s.applyMatrix4(r);let n=this.getRectData(),a=0+n[2],o=0+n[3];return s.x>=0&&s.x<=a&&s.y>=0&&s.y<=o}checkChildPick(e,t,i){if(!this.checkPick(e,t)||!this.mouseEnable)return!1;i.path.push(this);let r=this._children,s=r.length;for(let n=0;n<s;n++){if(r[n].checkChildPick(e,t,i))return!0}return this.event(i.type,[i]),!(this._isThrough&&!i.stopPropagation)||void 0}screenPointToLocal(e){let t=this._parent?this._parent.getMatrix():E.unitMat4,i=E.pubTemp.copy(this._matrix).applyMatrix4(t);i.invert();let r=new m(e.x,e.y,0);return r.applyMatrix4(i),new yi(r.x,r.y)}globalEvent(e,t){let i=this._children,r=i.length;for(let s=0;s<r;s++)i[s].globalEvent(e,t);this.event(e,[t])}}class Di extends Oi{constructor(){super(),this._data=new Float32Array(65535),this._indices=new Uint16Array(131070),this._isThrough=!0}createRenderMesh(){let e={data:this._data,indices:this._indices,dataCount:0,indexCount:0,result:[]};return this._createRenderMesh(this,e),e}_createRenderMesh(e,t){if(e.isRender()){e.getStageData()}let i=e.getChildren(),r=i.length;for(let e=0;e<r;e++){let r=i[e];this._createRenderMesh(r,t)}}}class Fi extends _{constructor(){super(),this.slow=!1,this._stop=!1,this._frameCount=0,this._frameId=-1,this._cacheUIs=[],this._preClickUIs=[]}init(e,t){this._timer=new G,this._stage=new Di,this._stage.setSize(e,t),this._scene=new Je,this._obj3d=new Me,this._obj3d.addChild(this._scene),this._camera=new Xe(e,t),this._renderer=new Ni,this._renderer.init(e,t),this._listenersMap=new Map,this._addEventListeners(),this._loopBindThis=this._loop.bind(this)}setSize(e,t){this._camera.resize(e,t),this._stage.setSize(e,t),this._renderer.setSize(e,t),this._render()}start(){this._stop=!1,this._startLoop()}stop(){this._stop=!0,yt.cancelAnimationFrame(this._frameId)}_startLoop(){this._lastTime=yt.now(),this._loop()}_loop(){if(this._stop)return;if(this._frameId=yt.requestAnimationFrame(this._loopBindThis),this._frameCount++,this.slow&&this._frameCount%2==1)return;let e=yt.now(),t=e-this._lastTime;this._lastTime=e,this._update(t),this._render()}_update(e){this._timer.preUpdate(e),this._scene.update(e),this._stage.update(e),this._camera.update(e),this._timer.lateUpdate(e)}_render(){this._renderer.renderScene(this._scene,this._scene.getActiveCamera()||this._camera)}_addEventListener(e,t){let i,r=this._renderer.getCanvas(),s=yt.document();e.indexOf("key")>-1?(i=s,s.addEventListener(e,t)):(i=r,r.addEventListener(e,t)),this._listenersMap.set(e,{target:i,func:t})}_addEventListeners(){this._addEventListener("mousedown",this._onMouseEvent.bind(this)),this._addEventListener("mousemove",this._onMouseEvent.bind(this)),this._addEventListener("mouseup",this._onMouseEvent.bind(this)),this._addEventListener("mouseover",this._onMouseEvent.bind(this)),this._addEventListener("mouseout",this._onMouseEvent.bind(this)),this._addEventListener("touchstart",this._onTouchStart.bind(this)),this._addEventListener("touchmove",this._onTouchMove.bind(this)),this._addEventListener("touchend",this._onTouchEnd.bind(this)),this._addEventListener("touchcancel",this._onTouchCancel.bind(this)),this._addEventListener("keydown",this._onKeyboardEvent.bind(this)),this._addEventListener("keypress",this._onKeyboardEvent.bind(this)),this._addEventListener("keyup",this._onKeyboardEvent.bind(this));let e=this._onBlur.bind(this);window.addEventListener("blur",e),this._listenersMap.set("blur",{target:window,func:e})}_removeEventListeners(){this._listenersMap.forEach((e,t)=>{e.target.removeEventListener(t,e.func)}),this._listenersMap.clear()}_onBlur(){this._globalEvent(B.ON_BLUR)}_globalEvent(e,t){this._stage.globalEvent(e,t)}_onMouseEvent(e){let t=new B(e);this._checkStagePick(t),this._postMouseEvent(t)}_onTouchStart(e){}_onTouchMove(e){}_onTouchEnd(e){}_onTouchCancel(e){}_onKeyboardEvent(e){let t=new B(e);this._cacheUIs.forEach(i=>{let r=B.TypeMap[e.type];i.event(r,[t])})}_postMouseEvent(e){let t=e.type,i=e.path,r=this._cacheUIs;e.type=B.MOUSE_OUT,r.forEach(t=>{i.indexOf(t)<0&&t.event(B.MOUSE_OUT,[e])}),e.type=B.MOUSE_OVER;let s=[];if(i.forEach(t=>{r.indexOf(t)<0&&t.event(B.MOUSE_OVER,[e]),s.push(t)}),this._cacheUIs=s,t===B.MOUSE_DOWN){let e=[];i.forEach(t=>{e.push(t)}),this._preClickUIs=e}else{let e=this._preClickUIs,t=[];e.forEach(e=>{i.indexOf(e)>-1&&t.push(e)}),this._preClickUIs=t}if(e.type=B.CLICK,t===B.MOUSE_UP){this._preClickUIs.forEach(t=>{t.event(B.CLICK,[e])}),this._preClickUIs=[]}e.type=t}_checkStagePick(e){let t=this._stage,i=e.stageX,r=e.stageY;t.checkChildPick(i,r,e)}getRenderer(){return this._renderer}getScene(){return this._scene}getStage(){return this._stage}getTimer(){return this._timer}getCamera(){return this._camera}destroy(){this._removeEventListeners()}}class wi{constructor(e){this.time=e}}class bi extends wi{constructor(e,t){super(e),this.vector=new m,this.vector.copy(t)}}class Li extends l{constructor(e,t=30,i=!1){super(),this._loop=!1,this._currentTime=0,this._maxTime=0,this.name=e,this._fps=t,this._loop=i}addFrame(e){}removeFrame(e){}applyTime(e,t){}}class Pi extends Li{constructor(e,t=30,i=!1){super(e,t,i),this._frames=[]}addVectorByFrame(e,t){let i=e*this._fps;this.addVector(i,t)}addVector(e,t){let i=new bi(e,t);this.addFrame(i),this._maxTime=Math.max(e,this._maxTime)}addFrame(e){this._frames.push(e)}removeFrame(e){const t=this._frames.indexOf(e);t>=0&&this._frames.splice(t,1)}removeFrameFromTime(e){const t=this._frames;for(let i=0,r=t.length;i<r;i++)if(t[i].time===e){this._frames.splice(i,1);break}}sortTime(){this._frames.sort((e,t)=>e.time-t.time)}applyTime(e,t){const i=this._frames;if(0===i.length||!t)return;let r=e/this._maxTime;r-=Math.floor(r),r*=this._maxTime;let s=0;for(let e=i.length;s<e&&!(i[s].time>=r);s++);if(0===s)t.setPositionAt(i[s].vector);else{const e=i[s-1],n=i[s];let a=n.time-e.time,o=r-e.time;t.getPosition().lerp(e.vector,n.vector,o/a),t.enableUpdateMat()}}}class Ui extends l{constructor(e){super(),this._tracks=new Set,this._currectTime=0,this.name=e}addTrack(e){this._tracks.add(e)}reset(){this._currectTime=0}setTime(e){this._currectTime=e}updateTIme(e,t){this._currectTime+=e,this._tracks.forEach(e=>{e.applyTime(this._currectTime,t)})}}class Bi extends l{constructor(e){super(),this._animaterClips=new Map,this._target=e}addAnimationClip(e){this._animaterClips.set(e.name,e)}removeAnimationClip(e){this._animaterClips.delete(e.name)}play(e){const t=this._animaterClips.get(e);t&&(this._currectClip=t)}stop(){this._currectClip=null}update(e){this._currectClip&&this._currectClip.updateTIme(e,this._target)}}i.d(t,"generateUUID",(function(){return u})),i.d(t,"GLMAT_EPSILON",(function(){return 1e-6})),i.d(t,"USE_MULTI_RENDERER",(function(){return!1})),i.d(t,"Logger",(function(){return c})),i.d(t,"VERSION",(function(){return"05"})),i.d(t,"GetTypeCount",(function(){return A})),i.d(t,"GetObjectCount",(function(){return I})),i.d(t,"init",(function(){return C})),i.d(t,"Vector2",(function(){return d})),i.d(t,"Vector3",(function(){return m})),i.d(t,"Vector4",(function(){return f})),i.d(t,"Quaternion",(function(){return T})),i.d(t,"Matrix4",(function(){return E})),i.d(t,"Plane",(function(){return v})),i.d(t,"Ray",(function(){return R})),i.d(t,"Transform",(function(){return M})),i.d(t,"Triangle",(function(){return U})),i.d(t,"Base",(function(){return l})),i.d(t,"Event",(function(){return B})),i.d(t,"EventDispatcher",(function(){return _})),i.d(t,"Timer",(function(){return G})),i.d(t,"Bounding",(function(){return W})),i.d(t,"AABB",(function(){return X})),i.d(t,"OBB",(function(){return Y})),i.d(t,"SphereBounding",(function(){return Z})),i.d(t,"Material",(function(){return ue})),i.d(t,"DiffuseMaterial",(function(){return ce})),i.d(t,"ColorMaterial",(function(){return de})),i.d(t,"StandardMaterial",(function(){return fe})),i.d(t,"CartoonMaterial",(function(){return Te})),i.d(t,"SkyboxMaterial",(function(){return Ee})),i.d(t,"ReferMaterial",(function(){return ve})),i.d(t,"Texture3DTestMaterial",(function(){return Re})),i.d(t,"Light",(function(){return Oe})),i.d(t,"DirectionLight",(function(){return Le})),i.d(t,"PointLight",(function(){return Ue})),i.d(t,"SpotLight",(function(){return ze})),i.d(t,"RTLocation",(function(){return ne})),i.d(t,"AlphaType",(function(){return ae})),i.d(t,"FaceType",(function(){return oe})),i.d(t,"TextureFormat",(function(){return ge})),i.d(t,"DataType",(function(){return Ae})),i.d(t,"DrawMode",(function(){return Ie})),i.d(t,"BlendType",(function(){return Ce})),i.d(t,"BLendFunc",(function(){return he})),i.d(t,"GraphicsType",(function(){return V})),i.d(t,"Geometry",(function(){return Ve})),i.d(t,"Shader",(function(){return re})),i.d(t,"Texture2D",(function(){return ie})),i.d(t,"TextureCube",(function(){return me})),i.d(t,"Texture3D",(function(){return We})),i.d(t,"Frame",(function(){return we})),i.d(t,"FrameState",(function(){return Fe})),i.d(t,"ShaderConst",(function(){return le})),i.d(t,"Object3D",(function(){return Me})),i.d(t,"Camera",(function(){return Xe})),i.d(t,"Component",(function(){return Ze})),i.d(t,"Entity",(function(){return Ke})),i.d(t,"Mesh",(function(){return qe})),i.d(t,"ComponentType",(function(){return je})),i.d(t,"LineSegments",(function(){return Qe})),i.d(t,"Scene",(function(){return Je})),i.d(t,"ColladaLoader",(function(){return $e})),i.d(t,"GltfLoader",(function(){return tt})),i.d(t,"OBJLoader",(function(){return it})),i.d(t,"ThirdPersonControl",(function(){return rt})),i.d(t,"FirstPersonControl",(function(){return at})),i.d(t,"Loader",(function(){return J})),i.d(t,"calcTangent",(function(){return $})),i.d(t,"Raycaster",(function(){return gt})),i.d(t,"triangleIntersect",(function(){return P})),i.d(t,"Renderer",(function(){return At})),i.d(t,"WebGLRenderer",(function(){return Ni})),i.d(t,"PEType",(function(){return Jt})),i.d(t,"PEBase",(function(){return ii})),i.d(t,"FXAA",(function(){return si})),i.d(t,"Application",(function(){return Fi})),i.d(t,"FrameBase",(function(){return wi})),i.d(t,"VectorFrame",(function(){return bi})),i.d(t,"TrackBase",(function(){return Li})),i.d(t,"VectorTrack",(function(){return Pi})),i.d(t,"AnimationClip",(function(){return Ui})),i.d(t,"Animater",(function(){return Bi})),i.d(t,"Platform",(function(){return yt})),i.d(t,"Sprite",(function(){return Oi})),i.d(t,"SphereGeometry",(function(){return ht})),i.d(t,"BoxGeometry",(function(){return Ct}))}]);